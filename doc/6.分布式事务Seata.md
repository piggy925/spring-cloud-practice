## å¾®æœåŠ¡ç»„ä»¶ - Seata

### 1.ã€Œ èƒŒæ™¯ä»‹ç» ã€

#### 1.1 åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å­˜åœ¨çš„äº‹åŠ¡é—®é¢˜

åœ¨ä»¥å‰ä½¿ç”¨çš„éåˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬çš„åº”ç”¨éƒ½åªéœ€è¦æ“ä½œå•ä¸€çš„æ•°æ®åº“ï¼Œè¿™ç§æƒ…å†µä¸‹çš„äº‹åŠ¡ç§°ä¹‹ä¸ºæœ¬åœ°äº‹åŠ¡ã€‚æœ¬åœ°äº‹åŠ¡çš„ ACID ç‰¹æ€§æ˜¯æ•°æ®åº“ç›´æ¥æä¾›æ”¯æŒã€‚ä¾‹å¦‚ï¼Œåœ¨ JDBC ç¼–ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ `java.sql.Connection` å¯¹è±¡æ¥å¼€å¯ã€å…³é—­æˆ–è€…æäº¤äº‹åŠ¡ã€‚

å½“ä¸‹ç»å¤§éƒ¨åˆ†å…¬å¸éƒ½è¿›è¡Œäº†æ•°æ®åº“æ‹†åˆ†å’ŒæœåŠ¡åŒ–ï¼ˆSOAï¼‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ŒæˆæŸä¸€ä¸ªä¸šåŠ¡åŠŸèƒ½å¯èƒ½éœ€è¦æ¨ªè·¨å¤šä¸ªæœåŠ¡ï¼Œæ“ä½œå¤šä¸ªæ•°æ®åº“ã€‚è¿™å°±æ¶‰åŠåˆ°åˆ°äº†åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œéœ€è¦æ“ä½œçš„èµ„æºä½äºå¤šä¸ªèµ„æºæœåŠ¡å™¨ä¸Šï¼Œè€Œåº”ç”¨éœ€è¦ä¿è¯å¯¹äºå¤šä¸ªèµ„æºæœåŠ¡å™¨çš„æ•°æ®çš„æ“ä½œï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚æœ¬è´¨ä¸Šæ¥è¯´ï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±æ˜¯ä¸ºäº†**ä¿è¯ä¸åŒèµ„æºæœåŠ¡å™¨çš„æ•°æ®ä¸€è‡´æ€§**ã€‚

#### 1.2 å…¸å‹çš„åˆ†å¸ƒå¼äº‹åŠ¡åœºæ™¯

1. è·¨åº“äº‹åŠ¡

è·¨åº“äº‹åŠ¡æŒ‡çš„æ˜¯ï¼Œä¸€ä¸ªåº”ç”¨æŸä¸ªåŠŸèƒ½éœ€è¦æ“ä½œå¤šä¸ªåº“ï¼Œä¸åŒçš„åº“ä¸­å­˜å‚¨ä¸åŒçš„ä¸šåŠ¡æ•°æ®ã€‚

![image-20220503090426561](https://blog.caowei.xyz/blog/202205030904675.png)

2. åˆ†åº“åˆ†è¡¨

é€šå¸¸ä¸€ä¸ªåº“æ•°æ®é‡æ¯”è¾ƒå¤§æˆ–è€…é¢„æœŸæœªæ¥çš„æ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œéƒ½ä¼šè¿›è¡Œæ°´å¹³æ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯åˆ†åº“åˆ†è¡¨ã€‚

![image-20220503090455817](https://blog.caowei.xyz/blog/202205030904848.png)

3. æœåŠ¡åŒ–

å¾®æœåŠ¡æ¶æ„æ˜¯ç›®å‰ä¸€ä¸ªæ¯”è¾ƒä¸€ä¸ªæ¯”è¾ƒç«çš„æ¦‚å¿µã€‚åº”ç”¨è¢«æ‹†åˆ†æˆä¸åŒçš„ç‹¬ç«‹çš„æœåŠ¡åå¯ä»¥ç®€åŒ–ä¸šåŠ¡é€»è¾‘ï¼Œæ‹†åˆ†åï¼Œç‹¬ç«‹æœåŠ¡ä¹‹é—´é€šè¿‡ RPC æ¡†æ¶æ¥è¿›è¡Œè¿œç¨‹è°ƒç”¨ï¼Œå®ç°å½¼æ­¤çš„é€šä¿¡ã€‚ä¸‹å›¾æ¼”ç¤ºäº†ä¸€ä¸ª 3 ä¸ªæœåŠ¡ä¹‹é—´å½¼æ­¤è°ƒç”¨çš„æ¶æ„ï¼š

![image-20220503090552827](https://blog.caowei.xyz/blog/202205030905877.png)

#### 1.3 å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆ

å¸¸è§åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰ä»¥ä¸‹å››ç§ï¼š

+ Seata é˜¿é‡Œåˆ†å¸ƒå¼äº‹åŠ¡æ¡†æ¶
+ æ¶ˆæ¯é˜Ÿåˆ—
+ Saga
+ XA 

å®é™…ä¸Šï¼Œè¿™å››ç§å¸¸è§çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œåˆ†åˆ«å¯¹åº”ç€åˆ†å¸ƒå¼äº‹åŠ¡çš„å››ç§æ¨¡å¼ï¼šATã€TCCã€Sagaã€XAã€‚ å››ç§åˆ†å¸ƒå¼äº‹åŠ¡æ¨¡å¼ï¼Œéƒ½æœ‰å„è‡ªçš„ç†è®ºåŸºç¡€ï¼Œåˆ†åˆ«åœ¨ä¸åŒçš„æ—¶é—´è¢«æå‡ºï¼Œæ¯ç§æ¨¡å¼éƒ½æœ‰å®ƒçš„é€‚ç”¨åœºæ™¯ï¼ŒåŒæ ·æ¯ä¸ªæ¨¡å¼ä¹Ÿéƒ½è¯ç”Ÿæœ‰å„è‡ªçš„ä»£è¡¨äº§å“;è€Œè¿™äº›ä»£è¡¨äº§å“ï¼Œå¯èƒ½å°±æ˜¯æˆ‘ä»¬å¸¸è§çš„ï¼ˆå…¨å±€äº‹åŠ¡ã€ åŸºäºå¯é æ¶ˆæ¯ã€æœ€å¤§åŠªåŠ›é€šçŸ¥ã€TCCï¼‰ã€‚ ä»Šå¤©ï¼Œæˆ‘ä»¬ä¼šåˆ†åˆ«æ¥çœ‹4ç§æ¨¡å¼ï¼ˆATã€TCCã€Sagaã€XAï¼‰çš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°ã€‚

å®ƒä»¬æœ‰ä¸€ä¸ªå…±åŒç‚¹ï¼Œéƒ½æ˜¯**ä¸¤é˜¶æ®µï¼ˆ2PCï¼‰**ã€‚**ä¸¤é˜¶æ®µ**æ˜¯æŒ‡å®Œæˆæ•´ä¸ªåˆ†å¸ƒå¼äº‹åŠ¡ï¼Œåˆ’åˆ†æˆä¸¤ä¸ªæ­¥éª¤å®Œæˆã€‚

#### 1.4 2PC ä¸¤é˜¶æ®µæäº¤åè®®

é¡¾åæ€ä¹‰ï¼Œ2PC åè®®åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šPrepare ä¸ Commitã€‚æ•´ä½“æµç¨‹å›¾å¦‚ä¸‹ï¼š

![](https://blog.caowei.xyz/blog/202205031128965.jpg)

1. Prepare é¢„å¤„ç†é˜¶æ®µ

+ è¯¢é—®ï¼šåè°ƒè€…ï¼ˆäº‹åŠ¡ç®¡ç†å™¨ï¼‰å‘æ‰€æœ‰å‚ä¸è€…ï¼ˆäº‹åŠ¡æ‰§è¡Œè€…ï¼‰å‘é€äº‹åŠ¡è¯·æ±‚ï¼Œè¯¢é—®èƒ½å¦æ‰§è¡Œäº‹åŠ¡æ“ä½œï¼Œç„¶åç­‰å¾…å‚ä¸è€…çš„å“åº”ã€‚

+ æ‰§è¡Œï¼šå„ä¸ªå‚ä¸è€…æ¥æ”¶åˆ°åè°ƒè€…äº‹åŠ¡è¯·æ±‚åï¼Œæ‰§è¡Œäº‹åŠ¡æ“ä½œï¼ˆä¾‹å¦‚åœ¨æ•°æ®åº“ä¸­æ’å…¥æ•°æ®ï¼‰ï¼Œå¹¶å°† Undo å’Œ Redo ä¿¡æ¯è®°å½•äº‹åŠ¡æ—¥å¿—ä¸­ã€‚

+ å“åº”ï¼šå¦‚æœå‚ä¸è€…æˆåŠŸæ‰§è¡Œäº†äº‹åŠ¡å¹¶å†™å…¥ Undo å’Œ Redo ä¿¡æ¯ï¼Œåˆ™å‘åè°ƒè€…è¿”å› YES å“åº”ï¼Œå¦åˆ™è¿”å› NO å“åº”ã€‚

  å‚ä¸è€…ä¹Ÿå¯èƒ½å®•æœºå¯¼è‡´ä¸ä¼šè¿”å›å“åº”ã€‚

2. Commit æäº¤/å›é€€é˜¶æ®µ

Commit é˜¶æ®µåˆ†ä¸ºæ­£å¸¸æäº¤äº‹åŠ¡ä¸å›é€€ä¸¤ç§æƒ…å†µã€‚

æ­£å¸¸æäº¤äº‹åŠ¡ï¼š

+ Commitè¯·æ±‚ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ Commit è¯·æ±‚ã€‚
+ äº‹åŠ¡æäº¤ï¼šå‚ä¸è€…æ”¶åˆ° Commit è¯·æ±‚åï¼Œæ‰§è¡Œäº‹åŠ¡æäº¤ï¼Œæäº¤å®Œæˆåé‡Šæ”¾äº‹åŠ¡æ‰§è¡ŒæœŸå ç”¨çš„æ‰€æœ‰èµ„æºã€‚
+ åé¦ˆç»“æœï¼šå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡æäº¤åå‘åè°ƒè€…å‘é€ Ack å“åº”ã€‚
+ å®Œæˆäº‹åŠ¡ï¼šæ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ Ack å“åº”åï¼Œå®Œæˆäº‹åŠ¡æäº¤ã€‚

å›é€€ï¼š

*åœ¨æ‰§è¡Œ Prepare æ­¥éª¤è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæŸäº›å‚ä¸è€…æ‰§è¡Œäº‹åŠ¡å¤±è´¥ã€å®•æœºæˆ–ä¸åè°ƒè€…ä¹‹é—´çš„ç½‘ç»œä¸­æ–­ï¼Œé‚£ä¹ˆåè°ƒè€…å°±æ— æ³•æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ YES å“åº”ï¼Œæˆ–è€…æŸä¸ªå‚ä¸è€…è¿”å›äº† No å“åº”ã€‚æ­¤æ—¶ï¼Œåè°ƒè€…å°±ä¼šè¿›å…¥å›é€€æµç¨‹ï¼Œå¯¹äº‹åŠ¡è¿›è¡Œå›é€€ã€‚*

+ Rollback è¯·æ±‚ï¼šåè°ƒè€…å‘æ‰€æœ‰å‚ä¸è€…å‘é€ Rollback è¯·æ±‚ã€‚

+ äº‹åŠ¡å›æ»šï¼šå‚ä¸è€…æ”¶åˆ° Rollback åï¼Œä½¿ç”¨ Prepare é˜¶æ®µçš„ Undo æ—¥å¿—æ‰§è¡Œäº‹åŠ¡å›æ»šï¼Œå®Œæˆåé‡Šæ”¾äº‹åŠ¡æ‰§è¡ŒæœŸå ç”¨çš„æ‰€æœ‰èµ„æºã€‚

+ åé¦ˆç»“æœï¼šå‚ä¸è€…æ‰§è¡Œäº‹åŠ¡å›æ»šåå‘åè°ƒè€…å‘é€ Ack å“åº”ã€‚

+ ä¸­æ–­äº‹åŠ¡ï¼šæ¥æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„ Ack å“åº”åï¼Œå®Œæˆäº‹åŠ¡ä¸­æ–­ã€‚

#### 1.5 2PC æ‰€å­˜åœ¨çš„é—®é¢˜

1. **åŒæ­¥é˜»å¡**ï¼šå‚ä¸è€…åœ¨ç­‰å¾…åè°ƒè€…çš„æŒ‡ä»¤æ—¶ï¼Œå…¶å®æ˜¯åœ¨ç­‰å¾…å…¶ä»–å‚ä¸è€…çš„å“åº”ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œå‚ä¸è€…æ˜¯æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œçš„ï¼Œä¹Ÿå°±æ˜¯è¢«é˜»å¡äº†ã€‚å€˜è‹¥å‚ä¸è€…ä¸åè°ƒè€…ä¹‹é—´ç½‘ç»œå¼‚å¸¸å¯¼è‡´å‚ä¸è€…ä¸€ç›´æ”¶ä¸åˆ°åè°ƒè€…ä¿¡æ¯ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´å‚ä¸è€…ä¸€ç›´é˜»å¡ä¸‹å»ã€‚

2. **å•ç‚¹**ï¼šåœ¨ 2PC ä¸­ï¼Œä¸€åˆ‡è¯·æ±‚éƒ½æ¥è‡ªåè°ƒè€…ï¼Œæ‰€ä»¥åè°ƒè€…çš„åœ°ä½æ˜¯è‡³å…³é‡è¦çš„ã€‚å¦‚æœåè°ƒè€…å®•æœºï¼Œé‚£ä¹ˆå°±ä¼šä½¿å‚ä¸è€…ä¸€ç›´é˜»å¡å¹¶ä¸€ç›´å ç”¨äº‹åŠ¡èµ„æºã€‚å¦‚æœåè°ƒè€…ä¹Ÿæ˜¯åˆ†å¸ƒå¼ï¼Œä½¿ç”¨é€‰ä¸»æ–¹å¼æä¾›æœåŠ¡ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªåè°ƒè€…æŒ‚æ‰åï¼Œå¯ä»¥é€‰å–å¦ä¸€ä¸ªåè°ƒè€…ç»§ç»­åç»­çš„æœåŠ¡ï¼Œå¯ä»¥è§£å†³å•ç‚¹é—®é¢˜ã€‚ä½†æ˜¯ï¼Œæ–°åè°ƒè€…æ— æ³•çŸ¥é“ä¸Šä¸€ä¸ªäº‹åŠ¡çš„å…¨éƒ¨çŠ¶æ€ä¿¡æ¯ï¼ˆä¾‹å¦‚å·²ç­‰å¾… Prepare å“åº”çš„æ—¶é•¿ç­‰ï¼‰ï¼Œæ‰€ä»¥ä¹Ÿæ— æ³•é¡ºåˆ©å¤„ç†ä¸Šä¸€ä¸ªäº‹åŠ¡ã€‚

3. **æ•°æ®ä¸ä¸€è‡´**ï¼šCommit äº‹åŠ¡è¿‡ç¨‹ä¸­æäº¤/å›é€€è¯·æ±‚å¯èƒ½å› ä¸ºåè°ƒè€…å®•æœºæˆ–åè°ƒè€…ä¸å‚ä¸è€…ç½‘ç»œé—®é¢˜ä¸¢å¤±ï¼Œé‚£ä¹ˆå°±å¯¼è‡´äº†**éƒ¨åˆ†å‚ä¸è€…æ²¡æœ‰æ”¶åˆ°æäº¤/å›é€€è¯·æ±‚**ï¼Œè€Œå…¶ä»–å‚ä¸è€…åˆ™æ­£å¸¸æ”¶åˆ°æ‰§è¡Œæäº¤/å›é€€æ“ä½œï¼Œæ²¡æœ‰æ”¶åˆ°è¯·æ±‚çš„å‚ä¸è€…åˆ™ç»§ç»­é˜»å¡ã€‚è¿™æ—¶ï¼Œå‚ä¸è€…ä¹‹é—´çš„æ•°æ®å°±ä¸å†ä¸€è‡´äº†ã€‚å½“å‚ä¸è€…æ‰§è¡Œæäº¤/å›é€€æ“ä½œåä¼šå‘åè°ƒè€…å‘é€ Ackï¼Œç„¶è€Œåè°ƒè€…ä¸è®ºæ˜¯å¦æ”¶åˆ°æ‰€æœ‰çš„å‚ä¸è€…çš„ Ackï¼Œè¯¥äº‹åŠ¡ä¹Ÿä¸ä¼šå†æœ‰å…¶ä»–è¡¥æ•‘æªæ–½äº†ï¼Œåè°ƒè€…èƒ½åšçš„ä¹Ÿå°±æ˜¯ç­‰å¾…è¶…æ—¶ååƒäº‹åŠ¡å‘èµ·è€…è¿”å›ä¸€ä¸ªâ€œæˆ‘ä¸ç¡®å®šè¯¥äº‹åŠ¡æ˜¯å¦æˆåŠŸâ€ã€‚
4. **ç¯å¢ƒå¯é æ€§ä¾èµ–**ï¼šåè°ƒè€…çš„é¢„å¤„ç†è¯·æ±‚å‘å‡ºåï¼Œç­‰å¾…å“åº”ï¼Œç„¶è€Œå¦‚æœæœ‰å‚ä¸è€…å®•æœºæˆ–ä¸åè°ƒè€…ä¹‹é—´çš„ç½‘ç»œä¸­æ–­ï¼Œéƒ½ä¼šå¯¼è‡´åè°ƒè€…æ— æ³•æ”¶åˆ°æ‰€æœ‰å‚ä¸è€…çš„å“åº”ï¼Œé‚£ä¹ˆåœ¨ 2PC ä¸­ï¼Œåè°ƒè€…ä¼šç­‰å¾…ä¸€å®šæ—¶é—´ï¼Œç„¶åè¶…æ—¶åï¼Œä¼šè§¦å‘äº‹åŠ¡ä¸­æ–­ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåè°ƒè€…å’Œæ‰€æœ‰å…¶ä»–å‚ä¸è€…éƒ½æ˜¯å‡ºäºé˜»å¡çš„ã€‚

å¯ä»¥çœ‹åˆ°ï¼Œ2PC ä¸èƒ½ç™¾åˆ†ç™¾ä¿è¯äº‹åŠ¡æˆåŠŸç‡ï¼Œåªèƒ½**å°½é‡ä¿è¯**äº‹åŠ¡æˆåŠŸç‡ã€‚

###  2.ã€Œ ä»€ä¹ˆæ˜¯ Seata ã€

Seata æ˜¯ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆï¼Œè‡´åŠ›äºæä¾›é«˜æ€§èƒ½å’Œç®€å•æ˜“ç”¨çš„åˆ†å¸ƒå¼äº‹åŠ¡æœåŠ¡ã€‚Seata ä¸ºç”¨æˆ·æä¾›äº† **AT**ï¼ˆæ¨èä½¿ç”¨ï¼‰ã€TCCã€SAGA å’Œ XA äº‹åŠ¡æ¨¡å¼ï¼Œä¸ºç”¨æˆ·æ‰“é€ ä¸€ç«™å¼çš„åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆã€‚

#### 2.1 AT æ¨¡å¼

AT æ¨¡å¼æ˜¯ä¸€ç§**æ— ä¾µå…¥**çš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

ä½¿ç”¨ AT æ¨¡å¼éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š

- åŸºäºæ”¯æŒæœ¬åœ° ACID äº‹åŠ¡çš„å…³ç³»å‹æ•°æ®åº“ã€‚
- Java åº”ç”¨ï¼Œé€šè¿‡ JDBC è®¿é—®æ•°æ®åº“ã€‚

![image-20220503122201009](https://blog.caowei.xyz/blog/202205031222134.png)

AT æ¨¡å¼å¦‚ä½•åšåˆ°å¯¹ä¸šåŠ¡çš„æ— ä¾µå…¥ï¼š

+ ä¸€é˜¶æ®µï¼šSeata ä¼šæ‹¦æˆªä¸šåŠ¡ SQLï¼Œé¦–å…ˆè§£æ SQL è¯­ä¹‰ï¼Œæ‰¾åˆ°ä¸šåŠ¡ SQL è¦æ›´æ–°çš„ä¸šåŠ¡æ•°æ®ï¼Œåœ¨ä¸šåŠ¡æ•°æ®è¢«æ›´æ–°å‰ï¼Œå°†å…¶ä¿å­˜æˆ before imageï¼ˆundoï¼‰ï¼Œç„¶åæ‰§è¡Œä¸šåŠ¡ SQL æ›´æ–°ä¸šåŠ¡æ•°æ®ï¼Œ åœ¨ä¸šåŠ¡æ•°æ®æ›´æ–°ä¹‹åï¼Œå†å°†å…¶ä¿å­˜æˆafter imageï¼ˆredoï¼‰ï¼Œæœ€åç”Ÿæˆè¡Œé”ã€‚ä»¥ä¸Šæ“ä½œå…¨éƒ¨åœ¨ä¸€ä¸ªæ•°æ®åº“äº‹åŠ¡å†…å®Œæˆï¼Œè¿™æ ·ä¿è¯äº†ä¸€é˜¶æ®µæ“ä½œçš„åŸå­æ€§ã€‚

![image-20220503122231118](https://blog.caowei.xyz/blog/202205031222161.png)

+ äºŒé˜¶æ®µ - æäº¤ï¼šäºŒé˜¶æ®µå¦‚æœæ˜¯æäº¤ï¼Œå› ä¸ºä¸šåŠ¡ SQLåœ¨ä¸€é˜¶æ®µå·²ç»æäº¤è‡³æ•°æ®åº“ï¼Œ æ‰€ä»¥ Seata æ¡†æ¶åªéœ€å°†ä¸€é˜¶æ®µä¿å­˜çš„å¿«ç…§æ•°æ®å’Œè¡Œé”åˆ æ‰ï¼Œå®Œæˆæ•°æ®æ¸…ç†å³å¯ã€‚

![image-20220503122316177](https://blog.caowei.xyz/blog/202205031223212.png)

+ äºŒé˜¶æ®µ - å›æ»šï¼šäºŒé˜¶æ®µå¦‚æœæ˜¯å›æ»šï¼ŒSeata å°±éœ€è¦å›æ»šä¸€é˜¶æ®µå·²ç»æ‰§è¡Œçš„ä¸šåŠ¡ SQLï¼Œè¿˜åŸä¸šåŠ¡æ•°æ®ã€‚å›æ»šæ–¹å¼ä¾¿æ˜¯ç”¨ before image è¿˜åŸä¸šåŠ¡æ•°æ®ã€‚ä½†åœ¨è¿˜åŸå‰è¦é¦–å…ˆè¦æ ¡éªŒè„å†™ï¼Œå¯¹æ¯”æ•°æ®åº“å½“å‰ä¸šåŠ¡æ•°æ®å’Œ after imageï¼Œå¦‚æœä¸¤ä»½æ•°æ®å®Œå…¨ä¸€è‡´å°±è¯´æ˜æ²¡æœ‰è„å†™ï¼Œå¯ä»¥è¿˜åŸä¸šåŠ¡æ•°æ®ï¼Œå¦‚æœä¸ä¸€è‡´å°±è¯´æ˜æœ‰è„å†™ï¼Œå‡ºç°è„å†™å°±éœ€è¦è½¬äººå·¥å¤„ç†ã€‚

![image-20220503122345516](https://blog.caowei.xyz/blog/202205031223550.png)

#### 2.2 TCC æ¨¡å¼

ä¸Šé¢æåˆ°çš„ AT æ¨¡å¼åŸºæœ¬ä¸Šæ˜¯åœ¨ **DB å±‚**å®Œæˆçš„ï¼Œè€Œç°åœ¨è¦è®²çš„ TCC æ¨¡å¼åŸºæœ¬ä¸Šæ˜¯åœ¨**ä¸šåŠ¡å±‚**è¿›è¡Œå®Œæˆçš„ã€‚

TCC æ¨¡å¼éœ€è¦ç”¨æˆ·æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯å®ç° Tryã€Confirm å’Œ Cancel ä¸‰ä¸ªæ“ä½œï¼šäº‹åŠ¡å‘èµ·æ–¹åœ¨ä¸€é˜¶æ®µæ‰§è¡Œ Try æ–¹æ³•ï¼Œåœ¨äºŒé˜¶æ®µæäº¤æ‰§è¡Œ Confirm æ–¹æ³•ï¼ŒäºŒé˜¶æ®µå›æ»šæ‰§è¡Œ Cancel æ–¹æ³•ã€‚

TCC ä¸‰ä¸ªæ–¹æ³•çš„æè¿°ï¼ˆä»¥ A è½¬è´¦ç»™ B çš„æƒ…æ™¯ä¸ºä¾‹ï¼‰ï¼š

+ ä¸€é˜¶æ®µ - Tryï¼šèµ„æºçš„æ£€æµ‹å’Œé¢„ç•™ï¼ˆæ£€æŸ¥ A è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³ï¼Œé¢„ç•™è½¬è´¦èµ„é‡‘ï¼Œé¢„ç•™çš„æ–¹å¼å°±æ˜¯å†»ç»“ A è´¦æˆ·çš„è½¬è´¦èµ„é‡‘ï¼‰
+ äºŒé˜¶æ®µ - Confirmï¼šæ‰§è¡Œçš„ä¸šåŠ¡æ“ä½œæäº¤ï¼ˆæ‰§è¡ŒçœŸæ­£çš„æ‰£é’±æ“ä½œï¼‰
+ äºŒé˜¶æ®µ - Cancelï¼šé¢„ç•™èµ„æºé‡Šæ”¾ï¼ˆé‡Šæ”¾ä¸€é˜¶æ®µ Try å†»ç»“çš„èµ„é‡‘ï¼Œä½¿è´¦å· A çš„å›åˆ°åˆå§‹çŠ¶æ€ï¼‰

![image-20220504133321601](https://blog.caowei.xyz/blog/202205041333700.png)

TCC æ¨¡å¼ä¸‹å„æ“ä½œæ‰€æ‰§è¡Œçš„é€»è¾‘ä»£ç éƒ½éœ€è¦æˆ‘ä»¬è‡ªå·±å»å®ç°ã€‚ä¸ AT æ¨¡å¼ç›¸æ¯”ï¼Œä¼˜ç‚¹æ˜¯æ•´ä¸ªè¿‡ç¨‹**åŸºæœ¬æ²¡æœ‰é”**ï¼Œæ€§èƒ½æ›´å¥½ã€‚ç¼ºç‚¹æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™ä»£ç ï¼Œ**ä¾µå…¥æ€§æ›´å¼º**ã€‚

è€Œå®é™…ä½¿ç”¨ä¸­ï¼ŒTCC å¾€å¾€ä¼šç»“åˆ MQ å®ç°æœåŠ¡é—´çš„å¼‚æ­¥è°ƒç”¨ï¼Œè¿™ç§è§£å†³æ–¹æ¡ˆç§°ä¸ºå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆã€‚å…³äºè¿™ä¸ªæ–¹æ¡ˆå¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢ ğŸ‘‰ğŸ»[åˆ†å¸ƒå¼ç†è®ºä¹‹åˆ†å¸ƒå¼äº‹åŠ¡ï¼šå¯é æ¶ˆæ¯æœ€ç»ˆä¸€è‡´æ€§æ–¹æ¡ˆ](https://zhuanlan.zhihu.com/p/462665440)ã€‚

Saga æ¨¡å¼ä¸ XT æ¨¡å¼ä½¿ç”¨è¾ƒå°‘ä¸ä½œä»‹ç»äº†ï¼Œä»¥åæœ‰æœºä¼šé‡åˆ°å†è¡¥ä¸Šã€‚

### 3.ã€Œ æ­å»º Seata Server ã€

Seata Server ç«¯æ”¯æŒä¸‰ç§å­˜å‚¨æ¨¡å¼ï¼š

+ å•æœºæ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šå…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯åœ¨å†…å­˜ä¸­è¯»å†™å¹¶æŒä¹…åŒ–æœ¬åœ°æ–‡ä»¶ root.dataï¼Œæ€§èƒ½è¾ƒé«˜
+ **DB**ï¼šé«˜å¯ç”¨æ¨¡å¼ï¼Œå…¨å±€äº‹åŠ¡ä¼šè¯ä¿¡æ¯é€šè¿‡ db å…±äº«ï¼Œç›¸åº”æ€§èƒ½å·®äº›ã€‚ï¼ˆéœ€ä½¿ç”¨ 5.7+ MySQLï¼‰
+ Redisï¼šæ€§èƒ½è¾ƒé«˜ï¼Œ**å­˜åœ¨äº‹åŠ¡ä¿¡æ¯ä¸¢å¤±é£é™©**ï¼Œéœ€æå‰é…ç½®é€‚åˆå½“å‰åœºæ™¯çš„ Redis æŒä¹…åŒ–é…ç½®ï¼ˆSeata Server 1.3åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒï¼‰

#### **ä½¿ç”¨ DB + Nacos çš„æ–¹å¼éƒ¨ç½²é«˜å¯ç”¨æ¨¡å¼ï¼š**

1. [Seata Server æ–‡ä»¶å¤¹] ä¸‹è½½å¯¹åº”ç‰ˆæœ¬çš„å‹ç¼©åŒ…ï¼Œä¸‹è½½åœ°å€ ğŸ‘‰ğŸ»[Releases Â· seata](https://github.com/seata/seata/releases)

2. [Seata Server æ–‡ä»¶å¤¹] ä¿®æ”¹ conf ç›®å½•ä¸‹çš„ `file.conf` é…ç½®æ–‡ä»¶

+ å°†å­˜å‚¨æ¨¡å¼æ”¹ä¸º DB

```properties
  ## store mode: fileã€dbã€redis
  mode = "db"
```

+ ä¿®æ”¹æ•°æ®åº“ç›¸å…³è®¾ç½®

```properties
## database store property
db {
  ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.
  datasource = "druid"
  ## mysql/oracle/postgresql/h2/oceanbase etc.
  dbType = "mysql"
  driverClassName = "com.mysql.cj.jdbc.Driver"
  url = "jdbc:mysql://127.0.0.1:3306/seata-server"
  user = "root"
  password = "aaaa1234"
  minConn = 5
  maxConn = 30
  globalTable = "global_table"
  branchTable = "branch_table"
  lockTable = "lock_table"
  queryLimit = 100
  maxWait = 5000
}
```

3. ä½¿ç”¨ SQL è„šæœ¬åˆ›å»º seata ä½¿ç”¨çš„æ•°æ®è¡¨

SQL è„šæœ¬ä¸‹è½½åœ°å€ï¼š[seata/script/server/db at develop](https://github.com/seata/seata/tree/develop/script/server/db)

4. [Seata Server æ–‡ä»¶å¤¹] ä¿®æ”¹ conf ç›®å½•ä¸‹çš„ `registry.conf` é…ç½®æ–‡ä»¶

+ ä¿®æ”¹ Nacos æ³¨å†Œä¸­å¿ƒç›¸å…³é…ç½®

```properties
registry {
  # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa
  type = "nacos"

  nacos {
    application = "seata-server"
    serverAddr = "127.0.0.1:8850"
    group = "SEATA_GROUP"
    namespace = ""
    cluster = "default"
    username = "nacos"
    password = "nacos"
  }
  ...
 }
```

+ ä¿®æ”¹ Nacos é…ç½®ä¸­å¿ƒç›¸å…³é…ç½®

```properties
config {
  # fileã€nacos ã€apolloã€zkã€consulã€etcd3
  type = "nacos"

  nacos {
    serverAddr = "127.0.0.1:8850"
    namespace = ""
    group = "SEATA_GROUP"
    username = "nacos"
    password = "nacos"
  }
  ...
}
```

5. ä¸‹è½½å®˜æ–¹æä¾›çš„é…ç½®è„šæœ¬ï¼Œä¸‹è½½åœ°å€ ğŸ‘‰ğŸ»[seata/script/config-center at develop](https://github.com/seata/seata/tree/develop/script/config-center)

+ ä¿®æ”¹ config-center ä¸‹çš„ `config.txt` æ–‡ä»¶

![image-20220504163233419](https://blog.caowei.xyz/blog/202205041632535.png)

```properties
...
store.mode=db
...
store.db.dbType=mysql
store.db.driverClassName=com.mysql.cj.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata-server?useUnicode=true
store.db.user=root
store.db.password=aaaa1234
```

> è¯¥é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹ `service.vgroupMapping.my_test_tx_group=default`
>
> ç”¨äºäº‹åŠ¡åˆ†ç»„ï¼šå¼‚åœ°æœºæˆ¿åœç”µå®¹é”™æœºåˆ¶ã€‚
>
> å…¶ä¸­ my_test_tx_group å¯ä»¥è‡ªå®šä¹‰ï¼Œå¦‚ Shanghaiï¼Œbeijing ç­‰ï¼Œ**Client ç«¯ä¹Ÿè¦å¯¹åº”å»è®¾ç½®**ã€‚
>
> **default éœ€è¦å’Œ `registry.conf` é…ç½®æ–‡ä»¶ä¸­çš„ `cluster = "default"` ä¿æŒä¸€è‡´**
>
> æ›´å¤šç»†èŠ‚å¯ä»¥å‚è€ƒ ğŸ‘‰ğŸ» [äº‹åŠ¡åˆ†ç»„ä¸é«˜å¯ç”¨ (seata.io)](http://seata.io/zh-cn/docs/user/txgroup/transaction-group-and-ha.html)

+ è¿è¡Œ config-center/nacos æ–‡ä»¶å¤¹ä¸­çš„ `nacos-config.sh` è„šæœ¬
  + -hï¼šNacos Server åœ°å€ï¼ˆé»˜è®¤ä¸º localhostï¼‰
  + -pï¼šNacos Server ç«¯å£å·ï¼ˆé»˜è®¤ä¸º 8848ï¼‰
  + -gï¼šé…ç½®åˆ†ç»„ï¼ˆé»˜è®¤å€¼ 'SEATA_GROUP'ï¼‰
  + -tï¼šç§Ÿæˆ·ä¿¡æ¯ï¼Œå¯¹åº” Nacos çš„å‘½åç©ºé—´ ID å­—æ®µï¼ˆé»˜è®¤ä¸ºç©ºï¼‰

```shell
sh nacosâ€config.sh â€h localhost â€p 8850 â€g SEATA_GROUP
```

![image-20220504165846409](https://blog.caowei.xyz/blog/202205041658532.png)

æ‰“å¼€ Nacos é…ç½®ç®¡ç†åˆ—è¡¨ï¼Œå¯ä»¥çœ‹åˆ°é…ç½®å·²ç»è¢«åŠ è½½è¿›æ¥äº†ï¼š

![image-20220504171322782](https://blog.caowei.xyz/blog/202205041713902.png)

6. [Seata Server æ–‡ä»¶å¤¹] è¿è¡Œ bin æ–‡ä»¶å¤¹ä¸‹çš„ `seata-server.sh` å¯åŠ¨ Seata Server

+ -hï¼šæŒ‡å®šåœ¨æ³¨å†Œä¸­å¿ƒä¸­æ³¨å†Œçš„ IPï¼ˆé»˜è®¤ä¸ºæœ¬æœº IPï¼‰
+ -pï¼šæŒ‡å®š server çš„å¯åŠ¨ç«¯å£ï¼ˆé»˜è®¤ä¸º 8091ï¼‰
+ -mï¼šæŒ‡å®šäº‹åŠ¡æ—¥å¿—å­˜å‚¨æ–¹å¼ï¼ˆé»˜è®¤ä¸º fileï¼‰ï¼Œæ”¯æŒ fileï¼Œdbï¼Œredisï¼ˆ1.3+ æ”¯æŒï¼‰
+ -nï¼šæŒ‡å®š server çš„èŠ‚ç‚¹ IDï¼ˆé»˜è®¤ä¸º 1ï¼‰
+ -eï¼šæŒ‡å®š server çš„è¿è¡Œç¯å¢ƒï¼ˆå¦‚ devï¼Œtest ç­‰ï¼‰

![image-20220504182133769](https://blog.caowei.xyz/blog/202205041821887.png)

### 4.ã€Œ åœ¨ Client ç«¯ä½¿ç”¨ Seata ã€

1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
</dependency>
```

2. å„å¾®æœåŠ¡å¯¹åº”çš„æ•°æ®åº“ä¸­æ·»åŠ  undo_log è¡¨

*ä¿å­˜æ‰§è¡Œå‰åçš„å…ƒæ•°æ®ï¼Œç”¨äºå›æ»šæ“ä½œ*

```sql
CREATE TABLE`undo_log`(
    `id` bigint(20) NOT NULL AUTO_INCREMENT,
    `branch_id` bigint(20) NOT NULL,
    `xid` varchar(100) NOT NULL,
    `context` varchar(128) NOT NULL,
    `rollback_info` longblob NOT NULL,
    `log_status` int(11) NOT NULL,
    `log_created` datetime NOT NULL,
    `log_modified` datetime NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
)ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;
```

3. åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®äº‹åŠ¡åˆ†ç»„ï¼Œéœ€è¦å’Œä¹‹å‰åœ¨é…ç½®ä¸­å¿ƒé…ç½®çš„ `service.vgroupMapping.xxx=default` ä¿æŒä¸€è‡´

```properties
spring.cloud.alibaba.seata.tx-service-group=my_test_tx_group
```

4. é…ç½® Seata çš„æ³¨å†Œä¸­å¿ƒä¸é…ç½®ä¸­å¿ƒ

```yml
seata:
  # é…ç½® Seata çš„æ³¨å†Œä¸­å¿ƒï¼Œè®© Seata Client çŸ¥é“å¦‚ä½•è®¿é—® Seata Server
  registry:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8850 # Seata Server æ‰€åœ¨ Nacos çš„æœåŠ¡åœ°å€
      username: nacos
      password: nacos
      application: seata-server # Seata Server çš„æœåŠ¡å
      group: SEATA_GROUP
  # é…ç½® Seata çš„é…ç½®ä¸­å¿ƒï¼Œè¯»å– Seata Client çš„ç›¸å…³é…ç½®
  config:
    type: nacos
    nacos:
      server-addr: 127.0.0.1:8850 # Seata Server æ‰€åœ¨ Nacos çš„æœåŠ¡åœ°å€
      username: nacos
      password: nacos
      group: SEATA_GROUP
```

5. åœ¨éœ€è¦åˆ†å¸ƒå¼äº‹åŠ¡çš„æ–¹æ³•ä¸Šæ·»åŠ  `@GlobalTransactional` æ³¨è§£å³å¯ã€‚
6. æµ‹è¯•

```java
@GlobalTransactional
@Override
public Order create(Order order) {
    // æœ¬åœ°æ–¹æ³•ï¼šæ’å…¥è®¢å•
    orderMapper.insert(order);

    // è¿œç¨‹è°ƒç”¨æ–¹æ³•ï¼šæ‰£å‡åº“å­˜
    stockService.reduct(order.getProductId());

    // è§¦å‘å¼‚å¸¸
    int a = 1 / 0;

    return order;
}
```

æ‰§è¡ŒåæˆåŠŸå›æ»šï¼š

![image-20220505001432968](https://blog.caowei.xyz/blog/202205050014160.png)