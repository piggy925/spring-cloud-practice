## æµé‡æ§åˆ¶ Sentinel

### 1.ã€Œ è®¤è¯† Sentinel ã€

1. åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å¸¸è§çš„é—®é¢˜ï¼š

åœ¨ä¸€ä¸ªé«˜åº¦æœåŠ¡åŒ–çš„ç³»ç»Ÿä¸­ï¼Œæˆ‘ä»¬å®ç°çš„ä¸€ä¸ªä¸šåŠ¡é€»è¾‘é€šå¸¸ä¼šä¾èµ–å¤šä¸ªæœåŠ¡ï¼Œå¦‚æœå…¶ä¸­çš„æŸä¸ªæœåŠ¡ä¸å¯ç”¨, å°±ä¼šå‡ºç°çº¿ç¨‹æ± é‡Œæ‰€æœ‰çº¿ç¨‹éƒ½å› ç­‰å¾…å“åº”è€Œè¢«é˜»å¡, ä»è€Œé€ æˆæ•´ä¸ªæœåŠ¡é“¾è·¯ä¸å¯ç”¨ï¼Œ è¿›è€Œå¯¼è‡´æ•´ä¸ªç³»ç»Ÿçš„**æœåŠ¡é›ªå´©**ã€‚

åœ¨æœåŠ¡æä¾›è€…ä¸å¯ç”¨çš„æ—¶å€™ï¼Œä¼šå‡ºç°å¤§é‡é‡è¯•çš„æƒ…å†µï¼šç”¨æˆ·é‡è¯•ã€ä»£ç é€»è¾‘é‡è¯•ã€‚è¿™äº›é‡è¯•æœ€ç»ˆå¯¼è‡´ï¼šè¿›ä¸€æ­¥åŠ å¤§è¯·æ±‚æµé‡ã€‚æ‰€ä»¥å½’æ ¹ç»“åº•å¯¼è‡´é›ªå´©æ•ˆåº”çš„**æœ€æ ¹æœ¬åŸå› **æ˜¯ï¼šå¤§é‡è¯·æ±‚çº¿ç¨‹åŒæ­¥ç­‰å¾…é€ æˆçš„èµ„æºè€—å°½ã€‚å½“æœåŠ¡è°ƒç”¨è€…ä½¿ç”¨åŒæ­¥è°ƒç”¨æ—¶,
ä¼šäº§ç”Ÿå¤§é‡çš„ç­‰å¾…çº¿ç¨‹å ç”¨ç³»ç»Ÿèµ„æºã€‚ä¸€æ—¦çº¿ç¨‹èµ„æºè¢«è€—å°½ï¼ŒæœåŠ¡è°ƒç”¨è€…æä¾›çš„æœåŠ¡ä¹Ÿå°†å¤„äºä¸å¯ç”¨çŠ¶æ€ï¼Œäºæ˜¯æœåŠ¡é›ªå´©æ•ˆåº”äº§ç”Ÿäº†ã€‚

**æœåŠ¡é›ªå´©æ•ˆåº”**ï¼šå› æœåŠ¡æä¾›è€…çš„ä¸å¯ç”¨å¯¼è‡´æœåŠ¡è°ƒç”¨è€…çš„ä¸å¯ç”¨,å¹¶å°†ä¸å¯ç”¨é€æ¸æ”¾å¤§çš„è¿‡ç¨‹ï¼Œå°±å«æœåŠ¡é›ªå´©æ•ˆåº”ã€‚

2. å¸¸è§çš„å®¹é”™æœºåˆ¶

+ è¶…æ—¶æœºåˆ¶ï¼šåœ¨ä¸åšä»»ä½•å¤„ç†çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡æä¾›è€…ä¸å¯ç”¨ä¼šå¯¼è‡´æ¶ˆè´¹è€…è¯·æ±‚çº¿ç¨‹å¼ºåˆ¶ç­‰å¾…ï¼Œè€Œé€ æˆç³»ç»Ÿèµ„æºè€—å°½ã€‚åŠ å…¥è¶…æ—¶æœºåˆ¶ï¼Œä¸€æ—¦è¶…æ—¶å°±é‡Šæ”¾èµ„æºã€‚ç”±äºé‡Šæ”¾èµ„æºé€Ÿåº¦è¾ƒå¿«ï¼Œä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥æŠ‘åˆ¶èµ„æºè€—å°½çš„é—®é¢˜ã€‚

+ æœåŠ¡é™æµ

+ éš”ç¦»ï¼šç”¨æˆ·çš„è¯·æ±‚å°†ä¸å†ç›´æ¥è®¿é—®æœåŠ¡ï¼Œè€Œæ˜¯é€šè¿‡çº¿ç¨‹æ± ä¸­çš„ç©ºé—²çº¿ç¨‹æ¥è®¿é—®æœåŠ¡ï¼Œå¦‚æœçº¿ç¨‹æ± å·²æ»¡ï¼Œåˆ™ä¼šè¿›è¡Œé™çº§ å¤„ç†ï¼Œç”¨æˆ·çš„è¯·æ±‚ä¸ä¼šè¢«é˜»å¡ï¼Œè‡³å°‘å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ‰§è¡Œç»“æœï¼ˆä¾‹å¦‚è¿”å›æç¤ºä¿¡æ¯ï¼‰ï¼Œè€Œä¸æ˜¯æ— ä¼‘æ­¢çš„ç­‰å¾…æˆ–è€…çœ‹åˆ°ç³»ç»Ÿå´©æºƒã€‚

+ æœåŠ¡ç†”æ–­ï¼šè¿œç¨‹æœåŠ¡ä¸ç¨³å®šæˆ–ç½‘ç»œæŠ–åŠ¨æ—¶æš‚æ—¶å…³é—­ï¼Œå°±å«æœåŠ¡ç†”æ–­ã€‚
+ æœåŠ¡é™çº§ï¼šå½“æŸä¸ªæœåŠ¡ç†”æ–­ä¹‹åï¼ŒæœåŠ¡å°†ä¸å†è¢«è°ƒç”¨ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å¯ä»¥è‡ªå·±å‡†å¤‡ä¸€ä¸ªæœ¬åœ°çš„å›è°ƒï¼Œ è¿”å›ä¸€ä¸ªç¼ºçœå€¼å¦‚ Mock æ•°æ®ã€‚

3. Sentinel ä»‹ç»

> éšç€å¾®æœåŠ¡çš„æµè¡Œï¼ŒæœåŠ¡å’ŒæœåŠ¡ä¹‹é—´çš„ç¨³å®šæ€§å˜å¾—è¶Šæ¥è¶Šé‡è¦ã€‚Sentinel æ˜¯é¢å‘åˆ†å¸ƒå¼æœåŠ¡æ¶æ„çš„æµé‡æ§åˆ¶ç»„ä»¶ï¼Œä¸»è¦ä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥å¸®åŠ©æ‚¨ä¿éšœå¾®æœåŠ¡çš„ç¨³å®šæ€§ã€‚
>
> ä»¥ä¸Šä»‹ç»æ¥è‡ªğŸ‘‰ğŸ»[Sentinel å®˜æ–¹æ–‡æ¡£](https://sentinelguard.io/zh-cn/docs/introduction.html)

ç‰¹ç‚¹ï¼š

+ ä¸°å¯Œçš„åº”ç”¨åœºæ™¯ï¼šSentinel æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯ï¼Œä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚

+ å®Œå¤‡çš„å®æ—¶ç›‘æ§ï¼šSentinel åŒæ—¶æä¾›å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚æ‚¨å¯ä»¥åœ¨æ§åˆ¶å°ä¸­çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®ï¼Œ ç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚

+ å¹¿æ³›çš„å¼€æºç”Ÿæ€ï¼šSentinel æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—ï¼Œä¾‹å¦‚ä¸ Spring Cloudã€Dubboã€ gRPC çš„æ•´åˆã€‚åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥ Sentinelã€‚

+ å®Œå–„çš„ **SPI** æ‰©å±•ç‚¹ï¼šSentinel æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„ SPI æ‰©å±•ç‚¹ã€‚å¯ä»¥é€šè¿‡å®ç°æ‰©å±•ç‚¹ï¼Œå¿«é€Ÿçš„å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…æ•°æ®æºç­‰ã€‚

### 2.ã€Œ å•ç‹¬ä½¿ç”¨ Sentinel ã€

Sentinel ä¸ä¸€å®šéè¦æ•´åˆ Spring Cloud ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨å…¶ä»–åˆ†å¸ƒå¼ç³»ç»Ÿä¸­å•ç‹¬ä½¿ç”¨ã€‚

Sentinel æ‰€æŒ‡å®šçš„è§„åˆ™éƒ½æ˜¯é’ˆå¯¹**æ¥å£**åˆ¶å®šçš„ã€‚

1. æ·»åŠ ä¾èµ–

```xml
<!--    é€šè¿‡æ³¨è§£çš„æ–¹å¼ä½¿ç”¨ Sentinel    -->
<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-annotation-aspectj</artifactId>
    <version>1.8.3</version>
</dependency>

        <!--    Sentinel æ ¸å¿ƒåº“    -->
<dependency>
<groupId>com.alibaba.csp</groupId>
<artifactId>sentinel-core</artifactId>
<version>1.8.4</version>
</dependency>
```

2. é…ç½® Bean

```java
// æ³¨è§£æ”¯æŒçš„é…ç½®Bean
@Bean
public SentinelResourceAspect sentinelResourceAspect(){
        return new SentinelResourceAspect();
        }
```

3. åœ¨æ¥å£ä¸Šæ·»åŠ  `@SentinelResource` æ³¨è§£

+ `value`ï¼šæŒ‡å®šèµ„æºåç§°

+ `fallback`ï¼šæŒ‡å®šæ¥å£å‡ºç°å¼‚å¸¸æ—¶çš„å¤„ç†æ–¹æ³•ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š
    + ä¸€å®šè¦ä¸º`public`ï¼Œå¦‚æœä¸æ¥å£**ä¸åœ¨åŒä¸€ä¸ªç±»**ï¼Œéœ€è¦å£°æ˜ä¸º`static`ï¼Œç„¶åä½¿ç”¨`fallbackClass`æŒ‡å®šå…¶æ‰€åœ¨çš„ç±»ã€‚
    + è¿”å›å€¼ã€æ–¹æ³•å‚æ•°éœ€è¦å’Œæºæ–¹æ³•ä¿è¯ä¸€è‡´ã€‚
    + å¯ä»¥åœ¨å‚æ•°æœ€åæ·»åŠ `Throwable`è·å–æ˜¯å“ªç§å¼‚å¸¸ã€‚
+ `blockHandler`ï¼šè®¾ç½®æµæ§é™çº§åçš„å¤„ç†æ–¹æ³•ï¼Œæœ‰ä»¥ä¸‹å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š
    + ä¸€å®šè¦ä¸º`public`ï¼Œå¦‚æœä¸æ¥å£**ä¸åœ¨åŒä¸€ä¸ªç±»**ï¼Œéœ€è¦å£°æ˜ä¸º`static`ï¼Œç„¶åä½¿ç”¨`blockHandlerClass`æŒ‡å®šå…¶æ‰€åœ¨çš„ç±»ã€‚
    + è¿”å›å€¼ã€æ–¹æ³•å‚æ•°éœ€è¦å’Œæºæ–¹æ³•ä¿è¯ä¸€è‡´ã€‚
    + å¯ä»¥åœ¨å‚æ•°æœ€åæ·»åŠ `BlockException`å¯ä»¥åŒºåˆ†æ˜¯ä»€ä¹ˆè§„åˆ™çš„å¤„ç†æ–¹æ³•ã€‚
    + å¦‚æœå’Œ`fallback`åŒæ—¶æŒ‡å®šäº†ï¼Œåˆ™`blockHandler`**ä¼˜å…ˆçº§æ›´é«˜**ã€‚
+ `exceptionsToIgnore`ï¼šæŒ‡å®šå“ªäº›å¼‚å¸¸ä¸éœ€è¦å¤„ç†ã€‚

æ³¨è§£ä½¿ç”¨è¯·æˆ³ï¼šğŸ‘‰ğŸ»[Sentinel æ³¨è§£æ”¯æŒå®˜æ–¹æ–‡æ¡£](https://github.com/alibaba/Sentinel/wiki/æ³¨è§£æ”¯æŒ)

äº†è§£ Sentinel æ”¯æŒçš„æ‰€æœ‰è§„åˆ™è¯·æˆ³ï¼šğŸ‘‰ğŸ»[Sentinel è§„åˆ™çš„ç§ç±»](https://github.com/alibaba/Sentinel/wiki/å¦‚ä½•ä½¿ç”¨#è§„åˆ™çš„ç§ç±»)

```java
@RequestMapping("/user")
@SentinelResource(value = USER_RESOURCE_NAME, fallback = "fallbackHandleForGetUser",
        exceptionsToIgnore = {ArithmeticException.class}, blockHandlerClass = User.class, blockHandler = "blockHandlerForGetUser")
public User getUser(String id){
        int a=1/0;
        return new User("mumu");
        }

/**
 *  blockHandler æŒ‡å®šçš„å¤„ç†æ–¹æ³•ï¼š
 *  1. ä¸€å®šè¦ä¸º publicï¼Œå¦‚æœä¸æ¥å£ä¸åœ¨åŒä¸€ä¸ªç±»ä¸‹ï¼Œéœ€è¦ä¸º static
 *  2. è¿”å›å€¼ä¸€å®šè¦å’Œæºæ–¹æ³•ä¿è¯ä¸€è‡´ï¼ŒåŒ…å«æºæ–¹æ³•çš„å‚æ•°
 *  3. åœ¨å‚æ•°æœ€åæ·»åŠ BlockExceptionåŒºåˆ†æ˜¯ä»€ä¹ˆè§„åˆ™çš„å¤„ç†æ–¹æ³•
 */
public User blockHandlerForGetUser(String id,BlockException ex){
        ex.printStackTrace();
        return new User("æµæ§ï¼ï¼");
        }

/**
 *  å®šä¹‰è§„åˆ™ï¼ˆä»¥æµæ§è§„åˆ™ä¸ºä¾‹ï¼‰
 *  å…¶ä»–è§„åˆ™åªæ˜¯å®šä¹‰çš„ç±»æœ‰åŒºåˆ«ï¼Œè®¾ç½®æ–¹å¼ç±»ä¼¼
 */
@PostConstruct
private static void initFlowRules(){
        // æµæ§è§„åˆ™
        List<FlowRule> rules=new ArrayList<>();
        // é€šè¿‡@SentinelResourceæ¥å®šä¹‰èµ„æºå¹¶é…ç½®é™çº§å’Œæµæ§çš„å¤„ç†æ–¹æ³•
        FlowRule rule=new FlowRule();
        //è®¾ç½®å—ä¿æŠ¤çš„èµ„æº
        rule.setResource(USER_RESOURCE_NAME);
        // è®¾ç½®æµæ§è§„åˆ™ QPS
        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);
        // è®¾ç½®å—ä¿æŠ¤çš„èµ„æºé˜ˆå€¼
        // Set limit QPS to 20.
        rule.setCount(1);
        rules.add(rule);
        // åŠ è½½é…ç½®å¥½çš„è§„åˆ™
        FlowRuleManager.loadRules(rules);
        }
```

æµæ§è§„åˆ™ä¸€èˆ¬è®¾ç½®åœ¨æœåŠ¡æä¾›æ–¹ï¼Œé™çº§è§„åˆ™ä¸€èˆ¬è®¾ç½®åœ¨æœåŠ¡æ¶ˆè´¹æ–¹ã€‚

### 3.ã€Œ ä½¿ç”¨ Sentinel æ§åˆ¶å° ã€

ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ä»£ç é…ç½®çš„æ–¹å¼æ¯”è¾ƒç¹çï¼Œä¸”æœ‰è¾ƒå¼ºçš„å€¾å…¥æ€§ã€‚è€Œ Sentinel ä¸ºæˆ‘ä»¬æä¾›äº†æ§åˆ¶å°ç•Œé¢ï¼Œèƒ½æ›´ç®€å•ç›´è§‚åœ°é…ç½®å„ç§è§„åˆ™ã€‚

Sentinel æ§åˆ¶å°å®˜æ–¹æ–‡æ¡£è¯·æˆ³ï¼šğŸ‘‰ğŸ»[Sentinel æ§åˆ¶å°](https://github.com/alibaba/Sentinel/wiki/æ§åˆ¶å°)

1. ä¸‹è½½ Sentinel æ§åˆ¶å°çš„ jar åŒ…ï¼Œä¸‹è½½åœ°å€ğŸ‘‰ğŸ»[Sentinel - releases](https://github.com/alibaba/Sentinel/releases)ã€‚
2. åœ¨ jar åŒ…ç›®å½•ä¸‹ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿è¡Œ jar åŒ…ï¼š

```shell
java -jar sentinel-dashboard-1.8.1.jar
```

é»˜è®¤ç«¯å£ä¸ºï¼š8080ï¼Œé»˜è®¤ç”¨æˆ·åã€å¯†ç ï¼šsentinel

ä¹Ÿå¯ä»¥æ‰‹åŠ¨é…ç½®ç«¯å£ã€ç”¨æˆ·åã€å¯†ç ï¼š

```shell
java -Dserver.port=8090 -Dsentinel.dashboard.auth.username=sentinel -Dsentinel.dashboard.auth.password=123456 -jar sentinel-dashboard-1.8.1.jar
```

å®Œæ•´å¯é…ç½®é¡¹è¯·æˆ³ï¼šğŸ‘‰ğŸ»[Sentinel æ§åˆ¶å°é…ç½®é¡¹](https://github.com/alibaba/Sentinel/wiki/æ§åˆ¶å°#æ§åˆ¶å°é…ç½®é¡¹)

3. æ·»åŠ ä¾èµ–

```xml

<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-transport-simple-http</artifactId>
    <version>1.8.1</version>
</dependency>
```

4. åœ¨å¯åŠ¨æ—¶åŠ å…¥ JVM å‚æ•° `-Dcsp.sentinel.dashboard.server=consoleIp:port` æŒ‡å®šæ§åˆ¶å°åœ°å€å’Œç«¯å£

![image-20220430220213706](https://blog.caowei.xyz/blog/202204302202037.png)

5. è¯·æ±‚ä¸€ä¸‹ `Sentinel` æ‰€æ§åˆ¶çš„æ¥å£ï¼Œå³å¯å°†æ¥å£æ³¨å†Œè¿›å»

![image-20220430220329996](https://blog.caowei.xyz/blog/202204302203164.png)

Sentinel æ§åˆ¶å°å„é…ç½®é¡¹ä»‹ç»è§ 4.2 éƒ¨åˆ†ğŸ‘‡ğŸ»

### 4. ã€Œ Spring Cloud Alibaba æ•´åˆ Sentinel ã€

#### 4.1 æ•´åˆæ­¥éª¤

1. åœ¨ å­pom ä¸­æ·»åŠ ä¾èµ–

```xml

<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

2. åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½® Sentinel æ§åˆ¶å°çš„åœ°å€

```properties
spring.cloud.sentinel.transport.dashboard=127.0.0.1:8090
```

3. ä¸‹è½½ jar åŒ…å¯åŠ¨ Sentinel æ§åˆ¶å°

```shell
java -Dserver.port=8090 -Dsentinel.dashboard.auth.username=sentinel -Dsentinel.dashboard.auth.password=123456 -jar /Users/mumu/Desktop/nacos-cluster/sentinel-dashboard-1.8.1.jar
```

ä¸€å¼€å§‹é‡Œé¢æ²¡æœ‰ä»»ä½•ä¿¡æ¯ï¼Œéœ€è¦**è®¿é—®æ¥å£ä¹‹å**æ‰ä¼šå°†æœåŠ¡æ³¨å†Œåˆ° Sentinel ä¸­ã€‚

![image-20220501182716515](https://blog.caowei.xyz/blog/202205011827919.png)

#### 4.2 Sentinel æ§åˆ¶å°é…ç½®é¡¹ä»‹ç»

1. å®æ—¶ç›‘æ§ï¼šç›‘æ§æ¥å£çš„é€šè¿‡çš„ QPS å’Œæ‹’ç»çš„ QPSã€‚

**æ³¨æ„:** å®æ—¶ç›‘æ§ä»…å­˜å‚¨ 5 åˆ†é’Ÿä»¥å†…çš„æ•°æ®ï¼Œå¦‚æœéœ€è¦æŒä¹…åŒ–ï¼Œéœ€è¦é€šè¿‡è°ƒç”¨[å®æ—¶ç›‘æ§æ¥å£](https://github.com/alibaba/Sentinel/wiki/å®æ—¶ç›‘æ§)æ¥å®šåˆ¶ã€‚

![image-20220501184638458](https://blog.caowei.xyz/blog/202205011846628.png)

2. ç°‡ç‚¹é“¾è·¯ï¼šæ˜¾ç¤ºå¾®æœåŠ¡çš„æ‰€ç›‘æ§çš„ APIï¼ˆæ¥å£éœ€è¦è¢«è®¿é—®ä¹‹åæ‰ä¼šæ˜¾ç¤ºå‡ºæ¥ï¼‰

![image-20220501185043500](https://blog.caowei.xyz/blog/202205011850629.png)

### 5.ã€Œ Sentinel æµæ§ ã€

#### 5.1 æµæ§è§„åˆ™

*å…¶åŸç†æ˜¯ç›‘æ§åº”ç”¨æµé‡çš„ QPS æˆ–å¹¶å‘çº¿ç¨‹æ•°ç­‰æŒ‡æ ‡ï¼Œå½“è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼æ—¶å¯¹æµé‡è¿›è¡Œæ§åˆ¶ï¼Œ ä»¥é¿å…è¢«ç¬æ—¶çš„æµé‡é«˜å³°å†²å®ï¼Œä»è€Œä¿éšœåº”ç”¨çš„é«˜å¯ç”¨æ€§ã€‚*

ä¸€èˆ¬åœ¨æœåŠ¡**æä¾›ç«¯**ï¼ˆè¢«è°ƒç”¨çš„ä¸€æ–¹ï¼‰é’ˆå¯¹è„‰å†²æµé‡è¿›è¡Œæµæ§ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„è°ƒç”¨æ¥æºè¿›è¡Œæµæ§ã€‚

ä½¿ç”¨åœºæ™¯ï¼š

+ åº”å¯¹æ´ªå³°æµé‡ï¼šç§’æ€ï¼Œå¤§ä¿ƒï¼Œä¸‹å•ï¼Œè®¢å•å›æµå¤„ç†
+ æ¶ˆæ¯å‹åœºæ™¯ï¼šå‰Šå³°å¡«è°·ï¼Œå†·çƒ­å¯åŠ¨
+ ä»˜è´¹ç³»ç»Ÿï¼šæ ¹æ®ä½¿ç”¨æµé‡ä»˜è´¹
+ API Gatewayï¼šç²¾å‡†æ§åˆ¶ API æµé‡
+ ä»»ä½•åº”ç”¨ï¼šæ¢æµ‹åº”ç”¨ä¸­è¿è¡Œæ»¡çš„ç¨‹åºå—ï¼Œè¿›è¡Œé™åˆ¶

1. æ·»åŠ ä¸€æ¡æµæ§è§„åˆ™

**æ³¨æ„ï¼šæµæ§è§„åˆ™æ˜¯å­˜åœ¨å†…å­˜ä¸­çš„ï¼ŒæœåŠ¡é‡å¯ä¹‹åå°±ä¼šæ¶ˆå¤±ï¼**åé¢ä¼šè®²åˆ°å¦‚ä½•å°†è§„åˆ™æŒä¹…åŒ–ã€‚

QPSæµæ§ï¼šé™åˆ¶æ¯ç§’è¯·æ±‚æ•°ï¼Œå³æœåŠ¡å™¨åœ¨ä¸€ç§’çš„æ—¶é—´å†…å¤„ç†å¤šå°‘ä¸ªè¯·æ±‚ã€‚

çº¿ç¨‹æ•°æµæ§ï¼šé™åˆ¶æœåŠ¡å™¨åŒæ—¶å¤„ç†çš„çº¿ç¨‹æ•°ã€‚ç”¨è¶…å¸‚æ¥ä¸¾ä¾‹å­ï¼Œè¶…å¸‚æœ€å¤šèƒ½å®¹çº³ 5
ä¸ªäººï¼ˆé˜ˆå€¼ï¼‰åŒæ—¶è´­ç‰©ï¼ˆå¤„ç†ï¼‰ï¼Œäººæ•°è¾¾åˆ°é˜ˆå€¼ï¼Œå…¶ä»–äººæ— æ³•è¿›å…¥è¶…å¸‚ï¼ˆè¢«æµæ§ï¼‰ï¼Œå½“æœ‰äººç»“è´¦å‡ºè¶…å¸‚ï¼ˆæœåŠ¡å™¨å¤„ç†å®Œï¼‰æ‰èƒ½å…è®¸æ–°çš„é¡¾å®¢è¿›å…¥ï¼ˆæœåŠ¡å™¨å¤„ç†æ–°çš„çº¿ç¨‹è¯·æ±‚ï¼‰ã€‚ä¸‹é¢æ˜¯å®˜æ–¹è§£é‡Šï¼š

> å¹¶å‘æ•°æ§åˆ¶ç”¨äºä¿æŠ¤ä¸šåŠ¡çº¿ç¨‹æ± ä¸è¢«æ…¢è°ƒç”¨è€—å°½ã€‚ä¾‹å¦‚ï¼Œå½“åº”ç”¨æ‰€ä¾èµ–çš„ä¸‹æ¸¸åº”ç”¨ç”±äºæŸç§åŸå› å¯¼è‡´æœåŠ¡ä¸ç¨³å®šã€å“åº”å»¶è¿Ÿå¢åŠ ï¼Œå¯¹äºè°ƒç”¨è€…æ¥è¯´ï¼Œæ„å‘³ç€ååé‡ä¸‹é™å’Œæ›´å¤šçš„çº¿ç¨‹æ•°å ç”¨ï¼Œæç«¯æƒ…å†µä¸‹ç”šè‡³å¯¼è‡´çº¿ç¨‹æ± è€—å°½ã€‚ä¸ºåº”å¯¹å¤ªå¤šçº¿ç¨‹å ç”¨çš„æƒ…å†µï¼Œä¸šå†…æœ‰ä½¿ç”¨éš”ç¦»çš„æ–¹æ¡ˆï¼Œæ¯”å¦‚é€šè¿‡ä¸åŒä¸šåŠ¡é€»è¾‘ä½¿ç”¨ä¸åŒçº¿ç¨‹æ± æ¥éš”ç¦»ä¸šåŠ¡è‡ªèº«ä¹‹é—´çš„èµ„æºäº‰æŠ¢ï¼ˆçº¿ç¨‹æ± éš”ç¦»ï¼‰ã€‚è¿™ç§éš”ç¦»æ–¹æ¡ˆè™½ç„¶éš”ç¦»æ€§æ¯”è¾ƒå¥½ï¼Œä½†æ˜¯ä»£ä»·å°±æ˜¯çº¿ç¨‹æ•°ç›®å¤ªå¤šï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„ overhead æ¯”è¾ƒå¤§ï¼Œç‰¹åˆ«æ˜¯å¯¹ä½å»¶æ—¶çš„è°ƒç”¨æœ‰æ¯”è¾ƒå¤§çš„å½±å“ã€‚Sentinel å¹¶å‘æ§åˆ¶ä¸è´Ÿè´£åˆ›å»ºå’Œç®¡ç†çº¿ç¨‹æ± ï¼Œè€Œæ˜¯ç®€å•ç»Ÿè®¡å½“å‰è¯·æ±‚ä¸Šä¸‹æ–‡çš„çº¿ç¨‹æ•°ç›®ï¼ˆæ­£åœ¨æ‰§è¡Œçš„è°ƒç”¨æ•°ç›®ï¼‰ï¼Œå¦‚æœè¶…å‡ºé˜ˆå€¼ï¼Œæ–°çš„è¯·æ±‚ä¼šè¢«ç«‹å³æ‹’ç»ï¼Œæ•ˆæœç±»ä¼¼äºä¿¡å·é‡éš”ç¦»ã€‚**å¹¶å‘æ•°æ§åˆ¶é€šå¸¸åœ¨è°ƒç”¨ç«¯è¿›è¡Œé…ç½®ã€‚**

![image-20220501191559575](https://blog.caowei.xyz/blog/202205011915735.png)

2. è®¿é—®è¯¥æ¥å£ï¼Œå½“è®¿é—®é‡è¶…è¿‡è®¾å®šçš„ QPS é˜ˆå€¼æ—¶ï¼Œä¼šæ˜¾ç¤º Sentinel é»˜è®¤çš„å¼‚å¸¸æ¶ˆæ¯ğŸ‘‡ğŸ»ï¼š

![image-20220501191847860](https://blog.caowei.xyz/blog/202205011918933.png)

3. ä½¿ç”¨ `@SentinelResource` æ³¨è§£æ¥æŒ‡å®šæµæ§åçš„å¤„ç†æ–¹æ³•

```java
@GetMapping("/add")
@SentinelResource(value = "add", blockHandler = "addBlockHandler")
public String add(){
        ...
        }

public String addBlockHandler(BlockException e){
        return"è¯·æ±‚å·²è¢«æµæ§";
        }
```

> **æ³¨æ„ï¼šé…ç½®ä¹‹åä¼š Sentinel æ§åˆ¶å°ä¼šç”Ÿæˆå¯¹åº”èµ„æºï¼Œå¿…é¡»é’ˆå¯¹è¯¥èµ„æºè¿›è¡Œæµæ§ã€‚**

![image-20220501195614502](https://blog.caowei.xyz/blog/202205011956872.png)

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220501195726156](https://blog.caowei.xyz/blog/202205011957429.png)

4. ç»Ÿä¸€å¼‚å¸¸å¤„ç†

åœ¨ä¸Šé¢çš„ä»‹ç»ä¸­ï¼Œéœ€è¦ä¸ºæ¯ä¸ªæ¥å£æ·»åŠ  `@SentinelResource` æ³¨è§£æ¥æŒ‡å®šæµæ§å¤„ç†æ–¹æ³•ã€‚

å¦‚æœä¸æƒ³ä¸ºæ¯ä¸ªæ¥å£éƒ½æ·»åŠ æ³¨è§£ï¼Œå®ç°ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†ï¼Œå¯ä»¥é€šè¿‡è‡ªå®šä¹‰ç±»å®ç° `BlockExceptionHandler` æ¥å£æ¥å¤„ç†ï¼Œæ³¨æ„ç»™è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»åŠ ä¸Š ` @Component` æ³¨è§£ã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å¼‚å¸¸å¤„ç†ç±»è¿”å› JSON ä¿¡æ¯çš„ä¾‹å­ï¼š

```java

@Component
public class MyBlockExceptionHandler implements BlockExceptionHandler {
    Logger log = LoggerFactory.getLogger(this.getClass());

    @Override
    public void handle(HttpServletRequest httpServletRequest, HttpServletResponse response, BlockException e) throws Exception {
        // getRule()ï¼šè¿”å›èµ„æºè§„åˆ™çš„è¯¦ç»†ä¿¡æ¯
        log.info("BlockExceptionHandler BlockException================" + e.getRule());

        Result r = null;

        if (e instanceof FlowException) {
            r = Result.error(100, "æ¥å£é™æµäº†");

        } else if (e instanceof DegradeException) {
            r = Result.error(101, "æœåŠ¡é™çº§äº†");

        } else if (e instanceof ParamFlowException) {
            r = Result.error(102, "çƒ­ç‚¹å‚æ•°é™æµäº†");

        } else if (e instanceof SystemBlockException) {
            r = Result.error(103, "è§¦å‘ç³»ç»Ÿä¿æŠ¤è§„åˆ™äº†");

        } else if (e instanceof AuthorityException) {
            r = Result.error(104, "æˆæƒè§„åˆ™ä¸é€šè¿‡");
        }

        //è¿”å›jsonæ•°æ®
        response.setStatus(500);
        response.setCharacterEncoding("utf-8");
        response.setContentType(MediaType.APPLICATION_JSON_VALUE);
        new ObjectMapper().writeValue(response.getWriter(), r);
    }
}
```

ç”±äºæ²¡æœ‰ä½¿ç”¨æ³¨è§£è®¾ç½®èµ„æºï¼Œé’ˆå¯¹æ¥å£è®¾ç½®æµæ§è§„åˆ™å³å¯ã€‚

![image-20220501215938613](https://blog.caowei.xyz/blog/202205012159872.png)

æ•ˆæœå¦‚ä¸‹ï¼š

![image-20220501220628965](https://blog.caowei.xyz/blog/202205012206284.png)

#### 5.2 æµæ§æ¨¡å¼

Sentinel æä¾›äº†ç›´æ¥ã€å…³è”ã€é“¾è·¯ä¸‰ç§æµæ§æ¨¡å¼ã€‚

1. ç›´æ¥æ¨¡å¼ï¼ˆé»˜è®¤ï¼‰ï¼šå½“æµé‡è¶…å‡ºæŒ‡å®šçš„é˜ˆå€¼ï¼Œå—å½±å“é™åˆ¶çš„èµ„æºåªæœ‰å®ƒæœ¬èº«ã€‚åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ç›´æ¥æ¨¡å¼ï¼Œä¸å†èµ˜è¿°ã€‚

2. å…³è”æ¨¡å¼ï¼šå½“å…³è”çš„èµ„æºè¶…å‡ºé˜ˆå€¼ä¹‹åï¼Œå—å½±å“çš„æ˜¯è®¾ç½®çš„èµ„æºã€‚

ç”¨å®é™…åœºæ™¯ä¸¾ä¾‹å­ï¼ŒåŒ 11 å¤§ä¿ƒï¼Œå½“è®¢å•åˆ›å»ºæ¥å£ï¼ˆå†™æ•°æ®ï¼‰æµé‡è¾¾åˆ°é˜ˆå€¼åï¼Œé™åˆ¶è®¢å•çš„æŸ¥è¯¢ï¼ˆè¯»æ•°æ®ï¼‰ï¼Œä»¥æ­¤ä¿è¯ç”¨æˆ·æ­£å¸¸ä¸‹å•ã€‚

> å½“ä¸¤ä¸ªèµ„æºä¹‹é—´å…·æœ‰èµ„æºäº‰æŠ¢æˆ–è€…ä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªèµ„æºä¾¿å…·æœ‰äº†å…³è”ã€‚æ¯”å¦‚å¯¹æ•°æ®åº“åŒä¸€ä¸ªå­—æ®µçš„è¯»æ“ä½œå’Œå†™ æ“ä½œå­˜åœ¨äº‰æŠ¢ï¼Œè¯»çš„é€Ÿåº¦è¿‡é«˜ä¼šå½±å“å†™å¾—é€Ÿåº¦ï¼Œå†™çš„é€Ÿåº¦è¿‡é«˜ä¼šå½±å“è¯»çš„é€Ÿåº¦ã€‚å¦‚æœæ”¾ä»»è¯»å†™æ“ä½œäº‰æŠ¢èµ„æºï¼Œåˆ™äº‰æŠ¢æœ¬ èº«å¸¦æ¥çš„å¼€é”€ä¼šé™ä½æ•´ä½“çš„ååé‡ã€‚å¯ä½¿ç”¨å…³è”é™æµæ¥é¿å…å…·æœ‰å…³è”å…³ç³»çš„èµ„æºä¹‹é—´è¿‡åº¦çš„äº‰æŠ¢ï¼Œä¸¾ä¾‹æ¥è¯´ï¼Œread_db å’Œ write_db è¿™ä¸¤ä¸ªèµ„æºåˆ†åˆ«ä»£è¡¨æ•°æ®åº“è¯»å†™ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ read_db è®¾ç½®é™æµè§„åˆ™æ¥è¾¾åˆ°å†™ä¼˜å…ˆçš„ç›®çš„:è®¾ç½® strategy ä¸º RuleConstant.STRATEGY_RELATE åŒæ—¶è®¾ç½® refResource ä¸º write_dbã€‚è¿™æ ·å½“å†™åº“æ“ä½œè¿‡äºé¢‘ç¹æ—¶ï¼Œè¯»æ•°æ®çš„è¯·æ±‚ä¼šè¢«é™æµã€‚

![image-20220501224554383](https://blog.caowei.xyz/blog/202205012245607.png)

3. é“¾è·¯æ¨¡å¼ï¼šåªæ ¹æ®æŸä¸ªå…¥å£çš„ç»Ÿè®¡ä¿¡æ¯å¯¹èµ„æºé™æµã€‚

ç”¨å®é™…åœºæ™¯ä¸¾ä¾‹å­ï¼Œæ¸¸ä¹å›­æ¸¸ç©é¡¹ç›®ï¼ˆèµ„æºï¼‰æœ‰ä¸¤ç§å…¥å£é€šé“ï¼ˆæ¥å£ï¼‰ï¼Œæ™®é€šæ¸¸å®¢é€šé“ ä¸ VIP é€šé“ã€‚æ™®é€šæ¸¸å®¢é€šé“è¾¾åˆ°é˜ˆå€¼ä¼šè¢«é™æµï¼Œè€Œ VIP åˆ™ä¸ä¼šã€‚

> æ³¨æ„ï¼šä½¿ç”¨æ­¤æ¨¡å¼éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­è¿›è¡Œé…ç½®ğŸ‘‡ğŸ»æ¥é˜²æ­¢**é»˜è®¤å°†è°ƒç”¨é“¾è·¯æ”¶æ•›**

```properties
spring.cloud.sentinel.webâ€contextâ€unify=false
```

ä¸¾ä¸ªä¾‹å­ï¼Œç°åœ¨æœ‰ä¸¤ä¸ªæ¥å£éƒ½åœ¨è®¿é—® user è¿™ä¸ªèµ„æºï¼š

```java
@GetMapping("/getUser1")
public String test1(){
        return orderService.getUser();
        }

@GetMapping("/getUser2")
public String test2(){
        return orderService.getUser();
        }
```

```java

@Service
public class OrderService implements IOrderService {
    @SentinelResource(value = "user", blockHandler = "blockHandlerGetUser")
    @Override
    public String getUser() {
        return "æŸ¥è¯¢ç”¨æˆ·";
    }

    public String blockHandlerGetUser(BlockException e) {
        return "æµæ§æŸ¥è¯¢ç”¨æˆ·";
    }
}
```

ç°åœ¨é’ˆå¯¹ user è¿™ä¸ªèµ„æºé…ç½®é“¾è·¯å…³è”æ¨¡å¼ï¼Œä»»é€‰ä¸€ä¸ªå³å¯ï¼š

![image-20220502092855254](https://blog.caowei.xyz/blog/202205020928505.png)

![image-20220502093903602](https://blog.caowei.xyz/blog/202205020939749.png)

ä¸Šé¢çš„é…ç½®è¡¨ç¤ºï¼Œä» `/getUser1` æ¥å£è®¿é—® user èµ„æºè¾¾åˆ°é˜ˆå€¼æ—¶ä¼šè¢«æµæ§ï¼Œè€Œä» `/getUser2` è®¿é—®æ²¡æœ‰ä»»ä½•å½±å“ã€‚

![image-20220502094601817](https://blog.caowei.xyz/blog/202205020946956.png)

> **å†æ¬¡æé†’ï¼Œä½¿ç”¨æ­¤æ¨¡å¼è¯·åŠ¡å¿…æ·»åŠ ä»¥ä¸‹é…ç½®ğŸ‘‡ğŸ»ï¼Œå¦åˆ™ä¸ç”Ÿæ•ˆï¼**

```properties
spring.cloud.sentinel.webâ€contextâ€unify=false
```

#### 5.3 æµæ§æ•ˆæœ

**æµæ§æ•ˆæœåªé’ˆå¯¹ QPS è§„åˆ™ã€‚**

Sentinel æä¾›äº†ä¸‰ç§æµæ§æ•ˆæœï¼š

+ å¿«é€Ÿå¤±è´¥ï¼ˆé»˜è®¤ï¼‰ï¼šå½“ QPS è¶…è¿‡ä»»æ„è§„åˆ™çš„é˜ˆå€¼åï¼Œæ–°çš„è¯·æ±‚å°±ä¼šè¢«**ç«‹å³æ‹’ç»**ï¼Œæ‹’ç»æ–¹å¼ä¸ºæŠ›å‡º `FlowException` ã€‚è¿™ç§æ–¹å¼é€‚ç”¨äº**å¯¹ç³»ç»Ÿå¤„ç†èƒ½åŠ›ç¡®åˆ‡å·²çŸ¥**çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚é€šè¿‡å‹æµ‹ç¡®å®šäº†ç³»ç»Ÿçš„å‡†ç¡®æ°´ä½æ—¶ã€‚
+ Warm upï¼šå³é¢„çƒ­/å†·å¯åŠ¨æ–¹å¼ã€‚å½“ç³»ç»Ÿé•¿æœŸå¤„äºä½æ°´ä½çš„æƒ…å†µä¸‹ï¼Œå½“æµé‡çªç„¶å¢åŠ æ—¶ï¼Œç›´æ¥æŠŠç³»ç»Ÿæ‹‰å‡åˆ°é«˜æ°´ä½å¯èƒ½ç¬é—´æŠŠç³»ç»Ÿå‹å®ã€‚é€šè¿‡"å†·å¯åŠ¨"ï¼Œè®©é€šè¿‡çš„æµé‡ç¼“æ…¢å¢åŠ ï¼Œåœ¨ä¸€å®šæ—¶é—´å†…**é€æ¸å¢åŠ åˆ°é˜ˆå€¼ä¸Šé™**
  ï¼Œç»™å†·ç³»ç»Ÿä¸€ä¸ªé¢„çƒ­çš„æ—¶é—´ï¼Œé¿å…å†·ç³»ç»Ÿè¢«å‹å®ã€‚**é€‚ç”¨äºæ¿€å¢æµé‡**ã€‚

> å½“æµé‡çªç„¶å¢å¤§çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šå¸Œæœ›ç³»ç»Ÿä»ç©ºé—²çŠ¶æ€åˆ°ç¹å¿™çŠ¶æ€çš„åˆ‡æ¢çš„æ—¶é—´é•¿ä¸€äº›ã€‚å³å¦‚æœç³»ç»Ÿåœ¨æ­¤ä¹‹å‰é•¿æœŸå¤„äºç©ºé—²çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›å¤„ç†è¯·æ±‚çš„æ•°é‡æ˜¯ç¼“æ­¥çš„å¢å¤šï¼Œç»è¿‡é¢„æœŸçš„æ—¶é—´ä»¥åï¼Œåˆ°è¾¾ç³»ç»Ÿå¤„ç†è¯·æ±‚ä¸ªæ•°çš„æœ€å¤§å€¼ã€‚Warm Upï¼ˆå†·å¯åŠ¨ï¼Œé¢„çƒ­ï¼‰æ¨¡å¼å°±æ˜¯ä¸ºäº†å®ç°è¿™ä¸ªç›®çš„çš„ã€‚
>
> è¿™ä¸ªåœºæ™¯ä¸»è¦ç”¨äºå¯åŠ¨éœ€è¦é¢å¤–å¼€é”€çš„åœºæ™¯ï¼Œä¾‹å¦‚å»ºç«‹æ•°æ®åº“è¿æ¥ç­‰ã€‚
>
> æ¥æºï¼šğŸ‘‰ğŸ»[å®˜æ–¹æ–‡æ¡£ï¼šé™æµ-å†·å¯åŠ¨](https://github.com/alibaba/Sentinel/wiki/é™æµ---å†·å¯åŠ¨)

+ æ’é˜Ÿç­‰å¾…ï¼šä¸¥æ ¼æ§åˆ¶è¯·æ±‚é€šè¿‡çš„é—´éš”æ—¶é—´ï¼Œä¹Ÿå³æ˜¯è®©**è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡**ï¼Œå¯¹åº”çš„æ˜¯æ¼æ¡¶ç®—æ³•ã€‚**é€‚ç”¨äºè„‰å†²æµé‡**ã€‚

è¿™ç§æ–¹å¼ä¸»è¦ç”¨äºå¤„ç†**é—´éš”æ€§çªå‘**çš„æµé‡ï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—ã€‚æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼Œåœ¨æŸä¸€ç§’æœ‰å¤§é‡çš„è¯·æ±‚åˆ°æ¥ï¼Œè€Œæ¥ä¸‹æ¥çš„å‡ ç§’åˆ™å¤„äºç©ºé—²çŠ¶æ€ï¼Œæˆ‘ä»¬å¸Œæœ›ç³»ç»Ÿèƒ½å¤Ÿåœ¨æ¥ä¸‹æ¥çš„ç©ºé—²æœŸé—´é€æ¸å¤„ç†è¿™äº›è¯·æ±‚ï¼Œè€Œä¸æ˜¯åœ¨ç¬¬ä¸€ç§’ç›´æ¥æ‹’ç»å¤šä½™çš„è¯·æ±‚ã€‚

> æ³¨æ„ï¼šåŒ€é€Ÿæ’é˜Ÿæ¨¡å¼æš‚æ—¶ä¸æ”¯æŒ QPS > 1000 çš„åœºæ™¯ã€‚

#### 5.4 çƒ­ç‚¹å‚æ•°æµæ§

çƒ­ç‚¹å³ç»å¸¸è®¿é—®çš„æ•°æ®ã€‚å¾ˆå¤šæ—¶å€™æˆ‘ä»¬å¸Œæœ›ç»Ÿè®¡æŸä¸ªçƒ­ç‚¹æ•°æ®ä¸­è®¿é—®é¢‘æ¬¡æœ€é«˜çš„ Top K æ•°æ®ï¼Œå¹¶å¯¹å…¶è®¿é—®è¿›è¡Œé™åˆ¶ã€‚

æ¯”å¦‚ï¼š

- å•†å“ ID ä¸ºå‚æ•°ï¼Œç»Ÿè®¡ä¸€æ®µæ—¶é—´å†…æœ€å¸¸è´­ä¹°çš„å•†å“ ID å¹¶è¿›è¡Œé™åˆ¶
- ç”¨æˆ· ID ä¸ºå‚æ•°ï¼Œé’ˆå¯¹ä¸€æ®µæ—¶é—´å†…é¢‘ç¹è®¿é—®çš„ç”¨æˆ· ID è¿›è¡Œé™åˆ¶

çƒ­ç‚¹å‚æ•°é™æµä¼šç»Ÿè®¡ä¼ å…¥å‚æ•°ä¸­çš„çƒ­ç‚¹å‚æ•°ï¼Œå¹¶æ ¹æ®é…ç½®çš„é™æµé˜ˆå€¼ä¸æ¨¡å¼ï¼Œå¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨è¿›è¡Œé™æµã€‚çƒ­ç‚¹å‚æ•°é™æµå¯ä»¥çœ‹åšæ˜¯ä¸€ç§ç‰¹æ®Šçš„æµé‡æ§åˆ¶ï¼Œ**ä»…å¯¹åŒ…å«çƒ­ç‚¹å‚æ•°çš„èµ„æºè°ƒç”¨ç”Ÿæ•ˆ**ã€‚

1. é…ç½®é¡¹è¯´æ˜

![image-20220502190544394](https://blog.caowei.xyz/blog/202205021905652.png)

+ å‚æ•°ç´¢å¼•ï¼šå‚æ•°åœ¨æ¥å£ä¸­çš„ä½ç½®é¡ºåºï¼Œä» 0 å¼€å§‹ã€‚
+ å•æœºé˜ˆå€¼ï¼šé’ˆå¯¹**æ‰€æœ‰**å‚æ•°çš„é˜ˆå€¼ã€‚
+ ç»Ÿè®¡çª—å£æ—¶é•¿ï¼šæ¯æ¬¡ç»Ÿè®¡çš„å•ä½æ—¶é—´ã€‚
+ å‚æ•°ä¾‹å¤–é¡¹ï¼šæŒ‡å®š**æŸä¸ªå…·ä½“**å‚æ•°çš„é˜ˆå€¼ï¼Œå¯æ·»åŠ å¤šä¸ªã€‚

2. ä½¿ç”¨ï¼ˆä»¥ id å‚æ•°å€¼ä¸º 1 ä½œä¸ºçƒ­ç‚¹å‚æ•°ï¼‰

> æ³¨æ„ï¼šå¿…é¡»é…åˆ `@SentinelResource` æ³¨è§£æ¥ä½¿ç”¨

```java
@RequestMapping("/get/{id}")
@SentinelResource(value = "getById", blockHandler = "HotBlockHandler")
public String getById(@PathVariable("id") Integer id)throws InterruptedException{
        System.out.println("æ­£å¸¸è®¿é—®");
        return"æ­£å¸¸è®¿é—®";
        }

public String HotBlockHandler(@PathVariable("id") Integer id,BlockException e)throws InterruptedException{
        return"çƒ­ç‚¹å¼‚å¸¸å¤„ç†";
        }
```

![image-20220502191222307](https://blog.caowei.xyz/blog/202205021912489.png)

#### 5.5 ç³»ç»Ÿä¿æŠ¤è§„åˆ™æµæ§

Sentinel ç³»ç»Ÿè‡ªé€‚åº”é™æµä»æ•´ä½“ç»´åº¦å¯¹åº”ç”¨å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œç»“åˆåº”ç”¨çš„ Loadã€CPU ä½¿ç”¨ç‡ã€æ€»ä½“å¹³å‡ RTã€å…¥å£ QPS
å’Œå¹¶å‘çº¿ç¨‹æ•°ç­‰å‡ ä¸ªç»´åº¦çš„ç›‘æ§æŒ‡æ ‡ï¼Œé€šè¿‡è‡ªé€‚åº”çš„æµæ§ç­–ç•¥ï¼Œè®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚

ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯åº”ç”¨æ•´ä½“ç»´åº¦çš„ï¼Œè€Œä¸æ˜¯èµ„æºç»´åº¦çš„ï¼Œå¹¶ä¸”**ä»…å¯¹å…¥å£æµé‡ç”Ÿæ•ˆ**ã€‚

![image-20220502191902937](https://blog.caowei.xyz/blog/202205021919124.png)

é…ç½®é¡¹è¯´æ˜ï¼š

- **Load è‡ªé€‚åº”**ï¼ˆä»…å¯¹ Linux/Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰ï¼šç³»ç»Ÿçš„ load1 ä½œä¸ºå¯å‘æŒ‡æ ‡ï¼Œè¿›è¡Œè‡ªé€‚åº”ç³»ç»Ÿä¿æŠ¤ã€‚å½“ç³»ç»Ÿ load1 è¶…è¿‡è®¾å®šçš„å¯å‘å€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ä¼°ç®—çš„ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆBBR
  é˜¶æ®µï¼‰ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ `maxQps * minRt` ä¼°ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ `CPU cores * 2.5`ã€‚
- **CPU usage**ï¼šå½“ç³»ç»Ÿ CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼ˆå–å€¼èŒƒå›´ 0.0-1.0ï¼‰ï¼Œæ¯”è¾ƒçµæ•ã€‚
- **å¹³å‡ RT**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚
- **å¹¶å‘çº¿ç¨‹æ•°**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚
- **å…¥å£ QPS**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚

### 6.ã€Œ Sentinel ç†”æ–­é™çº§ ã€

> ç°ä»£å¾®æœåŠ¡æ¶æ„éƒ½æ˜¯åˆ†å¸ƒå¼çš„ï¼Œç”±éå¸¸å¤šçš„æœåŠ¡ç»„æˆã€‚ä¸åŒæœåŠ¡ä¹‹é—´ç›¸äº’è°ƒç”¨ï¼Œç»„æˆå¤æ‚çš„è°ƒç”¨é“¾è·¯ã€‚ä»¥ä¸Šçš„é—®é¢˜åœ¨é“¾è·¯è°ƒç”¨ä¸­ä¼šäº§ç”Ÿæ”¾å¤§çš„æ•ˆæœã€‚å¤æ‚é“¾è·¯ä¸Šçš„æŸä¸€ç¯ä¸ç¨³å®šï¼Œå°±å¯èƒ½ä¼šå±‚å±‚çº§è”ï¼Œæœ€ç»ˆå¯¼è‡´æ•´ä¸ªé“¾è·¯éƒ½ä¸å¯ç”¨ã€‚å› æ­¤æˆ‘ä»¬éœ€è¦å¯¹ä¸ç¨³å®šçš„**å¼±ä¾èµ–æœåŠ¡è°ƒç”¨**è¿›è¡Œç†”æ–­é™çº§ï¼Œæš‚æ—¶åˆ‡æ–­ä¸ç¨³å®šè°ƒç”¨ï¼Œé¿å…å±€éƒ¨ä¸ç¨³å®šå› ç´ å¯¼è‡´æ•´ä½“çš„é›ªå´©ã€‚
>
> æ¥æºï¼šğŸ‘‰ğŸ»[å®˜æ–¹æ–‡æ¡£ï¼šç†”æ–­é™çº§](https://github.com/alibaba/Sentinel/wiki/ç†”æ–­é™çº§)

ç†”æ–­é™çº§ä½œä¸ºä¿æŠ¤è‡ªèº«çš„æ‰‹æ®µï¼Œé€šå¸¸åœ¨å®¢æˆ·ç«¯ï¼ˆ**è°ƒç”¨ç«¯**ï¼‰è¿›è¡Œé…ç½®ã€‚

è§¦å‘ç†”æ–­åå¯é‡‡å–çš„æªæ–½ï¼š

+ æä¾› fallback å®ç°ï¼ˆæœåŠ¡é™çº§ï¼‰
+ è¿”å›é”™è¯¯ç»“æœ
+ è¯»å–ç¼“å­˜æ•°æ®ï¼ˆDBè®¿é—®é™çº§ï¼‰

#### 6.1 ç†”æ–­é™çº§ç­–ç•¥

Sentinel æä¾›äº†ä¸‰ç§ç†”æ–­é™çº§ç­–ç•¥ï¼š

+ æ…¢è°ƒç”¨æ¯”ä¾‹
+ å¼‚å¸¸æ¯”ä¾‹
+ å¼‚å¸¸æ•°

1. **æ…¢è°ƒç”¨æ¯”ä¾‹**

é€‰æ‹©ä»¥æ…¢è°ƒç”¨æ¯”ä¾‹ä½œä¸ºé˜ˆå€¼ï¼Œéœ€è¦è®¾ç½®å…è®¸çš„æ…¢è°ƒç”¨
RTï¼ˆå³æœ€å¤§çš„å“åº”æ—¶é—´ï¼‰ï¼Œè¯·æ±‚çš„å“åº”æ—¶é—´å¤§äºè¯¥å€¼åˆ™ç»Ÿè®¡ä¸ºæ…¢è°ƒç”¨ã€‚å½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”æ…¢è°ƒç”¨çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN
çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„ä¸€ä¸ªè¯·æ±‚å“åº”æ—¶é—´å°äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ç»“æŸç†”æ–­ï¼Œè‹¥å¤§äºè®¾ç½®çš„æ…¢è°ƒç”¨ RT åˆ™ä¼šå†æ¬¡è¢«ç†”æ–­ã€‚

![image-20220502154256820](https://blog.caowei.xyz/blog/202205021542984.png)

é…ç½®é¡¹è¯´æ˜ï¼š

+ æœ€å¤§ RTï¼šæœ€å¤§çš„å“åº”æ—¶é—´ã€‚è¯·æ±‚çš„å“åº”æ—¶é—´å¤§äºè¯¥å€¼åˆ™ç»Ÿè®¡ä¸ºæ…¢è°ƒç”¨ï¼Œå•ä½ä¸º msã€‚
+ æ¯”ä¾‹é˜ˆå€¼ï¼šç»Ÿè®¡æ—¶é•¿å†…ï¼Œæ…¢è°ƒç”¨å æ€»è¯·æ±‚çš„æ¯”ä¾‹é˜ˆå€¼ã€‚
+ ç†”æ–­æ—¶é•¿ï¼šç†”æ–­çŠ¶æ€çš„æŒç»­æ—¶é—´ï¼Œæ—¶é—´ç»“æŸä¹‹åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆåŠå¼€çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„**ä¸€ä¸ª**è¯·æ±‚å“åº”æ—¶é—´å°äºè®¾ç½®çš„ RT åˆ™ç»“æŸç†”æ–­ï¼Œè‹¥å¤§äºè®¾ç½®çš„ RT åˆ™ä¼š**å†æ¬¡è¢«ç†”æ–­**ã€‚
+ æœ€å°è¯·æ±‚æ•°ï¼šç»Ÿè®¡æ—¶é•¿å†…ï¼Œè¯·æ±‚æ•°é‡çš„é˜ˆå€¼ã€‚

æœ€å¤§ RT å¯ä»¥åˆ’åˆ†ä»€ä¹ˆæ ·çš„è¯·æ±‚ç®—æ…¢è°ƒç”¨ã€‚å½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…ï¼Œè¯·æ±‚æ•°ç›®å¤§äºæœ€å°è¯·æ±‚æ•°ç›®ï¼Œ**ä¸”**æ…¢è°ƒç”¨çš„æ¯”ä¾‹å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚

2. **å¼‚å¸¸æ¯”ä¾‹**

å½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…è¯·æ±‚æ•°ç›®å¤§äºè®¾ç½®çš„æœ€å°è¯·æ±‚æ•°ç›®ï¼Œå¹¶ä¸”**å¼‚å¸¸çš„æ¯”ä¾‹**å¤§äºé˜ˆå€¼ï¼Œåˆ™æ¥ä¸‹æ¥çš„ç†”æ–­æ—¶é•¿å†…è¯·æ±‚ä¼šè‡ªåŠ¨è¢«ç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„**ä¸€ä¸ª**
è¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼š**å†æ¬¡è¢«ç†”æ–­**ã€‚

![image-20220502160524226](https://blog.caowei.xyz/blog/202205021605586.png)

é…ç½®é¡¹è¯´æ˜ï¼š

+ æ¯”ä¾‹é˜ˆå€¼ï¼šç»Ÿè®¡æ—¶é•¿å†…ï¼Œå¼‚å¸¸è¯·æ±‚æ•°å æ€»è¯·æ±‚æ•°çš„æ¯”ä¾‹ã€‚

3. **å¼‚å¸¸æ•°**

å½“å•ä½ç»Ÿè®¡æ—¶é•¿å†…çš„**å¼‚å¸¸æ•°ç›®**è¶…è¿‡é˜ˆå€¼ä¹‹åä¼šè‡ªåŠ¨è¿›è¡Œç†”æ–­ã€‚ç»è¿‡ç†”æ–­æ—¶é•¿åç†”æ–­å™¨ä¼šè¿›å…¥æ¢æµ‹æ¢å¤çŠ¶æ€ï¼ˆHALF-OPEN çŠ¶æ€ï¼‰ï¼Œè‹¥æ¥ä¸‹æ¥çš„**ä¸€ä¸ª**è¯·æ±‚æˆåŠŸå®Œæˆï¼ˆæ²¡æœ‰é”™è¯¯ï¼‰åˆ™ç»“æŸç†”æ–­ï¼Œå¦åˆ™ä¼š**å†æ¬¡è¢«ç†”æ–­**ã€‚

> æ³¨æ„:å¼‚å¸¸é™çº§ä»…é’ˆå¯¹ä¸šåŠ¡å¼‚å¸¸ï¼Œå¯¹ Sentinel é™æµé™çº§çš„å¼‚å¸¸ï¼ˆBlockExceptionï¼‰ä¸ç”Ÿæ•ˆã€‚

![image-20220502161119026](https://blog.caowei.xyz/blog/202205021611131.png)

#### 6.2 æ•´åˆ OpenFeign é™çº§

1. é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  Feign å¯¹ Sentinel çš„æ”¯æŒ

```properties
feign.sentinel.enabled=true
```

2. è‡ªå®šä¹‰ç±»å®ç° OpenFeign çš„æ¥å£ï¼Œæ³¨æ„åŠ ä¸Š `@Component` æ³¨è§£

```java

@Component
public class StockFeignServiceFallback implements StockFeignService {
    @Override
    public String reduct() {
        return "æ¥å£è®¿é—®è¢«é™çº§äº†";
    }
}
```

3. åœ¨æ¥å£çš„ OpenFeign æ³¨è§£ä¸Šï¼Œä½¿ç”¨ `fallback` å±æ€§æŒ‡å®šè¯¥ç±»

```java

@FeignClient(name = "stock-service", path = "/stock", fallback = StockFeignServiceFallback.class)
public interface StockFeignService {
    @GetMapping("/reduct")
    String reduct();
}
```

**æµ‹è¯•ï¼š**

åœ¨è°ƒç”¨çš„æ–¹æ³•ä¸­åˆ¶é€ å¼‚å¸¸è§¦å‘é™çº§ï¼š

```java
@GetMapping("/reduct")
public String reduct(){
        ...
        // åˆ¶é€ å¼‚å¸¸è§¦å‘é™çº§
        int i=2/0;
        ...
        }
```

![image-20220502171904993](https://blog.caowei.xyz/blog/202205021719221.png)

### 7.ã€Œ Sentinel è§„åˆ™æŒä¹…åŒ– ã€

Sentinel å¯¹è§„åˆ™çš„æ¨é€æä¾›äº†ä»¥ä¸‹ä¸‰ç§æ¨¡å¼ï¼š

+ åŸå§‹æ¨¡å¼ï¼šAPI å°†è§„åˆ™æ¨é€è‡³å®¢æˆ·ç«¯å¹¶ç›´æ¥æ›´æ–°åˆ°å†…å­˜ä¸­ï¼Œæ‰©å±•å†™æ•°æ®æºã€‚è§„åˆ™ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œé‡å¯å³æ¶ˆå¤±ã€‚
+ Pull æ¨¡å¼ï¼šæ‰©å±•å†™æ•°æ®æºï¼Œå®¢æˆ·ç«¯ä¸»åŠ¨å‘æŸä¸ªè§„åˆ™ç®¡ç†ä¸­å¿ƒå®šæœŸè½®è¯¢æ‹‰å–è§„åˆ™ï¼Œè¿™ä¸ªè§„åˆ™ä¸­å¿ƒå¯ä»¥æ˜¯ RDBMSã€æ–‡ä»¶ç­‰ã€‚ä¸ä¿è¯ä¸€è‡´æ€§ã€å®æ—¶æ€§ã€‚
+ **Push æ¨¡å¼**ï¼ˆæ¨èï¼‰ï¼šæ‰©å±•è¯»æ•°æ®æºï¼Œè§„åˆ™ä¸­å¿ƒç»Ÿä¸€æ¨é€ï¼Œå®¢æˆ·ç«¯é€šè¿‡æ³¨å†Œç›‘å¬å™¨çš„æ–¹å¼æ—¶åˆ»ç›‘å¬å˜åŒ–ï¼Œæ¯”å¦‚ä½¿ç”¨ Nacosã€Zookeeper ç­‰é…ç½®ä¸­å¿ƒã€‚è¿™ç§æ–¹å¼æœ‰æ›´å¥½çš„å®æ—¶æ€§å’Œä¸€è‡´æ€§ä¿è¯ã€‚**ç”Ÿäº§ç¯å¢ƒä¸‹ä¸€èˆ¬é‡‡ç”¨ Push
  æ¨¡å¼çš„æ•°æ®æºã€‚æ¨é€æµç¨‹ï¼šé…ç½®ä¸­å¿ƒæ§åˆ¶å°/Sentinel æ§åˆ¶å° â†’ é…ç½®ä¸­å¿ƒ â†’ Sentinel æ•°æ®æº â†’ Sentinelã€‚**

#### åŸºäº Nacos é…ç½®ä¸­å¿ƒæ§åˆ¶å°å®ç°æ¨é€

1. æ·»åŠ ä¾èµ–

```xml

<dependency>
    <groupId>com.alibaba.csp</groupId>
    <artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

2. åœ¨ Nacos é…ç½®ä¸­å¿ƒåˆ›å»ºé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®å†…å®¹ï¼š

![image-20220502201444074](https://blog.caowei.xyz/blog/202205022014278.png)

```json
[
  {
    "resource": "/order/add", // èµ„æºå
    "controlBehavior": 0, // æµæ§æ•ˆæœ
    "count": 2, // é˜ˆå€¼
    "grade": 1, // é˜ˆå€¼ç±»å‹
    "limitApp": "default", // é’ˆå¯¹æ¥æº
    "strategy": 0 // æµæ§æ¨¡å¼
  }
]
```

JSON å¯é…ç½®é¡¹ä»¥åŠå…¶å‚æ•°å«ä¹‰å¯åœ¨ğŸ‘‰ğŸ»[Sentinel è§„åˆ™ç§ç±»](https://github.com/alibaba/Sentinel/wiki/å¦‚ä½•ä½¿ç”¨#è§„åˆ™çš„ç§ç±»)æŸ¥çœ‹

æ˜¾ç„¶ï¼Œè¿™ç§é…ç½®æ–¹å¼å­˜åœ¨ç¼ºé™·ï¼Œä½¿ç”¨ JSON é…ç½®éœ€è¦è®°ä½ä¸åŒçš„å‚æ•°åŠå…¶å«ä¹‰ã€‚ä¸è¿‡ Sentinel æœ¬æ¥å°±æ˜¯å¼€æºæ¡†æ¶ï¼Œæä¾›äº†ç›¸åº”çš„æ¥å£ç»™æˆ‘ä»¬å»åšäºŒæ¬¡å¼€å‘å®ç°å¯¹åº”çš„éœ€æ±‚ã€‚

3. åœ¨é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `Sentinel` æ•°æ®æºé…ç½®ï¼š

```yaml
spring:
  cloud:
    sentinel:
      datasource:
        flow-rule: # è¿™ä¸ªåå­—å¯ä»¥è‡ªå®šä¹‰
          nacos:
            server-addr: 127.0.0.1:8850 # Nacos Server åœ°å€
            username: nacos # Nacos Server ç”¨æˆ·åå¯†ç 
            password: nacos
            dataId: order-service-sentinal-config # Nacos ä¸­åˆ›å»ºé…ç½®æ–‡ä»¶çš„ data id
            dataType: json # é…ç½®æ–‡ä»¶çš„ç±»å‹ï¼ˆé»˜è®¤æ˜¯ jsonï¼‰
            rule-type: flow # æŒ‡æ˜æ˜¯é‚£ç§è§„åˆ™ï¼ˆå¦‚æµæ§ã€é™çº§ã€çƒ­ç‚¹å‚æ•°ç­‰ï¼‰çš„é…ç½®ä¿¡æ¯
            # æ­¤å¤–è¿˜å¯ä»¥è®¾ç½® namespaceã€group ç­‰
```

4. é‡æ–°å¯åŠ¨å¾®æœåŠ¡ä¾¿å¯ä»¥åœ¨ Sentinel æ§åˆ¶å°çœ‹åˆ°æˆ‘ä»¬æ·»åŠ çš„ç›¸å…³é…ç½®ä¿¡æ¯ï¼š

![image-20220502203319042](https://blog.caowei.xyz/blog/202205022033209.png)

> **æ³¨æ„ï¼šåœ¨ Sentinel æ§åˆ¶å°ä¸Šå¯¹è§„åˆ™çš„åˆ›å»ºæˆ–ä¿®æ”¹ä¸ä¼šåŒæ­¥åˆ° Nacos é…ç½®æ–‡ä»¶ä¸­ï¼**
>
> å¦‚æœæƒ³å®ç°è¿™ç§éœ€æ±‚ï¼Œéœ€è¦å¯¹ Sentinel è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

### 8. æ€»ç»“

Sentinel æ˜¯ä¸€æ¬¾éå¸¸å¼ºå¤§çš„æµæ§é™çº§æ¡†æ¶ï¼Œæä¾›äº†ä¸°å¯Œçš„æµæ§é™çº§ç­–ç•¥ï¼Œæ­é…æ§åˆ¶å°ç•Œé¢ä½¿å…¶ä½¿ç”¨æ›´åŠ ç®€å•ä¾¿æ·ã€‚å½“ç„¶å®ƒä¹Ÿå­˜åœ¨ä¸€äº›ä¸å®Œå–„çš„åœ°æ–¹ï¼Œæ¯”å¦‚ Sentinel æ§åˆ¶å°å¯¹é…ç½®è§„åˆ™çš„ä¿®æ”¹æ— æ³•ä¸ Nacos
é…ç½®ä¸­å¿ƒåŒæ­¥ç­‰ç­‰ï¼Œåœ¨ç”Ÿäº§è¿‡ç¨‹ä¸­ä½¿ç”¨æ—¶å¾€å¾€éœ€è¦å¯¹å…¶è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚å½“ç„¶é˜¿é‡Œä¹Ÿæä¾›äº† Sentinel çš„äº‘ä¸Šè¿›é˜¶ç‰ˆ
ğŸ‘‰ğŸ»[åº”ç”¨é«˜å¯ç”¨æœåŠ¡ AHAS](https://www.aliyun.com/search?scene=all&k=AHAS)ï¼Œä¸å¾—ä¸ä½©æœé˜¿é‡Œçš„å•†ä¸šæ¨¡å¼ï¼Œå¼€æºä¹Ÿä¸æ˜¯ç”¨çˆ±å‘ç”µã€‚

å¥½äº†å°±å•°å—¦åˆ°è¿™é‡Œå§ã€‚æˆ‘æ˜¯ MuMuï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ï¼Œæˆ‘ä»¬ä¸‹ç¯‡æ–‡ç« è§~