## å¾®æœåŠ¡ç»„ä»¶ - æ³¨å†Œä¸­å¿ƒ Nacos

### 1. ä»€ä¹ˆæ˜¯ Nacos

å®˜æ–¹ç®€ä»‹ï¼šğŸ‘‰ğŸ»[å®˜æ–¹æ–‡æ¡£](https://nacos.io/zh-cn/docs/what-is-nacos.html)

> Nacos è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacos æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚
>
> Nacos å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚ Nacos æ˜¯æ„å»ºä»¥â€œæœåŠ¡â€ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ (ä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼) çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚

ç®€è€Œè¨€ä¹‹ï¼ŒNacos å°±æ˜¯ä¸€ä¸ªé›†æˆäº†æ³¨å†Œä¸­å¿ƒã€é…ç½®ä¸­å¿ƒã€æœåŠ¡ç®¡ç†çš„å¹³å°ã€‚

Nocos çš„å…³é”®ç‰¹æ€§ï¼š

+ æœåŠ¡å‘ç°å’ŒæœåŠ¡å¥åº·ç›‘æµ‹
+ åŠ¨æ€é…ç½®æœåŠ¡
+ åŠ¨æ€ DNS æœåŠ¡
+ æœåŠ¡åŠå…¶ä¸å…ƒæ•°æ®ç®¡ç†

### 2. Nacos æ³¨å†Œä¸­å¿ƒ

*ç®¡ç†æ‰€æœ‰å¾®æœåŠ¡ã€è§£å†³å¾®æœåŠ¡ä¹‹é—´è°ƒç”¨å…³ç³»é”™ç»¼å¤æ‚ã€éš¾ä»¥ç»´æŠ¤çš„é—®é¢˜ã€‚*

1. æœåŠ¡å‘ç° - Nacos Discovery

> æœåŠ¡å‘ç°æ˜¯å¾®æœåŠ¡æ¶æ„ä½“ç³»ä¸­æœ€å…³é”®çš„ç»„ä»¶ä¹‹ä¸€ã€‚å¦‚æœå°è¯•ç€ç”¨æ‰‹åŠ¨çš„æ–¹å¼æ¥ç»™æ¯ä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆæ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ Nacos çš„å®¢æˆ·ç«¯ï¼‰æ¥é…ç½®æ‰€æœ‰æœåŠ¡æä¾›è€…çš„æœåŠ¡åˆ—è¡¨æ˜¯ä¸€ä»¶éå¸¸å›°éš¾çš„äº‹ï¼Œè€Œä¸”ä¹Ÿä¸åˆ©äºæœåŠ¡çš„åŠ¨æ€æ‰©ç¼©å®¹ã€‚Nacos Discovery Starter å¯ä»¥å¸®åŠ©æ‚¨å°†æœåŠ¡è‡ªåŠ¨æ³¨å†Œåˆ° Nacos æœåŠ¡ç«¯å¹¶ä¸”èƒ½å¤ŸåŠ¨æ€æ„ŸçŸ¥å’Œåˆ·æ–°æŸä¸ªæœåŠ¡å®ä¾‹çš„æœåŠ¡åˆ—è¡¨ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒNacos Discovery Starter ä¹Ÿå°†æœåŠ¡å®ä¾‹è‡ªèº«çš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ï¼Œä¾‹å¦‚ hostï¼Œportï¼Œå¥åº·æ£€æŸ¥URLï¼Œä¸»é¡µç­‰æ³¨å†Œåˆ° Nacos ã€‚

Nacos æ”¯æŒ CP/AP åˆ‡æ¢ï¼Œè¿™æ˜¯å…¶ä»–ä¸»æµçš„æ³¨å†Œä¸­å¿ƒæ‰€åšä¸åˆ°çš„ã€‚(
CAPç†è®ºğŸ‘‰ğŸ»[çœ‹è¿™é‡Œ](https://javaguide.cn/distributed-system/theorem&algorithm&protocol/cap&base-theorem.html#capç†è®º))

2. æ ¸å¿ƒç»“æ„
3. ä¸»è¦åŠŸèƒ½

+ æœåŠ¡æ³¨å†Œï¼šNacos Client ä¼šé€šè¿‡å‘é€ REST è¯·æ±‚çš„æ–¹å¼å‘ Nacos Server æ³¨å†Œè‡ªå·±çš„æœåŠ¡ï¼Œæä¾›è‡ªèº«çš„å…ƒæ•°æ®ï¼Œæ¯”å¦‚ ipåœ°å€ã€ç«¯å£ç­‰ä¿¡æ¯ã€‚Nacos Server
  æ¥æ”¶åˆ°æ³¨å†Œè¯·æ±‚åï¼Œå°±ä¼šæŠŠè¿™äº›å…ƒæ•°æ®ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŒå±‚çš„å†…å­˜ Map ä¸­ã€‚
+ æœåŠ¡å¿ƒè·³ï¼šåœ¨æœåŠ¡æ³¨å†Œåï¼ŒNacos Client ä¼šç»´æŠ¤ä¸€ä¸ªå®šæ—¶å¿ƒè·³æ¥æŒç»­é€š çŸ¥Nacos Serverï¼Œè¯´æ˜æœåŠ¡ä¸€ç›´å¤„äºå¯ç”¨çŠ¶æ€ï¼Œé˜²æ­¢è¢«å‰”é™¤ã€‚é»˜è®¤5så‘é€ä¸€æ¬¡å¿ƒè·³ã€‚
+ æœåŠ¡åŒæ­¥ï¼šNacos Server é›†ç¾¤ä¹‹é—´ä¼šäº’ç›¸åŒæ­¥æœåŠ¡å®ä¾‹ï¼Œç”¨æ¥ä¿è¯æœåŠ¡ä¿¡æ¯çš„ä¸€è‡´æ€§ã€‚
+ æœåŠ¡å‘ç°ï¼šæœåŠ¡æ¶ˆè´¹è€…(Nacos Client)åœ¨è°ƒç”¨æœåŠ¡æä¾›è€…çš„æœåŠ¡æ—¶ï¼Œä¼šå‘é€ä¸€ä¸ª REST è¯·æ±‚ç»™ Nacos Serverï¼Œè·å– Server ä¸Šçš„æ³¨å†ŒæœåŠ¡æ¸…å•ï¼Œå¹¶ä¸”ç¼“å­˜åœ¨ Nacos Client æœ¬åœ°ï¼ŒåŒæ—¶ä¼šåœ¨ Nacos
  Client æœ¬åœ°å¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡å®šæ—¶æ‹‰å–æœåŠ¡ç«¯æœ€æ–°çš„æ³¨å†Œè¡¨ä¿¡æ¯æ›´æ–°åˆ°æœ¬åœ°ç¼“å­˜ã€‚
+ æœåŠ¡å¥åº·æ£€æŸ¥ï¼šNacos Server ä¼šå¼€å¯ä¸€ä¸ªå®šæ—¶ä»»åŠ¡ç”¨æ¥æ£€æŸ¥æ³¨å†ŒæœåŠ¡å®ä¾‹çš„å¥åº·æƒ…å†µï¼Œå¯¹äºè¶…è¿‡15sæ²¡æœ‰æ”¶åˆ°å®¢æˆ·ç«¯å¿ƒè·³çš„å®ä¾‹ä¼šå°†å®ƒçš„ healthy å±æ€§ç½®ä¸º false (å®¢æˆ·ç«¯æœåŠ¡å‘ç°æ—¶ä¸ä¼šå‘ç°)
  ï¼Œå¦‚æœæŸä¸ªå®ä¾‹è¶…è¿‡30ç§’æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ï¼Œç›´æ¥å‰”é™¤è¯¥å®ä¾‹(è¢«å‰”é™¤çš„å®ä¾‹å¦‚æœæ¢å¤å‘é€å¿ƒè·³åˆ™ä¼šé‡æ–°æ³¨å†Œ)ã€‚

### 3. ä½¿ç”¨ Nacos

æ³¨æ„ï¼šå„ç»„ä»¶çš„ç‰ˆæœ¬ä¾èµ–å…³ç³»ğŸ‘‰ğŸ»[Spring Cloud Alibaba ç‰ˆæœ¬è¯´æ˜](https://github.com/alibaba/spring-cloud-alibaba/wiki/ç‰ˆæœ¬è¯´æ˜)

#### 1. éƒ¨ç½² Nacos Server æ³¨å†Œä¸­å¿ƒ

1. ä¸‹è½½ Nacos Server å®‰è£…åŒ…ğŸ‘‰ğŸ»[Releases Â· alibaba/nacos (github.com)](https://github.com/alibaba/nacos/releases)
2. å¯åŠ¨&å…³é—­ Nacos Server

**æ³¨ï¼šM1 èŠ¯ç‰‡ Mac éœ€è¦å®‰è£… Oracle JDK 8 æ‰èƒ½å¯åŠ¨ï¼Œä½¿ç”¨ ARM æ¶æ„çš„ JDK å¦‚ Zulu JDK ç­‰æ— æ³•å¯åŠ¨ã€‚**

+ è§£å‹ç¼©ï¼Œåœ¨ `bin` ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯è¾“å…¥ï¼š

```
# Mac & Linux
sh startup.sh -m standalone # å¯åŠ¨
sh shutdown.sh # å…³é—­

# Windows
startup.cmd -m standalone # å¯åŠ¨
cmd shutdown.cmd # å…³é—­
```

**å¦‚æœä¸åŠ å‚æ•°é»˜è®¤ä¼šä»¥é›†ç¾¤æ¨¡å¼å¯åŠ¨ï¼Œæ•…å¢åŠ å‚æ•°ä½¿å…¶ä»¥å•æœºæ¨¡å¼å¯åŠ¨ã€‚**

+ æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ä¿¡æ¯ï¼ˆMac ä¸ºä¾‹ï¼‰ğŸ‘‡ğŸ»ï¼š

![image-20220424132309955](https://blog.caowei.xyz/blog/202204241323347.png)

+ ä½¿ç”¨ cat æŸ¥çœ‹ `start.out` æ–‡ä»¶å†…å®¹ï¼š

â€‹    *è¾“å‡ºä»¥ä¸‹ä¿¡æ¯ä¸”æ— æŠ¥é”™åˆ™å¯åŠ¨æˆåŠŸã€‚*

![image-20220424132530662](https://blog.caowei.xyz/blog/202204241325335.png)

+ è®¿é—® Nacos Server åœ°å€ï¼š`http://localhost:8848/nacos` é»˜è®¤ç”¨æˆ·åå¯†ç å‡ä¸º nacos

![image-20220424132825412](https://blog.caowei.xyz/blog/202204241328098.png)

3. é…ç½®æ–‡ä»¶

é…ç½®æ–‡ä»¶è·¯å¾„ï¼š`/conf/application.properties`

éƒ¨åˆ†é…ç½®è¯´æ˜ï¼š

```
# Nacos è™šæ‹Ÿç›®å½•
server.servlet.contextPath=/nacos
# Nacos ç«¯å£
server.port=8848

# æ•°æ®æºé…ç½®ï¼ˆä»¥mysqlä¸ºä¾‹ï¼‰
spring.datasource.platform=mysql

# æ•°æ®åº“è¿æ¥å‚æ•°ï¼ˆé»˜è®¤ä¸å¯ç”¨ï¼‰
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user.0=nacos
db.password.0=nacos
```

æ³¨ï¼šé»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é…ç½®æ•°æ®æºçš„ï¼Œæ­¤æ—¶ Nacos ä¼šå°†æ•°æ®å­˜æ”¾åœ¨å†…å­˜ä¸­ï¼Œå•æœºè¿è¡Œæ¨èæ­¤æ–¹å¼ã€‚ä½¿ç”¨é›†ç¾¤æ–¹å¼è¿è¡Œ Nacos æ—¶ï¼Œå»ºè®®é…ç½®æ•°æ®æºä½¿ç”¨ã€‚

4. å¸¸è§é”™è¯¯

**é—®é¢˜ä¸€ï¼šå¯åŠ¨æŠ¥é”™ï¼š**`Failed to start database '/Users/mumu/Desktop/nacos/data/derby-data`

<img src="https://blog.caowei.xyz/blog/202204240101128.png" style="zoom: 50%;" />

è§£å†³æ–¹æ³•ï¼šå°†å¯¹åº”`derby-data`åˆ é™¤åé‡æ–°å¯åŠ¨ã€‚

#### 2. åœ¨å¾®æœåŠ¡ä¸­æ­å»º Nacos Client

1. æ·»åŠ ä¾èµ–

+ çˆ¶ pom ä¸­æ·»åŠ Spring Cloudã€Spring Cloud Alibaba

```xml

<dependencyManagement>
    <dependencies>
        <!--      Spring Cloud Alibaba ç‰ˆæœ¬ç®¡ç†      -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>${spring.cloud.alibaba.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>

        <!--      Spring Cloud ç‰ˆæœ¬ç®¡ç†      -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-dependencies</artifactId>
            <version>${spring.cloud.version}</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

+ å­ pom ä¸­å¼•å…¥ Nacos æœåŠ¡æ³¨å†Œå‘ç°ä¾èµ–ï¼ˆç‰ˆæœ¬å·åœ¨çˆ¶ pom ä¸­å·²æŒ‡å®šï¼Œä¸éœ€è¦å†æ·»åŠ ï¼‰

```xml
<!--nacos-æœåŠ¡æ³¨å†Œå‘ç°-->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

2. ä¿®æ”¹é…ç½®æ–‡ä»¶

```yml
server:
  port: 8030

spring:
  application:
    name: stock-service # æœåŠ¡å
  cloud:
    nacos:
      server-addr: 127.0.0.1:8848 # Nacos Server åœ°å€
      discovery:
        username: nacos # Nacos Server ç”¨æˆ·åå¯†ç 
        password: nacos
        namespace: public # å‘½åç©ºé—´ï¼šç”¨äºéš”ç¦»ä¸åŒçš„æœåŠ¡å®ä¾‹ï¼ˆå¦‚å¼€å‘ç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒï¼‰ï¼Œé»˜è®¤ä¸º public
        # group: åˆ†ç»„ï¼Œé»˜è®¤ä¸º DEFAULT_GROUP, æä¾›æ›´ç»†ç²’åº¦çš„ç›¸åŒç‰¹å¾æœåŠ¡çš„å½’ç±»åˆ†ç»„ç®¡ç†
        ephemeral: true # æ˜¯å¦ä¸ºä¸´æ—¶å®ä¾‹, é»˜è®¤ä¸ºtrueã€‚è®¾ä¸º false è¡¨ç¤ºä¸ºæ°¸ä¹…å®ä¾‹ï¼šå³ä½¿å®•æœºï¼Œä¹Ÿä¸ä¼šåˆ é™¤è¯¥å®ä¾‹
        # service: æœåŠ¡åï¼Œé»˜è®¤å–${spring.application.name}
        # weight: æƒé‡ï¼Œé€šå¸¸ç»“åˆè´Ÿè½½å‡è¡¡ç­–ç•¥ä½¿ç”¨ã€‚æƒé‡è¶Šå¤§ï¼Œåˆ†é…åˆ°çš„æµé‡è¶Šå¤§ã€‚
```

3. å¯åŠ¨æœåŠ¡

![image-20220424170033531](https://blog.caowei.xyz/blog/202204241700727.png)
åœ¨ Nacos Server ä¸Šå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæœåŠ¡å·²ç»æ³¨å†Œè¿›æ¥äº†ã€‚    ![image-20220424170228004](https://blog.caowei.xyz/blog/202204241702319.png)

4. ç®€å•çš„ä½¿ç”¨ Demo

+ é…ç½® RestTemplate

```java
@Bean
@LoadBalanced
public RestTemplate restTemplate(RestTemplateBuilder builder){
        RestTemplate restTemplate=builder.build();
        return restTemplate;
        }
```

+ æœåŠ¡é—´æ¥å£è°ƒç”¨

```java
//é…ç½®è´Ÿè½½å‡è¡¡å™¨å°†æœåŠ¡åè§£æä¸ºåœ°å€
@LoadBalanced
@Bean
public RestTemplate restTemplate(RestTemplateBuilder builder){
        RestTemplate restTemplate=builder.build();
        return restTemplate;
        }
```

```java
@GetMapping("/add")
public String add(){
        ...
        // æœªä½¿ç”¨ Nacos æ—¶ï¼Œé€šè¿‡ IP è°ƒç”¨
        String msg=restTemplate.getForObject("http://localhost:8011/stock/reduct",String.class);

        // ä½¿ç”¨ Nacos æ—¶ï¼Œé€šè¿‡æœåŠ¡åè°ƒç”¨
        String msg=restTemplate.getForObject("http://stock-service/stock/reduct",String.class);
        ...
        return msg;
        }
```

### 4. Nacos Server ç®¡ç†ç•Œé¢ä»‹ç»

+ åˆ†ç»„ï¼šä¸å‘½åç©ºé—´ç±»ä¼¼ï¼Œæ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„åˆ†ç»„
+ ä¿æŠ¤é˜ˆå€¼ï¼šè®¾ç½®0åˆ°1ä¹‹å‰çš„ä¸€ä¸ªå€¼ã€‚ä¸é›ªå´©ä¿æŠ¤æœºåˆ¶æœ‰å…³ï¼Œé»˜è®¤ä¸º0ï¼ˆä¸å¼€å¯é›ªå´©ä¿æŠ¤ï¼‰ã€‚å½“å¥åº·å®ä¾‹/æ€»ç¤ºä¾‹æ•°å°äºä¿æŠ¤é˜ˆå€¼æ—¶ï¼Œä¼šå¯ç”¨ä¸å¥åº·çš„ç¤ºä¾‹ï¼Œé˜²æ­¢æ´ªå³°æµé‡é€ æˆçš„æœåŠ¡é›ªå´©ã€‚ä¸€èˆ¬ä¸ä¼šå¯ç”¨ï¼Œè€Œä½¿ç”¨ Sentinel å®Œæˆé›ªå´©ä¿æŠ¤ã€‚
+ å…ƒæ•°æ®ï¼šè‡ªå®šä¹‰çš„é”®å€¼å¯¹ï¼Œå¾ˆå°‘ä½¿ç”¨ã€‚
+ ä¸´æ—¶å®ä¾‹ï¼šæœåŠ¡æŒ‚æ‰ä¸€ç‚¹æ—¶é—´åï¼Œä¼šå°†ä¸´æ—¶å®ä¾‹å‰”é™¤ï¼Œæ°¸ä¹…å®ä¾‹åˆ™ä¸ä¼šè¢«å‰”é™¤ã€‚åœ¨æœåŠ¡çš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ  `spring.cloud.nacos.discovery.ephemeral = false` å³å¯å°†å®ä¾‹è®¾ç½®ä¸ºä¸´æ—¶å®ä¾‹ã€‚
+ æƒé‡ï¼šé…åˆè´Ÿè½½å‡è¡¡æœºåˆ¶ï¼ˆå¦‚Ribbonï¼‰ä½¿ç”¨ã€‚è®¾ç½®çš„è¶Šå¤§ï¼Œåˆ™ä¸ºå¾®æœåŠ¡åˆ†é…çš„æµé‡è¶Šå¤§ã€‚

![image-20220425204254823](https://blog.caowei.xyz/blog/202204252042695.png)

### 5. éƒ¨ç½² Nacos Server é›†ç¾¤

å®˜æ–¹æ‰‹å†Œï¼šğŸ‘‰ğŸ»[Nacos é›†ç¾¤éƒ¨ç½²è¯´æ˜](https://nacos.io/zh-cn/docs/cluster-mode-quick-start.html)

1. ä¸‹è½½ Nacos Serverï¼ˆåŒå•æœºç‰ˆï¼‰
2. å°†å‹ç¼©åŒ…è§£å‹å¤šæ¬¡ï¼ˆä»¥ä¸‰ä¸ªèŠ‚ç‚¹ä¸ºä¾‹ï¼‰

<img src="https://blog.caowei.xyz/blog/202204262356639.png" alt="image-20220425225633144" style="zoom:50%;" />

3. ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨å¤–ç½®æ•°æ®æº

+ ä¿®æ”¹ `server.port` ç«¯å£å·

+ ä¿®æ”¹ conf ç›®å½•å†…çš„ `application.properties` é…ç½®æ–‡ä»¶ï¼Œå°† MySQL é…ç½®æ‰“å¼€ï¼Œä¿®æ”¹ MySQL çš„ç”¨æˆ·åå¯†ç ï¼š

```properties
#*************** Config Module Related Configurations ***************#
### If use MySQL as datasource:
spring.datasource.platform=mysql
### Count of DB:
db.num=1
### Connect URL of DB:
db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useUnicode=true&useSSL=false&serverTimezone=UTC
db.user.0=root
db.password.0=aaaa1234
```

4. ä¿®æ”¹é›†ç¾¤é…ç½®æ–‡ä»¶

å°† conf ç›®å½•ä¸‹çš„ `cluster.conf.example` æ”¹ä¸º `cluster.conf`ï¼Œæ·»åŠ èŠ‚ç‚¹çš„åœ°å€ä¸ç«¯å£å·:

```properties
#it is ip
#example
127.0.0.1:8850
127.0.0.1:8860
127.0.0.1:8870
```

**æ³¨æ„ï¼šä¼ªé›†ç¾¤ä½¿ç”¨ç›¸åŒ ip æ—¶ï¼Œä¸è¦å°†ç«¯å£è®¾ç½®ä¸º 8801,8802,8803 ç­‰è¿ç»­ç«¯å£**ã€‚å› ä¸ºåœ¨Nacos2.0ä»¥åï¼Œç›¸å¯¹äºä¹‹å‰çš„ç‰ˆæœ¬å¢åŠ äº† gRPC çš„é€šä¿¡æ–¹å¼ï¼Œç®€å•æ¥è¯´ 8801 ç«¯å£å ç”¨çš„åç§»é‡æ˜¯ 9801 ç«¯å£å’Œ 9802
ç«¯å£ã€8802 ç«¯å£å ç”¨çš„åç§»é‡æ˜¯ 9802 ç«¯å£å’Œ 9803 ç«¯å£ã€8803 ç«¯å£å ç”¨çš„åç§»é‡æ˜¯ 9803 ç«¯å£å’Œ 9804 ç«¯å£ï¼Œç«¯å£å†²çªäº†ã€‚

5. å¯¹ä¸‰ä¸ª Nacos æ–‡ä»¶å¤¹ä¸­çš„é…ç½®æ–‡ä»¶å‡æ‰§è¡Œä»¥ä¸Šä¿®æ”¹ï¼Œæ³¨æ„å®ƒä»¬çš„**ç«¯å£å·æ˜¯ä¸åŒçš„**ã€‚
6. åœ¨ MySQL ä¸­åˆ›å»º Nacos çš„æ•°æ®åº“

æ•°æ®åº“åä¸ºé…ç½®æ–‡ä»¶ä¸­é…ç½®çš„åç§°ï¼Œé»˜è®¤ä¸º `nacos`ã€‚

å»ºè¡¨ SQL æ–‡ä»¶ä¸º conf ç›®å½•ä¸‹çš„ `nacos-mysql.sql`ã€‚

7. è¿è¡Œ

+ å¯åŠ¨æŸä¸€ä¸ª Nacos èŠ‚ç‚¹ï¼Œbin ç›®å½•ä¸‹æ‰“å¼€ç»ˆç«¯ï¼Œè¾“å…¥ï¼š

```
sh startup.sh
```

+ è®¿é—® Nacos åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ä¸‰ä¸ªèŠ‚ç‚¹å·²ç»è¢«è¯†åˆ«åˆ°ï¼š

<img src="https://blog.caowei.xyz/blog/202204262356318.png" alt="image-20220426204829010" style="zoom:50%;" />

8. å…³é—­åŒå†™ï¼ˆä»… 2.0.x ç‰ˆæœ¬éœ€è¦ï¼Œ2.1 åŠä»¥ä¸Šç‰ˆæœ¬é»˜è®¤å…³é—­ï¼‰

> ç”±äº Nacos1.X å’Œ Nacos2.0 çš„æ•°æ®ç»“æ„å‘ç”Ÿäº†å˜åŒ–ï¼Œä¸ºäº†èƒ½å¤Ÿå®Œæˆå¹³æ»‘å‡é™çº§ï¼Œéœ€è¦å°†æ•°æ®è¿›è¡ŒåŒå†™ï¼Œåˆ†åˆ«ç”Ÿæˆ Nacos1 å’Œ Nacos2 çš„æ•°æ®ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚å› æ­¤ä¼šå¯¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ã€‚å½“é›†ç¾¤å‡çº§å¹¶ç¨³å®šè¿è¡Œåï¼Œå¯ä»¥å…³é—­åŒå†™ï¼Œå…³é—­åŒå†™åå°†ä¼šå¤±å»å¹³æ»‘é™çº§çš„åŠŸèƒ½ã€‚
>
> æ¥æºï¼šğŸ‘‰ğŸ»[Nacos 2.0 å‡çº§æ–‡æ¡£](https://nacos.io/zh-cn/docs/2.0.0-upgrading.html)

```shell
 curl -X PUT 'localhost:8850/nacos/v1/ns/operator/switchesentry=doubleWriteEnabled&value=false'
```

9. æ·»åŠ  Nginx

> OpenRestyæ˜¯ä¸€ä¸ªå…¨åŠŸèƒ½çš„ Web åº”ç”¨æœåŠ¡å™¨ã€‚å®ƒæ‰“åŒ…äº†æ ‡å‡†çš„ Nginx æ ¸å¿ƒï¼Œä»¥åŠå¾ˆå¤šçš„å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹æ¨¡å—ï¼Œä»¥åŠå®ƒä»¬çš„å¤§å¤šæ•°ä¾èµ–é¡¹ã€‚è€Œä¸”OpenRestyæä¾›äº†å¤§é‡ç»„ä»¶å¦‚ Mysqlã€Redisã€Memcached ç­‰ç­‰ï¼Œä½¿åœ¨ Nginx ä¸Šå¼€å‘ Web åº”ç”¨æ›´æ–¹ä¾¿æ›´ç®€å•ã€‚

+ å®‰è£… OpenResty å®‰è£…æ•™ç¨‹ï¼šğŸ‘‰ğŸ»[ç‚¹è¿™é‡Œ](https://openresty.org/cn/installation.html)
+ ç¼–è¾‘ Nginx é…ç½®æ–‡ä»¶ `nginx.conf`ï¼Œåœ¨ http å†…ï¼Œserver å¤–æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

![image-20220426205135033](https://blog.caowei.xyz/blog/202204262051964.png)

```properties
upstream nacoscluster {
server 127.0.0.1:8850;
server 127.0.0.1:8860;
server 127.0.0.1:8870;
}
server {
listen 8049;
server_name localhost;
location /nacos/ {
proxy_pass http://nacoscluster/nacos/;
}
}
```

+ å¯åŠ¨ Nginxã€‚

  è¿™æ ·åœ¨è®¿é—® 8049 ç«¯å£æ—¶ï¼ŒNginx ä¼šå°†è¯·æ±‚è½¬å‘åˆ°ä¸‰ä¸ªèŠ‚ç‚¹ä¹‹ä¸€ï¼Œä¿®æ”¹å¾®æœåŠ¡ä¸Šçš„ Nacos å®¢æˆ·ç«¯ç»Ÿä¸€é…ç½®è®¿é—® 8049 èŠ‚ç‚¹å³å¯ã€‚

![image-20220426205929921](https://blog.caowei.xyz/blog/202204262059425.png)