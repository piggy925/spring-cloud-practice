## é“¾è·¯è·Ÿè¸ª SkyWalking

### 1.ã€Œ SkyWalking æ˜¯ä»€ä¹ˆ ã€

SkyWalking æ˜¯ä¸€ä¸ªå›½äº§å¼€æºæ¡†æ¶ï¼Œ2015å¹´ç”±å´æ™Ÿå¼€æºï¼Œ2017å¹´åŠ å…¥Apacheå­µåŒ–å™¨ã€‚SkyWalking æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„åº”ç”¨ç¨‹åºæ€§èƒ½ç›‘è§†å·¥å…·ï¼Œä¸“ä¸ºå¾®æœåŠ¡ã€äº‘åŸç”Ÿæ¶æ„å’ŒåŸºäºå®¹å™¨(Dockerã€K8sã€Mesos)æ¶æ„è€Œè®¾è®¡ã€‚å®ƒæ˜¯ä¸€æ¬¾ä¼˜ç§€çš„ APM (Application Performance Management) å·¥å…·ï¼ŒåŒ…æ‹¬äº†åˆ†å¸ƒå¼è¿½è¸ªã€æ€§èƒ½æŒ‡æ ‡åˆ†æã€åº”ç”¨å’ŒæœåŠ¡ä¾èµ–åˆ†æç­‰ã€‚

å®˜æ–¹ç«™ç‚¹ï¼šğŸ‘‰ğŸ»[Apache SkyWalking](https://skywalking.apache.org/)

ä¸­æ–‡æ–‡æ¡£ï¼šğŸ‘‰ğŸ»[SkyWalking æ–‡æ¡£ä¸­æ–‡ç‰ˆï¼ˆç¤¾åŒºæä¾›ï¼‰](https://skyapm.github.io/document-cn-translation-of-skywalking/)

**é“¾è·¯è¿½è¸ªæ¡†æ¶å¯¹æ¯”ï¼š**

+ Zipkinï¼šTwitter å¼€æºçš„è°ƒç”¨é“¾åˆ†æå·¥å…·ï¼Œç›®å‰åŸºäº Spring Cloud Sleuth å¾—åˆ°äº†å¹¿æ³›çš„ä½¿ç”¨ï¼Œç‰¹ç‚¹æ˜¯è½»é‡ï¼Œä½¿ç”¨éƒ¨ç½²ç®€å•ã€‚

+ **SkyWalking**ï¼šæœ¬åœŸå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½è¾ƒå¼ºï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚ç›®å‰å·²åŠ å…¥ Apache å­µåŒ–å™¨ã€‚

+ CATï¼šå¤§ä¼—ç‚¹è¯„å¼€æºçš„åŸºäºç¼–ç å’Œé…ç½®çš„è°ƒç”¨é“¾åˆ†æï¼Œåº”ç”¨ç›‘æ§åˆ†æï¼Œæ—¥å¿—é‡‡é›†ï¼Œç›‘æ§æŠ¥è­¦ç­‰ä¸€ç³»åˆ—çš„ç›‘æ§å¹³å°å·¥å…·ã€‚
+ Pinpointï¼šéŸ©å›½äººå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUI åŠŸèƒ½å¼ºå¤§ï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚

**SkyWalking ä¸»è¦åŠŸèƒ½ç‰¹æ€§ï¼š**

+ å¤šç§ç›‘æ§æ‰‹æ®µï¼Œå¯ä»¥é€šè¿‡è¯­è¨€æ¢é’ˆå’Œ Service Mesh è·å¾—ç›‘æ§çš„æ•°æ®
+ æ”¯æŒå¤šç§è¯­è¨€è‡ªåŠ¨æ¢é’ˆï¼ŒåŒ…æ‹¬ Javaï¼Œ.NET Core å’Œ Node.JS
+ è½»é‡é«˜æ•ˆï¼Œæ— éœ€å¤§æ•°æ®å¹³å°å’Œå¤§é‡çš„æœåŠ¡å™¨èµ„æº
+ æ¨¡å—åŒ–ï¼ŒUIã€å­˜å‚¨ã€é›†ç¾¤ç®¡ç†éƒ½æœ‰å¤šç§æœºåˆ¶å¯é€‰
+ æ”¯æŒå‘Šè­¦
+ ä¼˜ç§€çš„å¯è§†åŒ–è§£å†³æ–¹æ¡ˆ

### 2.ã€Œ SkyWalking ç¯å¢ƒæ­å»ºéƒ¨ç½² ã€

**SkyWalking çš„é¡¹ç›®ç»“æ„**ï¼š

<img src="https://blog.caowei.xyz/blog/202205132324919.png" alt="image-20220513232447307" style="zoom:50%;" />

+ Skywalking Agentï¼ˆClient ç«¯ï¼‰ï¼šå’Œä¸šåŠ¡ç³»ç»Ÿç»‘å®šåœ¨ä¸€èµ·ï¼Œè´Ÿè´£æ”¶é›†å„ç§ç›‘æ§æ•°æ®

+ Skywalking oapserviceï¼ˆServer ç«¯ï¼‰ï¼šè´Ÿè´£å¤„ç†ç›‘æ§æ•°æ®ï¼Œæ¯”å¦‚æ¥æ”¶ Skywalking Agent çš„ç›‘æ§æ•°æ®ï¼Œå¹¶å­˜å‚¨åœ¨æ•°æ®åº“ä¸­; æ¥æ”¶ Skywalking webapp çš„å‰ç«¯è¯·æ±‚ï¼Œä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œå¹¶è¿”å›æ•°æ®ç»™å‰ç«¯ã€‚Skywalking oapserviceé€šå¸¸ä»¥é›†ç¾¤çš„å½¢å¼å­˜åœ¨ã€‚

+ Skywalking webappï¼ˆServer ç«¯ï¼‰ï¼šUI ç•Œé¢ï¼Œç”¨äºå±•ç¤ºæ•°æ®ã€‚ 
+ æ•°æ®åº“ï¼šç”¨äºå­˜å‚¨ç›‘æ§æ•°æ®çš„æ•°æ®åº“ï¼Œæ¯”å¦‚ Mysqlã€ElasticSearchç­‰ã€‚

#### 2.1 Server ç«¯éƒ¨ç½²ï¼ˆä»¥ v8.9.1 ç‰ˆæœ¬ä¸ºä¾‹ï¼‰

1. ä¸‹è½½åœ°å€ï¼šğŸ‘‰ğŸ»[Downloads | Apache SkyWalking](https://skywalking.apache.org/downloads/)

![image-20220513233620286](https://blog.caowei.xyz/blog/202205132336341.png)

ç›®å½•ç»“æ„ï¼š

![image-20220514115024552](https://blog.caowei.xyz/blog/202205141150646.png)

+ webapp: ç›‘æ§é¡µé¢çš„ jar åŒ…å’Œé…ç½®æ–‡ä»¶

+ oap-libsï¼šåå°åº”ç”¨çš„ jar åŒ…ï¼Œä»¥åŠå®ƒçš„ä¾èµ– jar åŒ…ï¼Œé‡Œè¾¹çš„ server-starter-*jar å°±æ˜¯å¯åŠ¨ç¨‹åºï¼›

+ configï¼šå¯åŠ¨åå°åº”ç”¨ç¨‹åºçš„é…ç½®æ–‡ä»¶ï¼Œæ˜¯ä½¿ç”¨çš„å„ç§é…ç½®

+ binï¼šå„ç§å¯åŠ¨è„šæœ¬ï¼Œä¸€èˆ¬ä½¿ç”¨è„šæœ¬ startup.* æ¥å¯åŠ¨ web é¡µé¢å’Œå¯¹åº”çš„åå°åº”ç”¨

2. åˆ‡æ¢åˆ° bin ç›®å½•ä¸­ï¼Œè¿è¡Œ startup.* å‘½ä»¤å¯åŠ¨ Server ç«¯

+ Windowsï¼šåŒå‡» startup.bat

+ Mac OS / Linuxï¼šè¿è¡Œ `sh startup.sh`

3. è®¿é—®

è®¿é—® UI ç•Œé¢çš„ç«¯å£å·å¯åœ¨ webapp/webapp.yml æ–‡ä»¶ä¸­ä¿®æ”¹

![image-20220514120216040](https://blog.caowei.xyz/blog/202205141202202.png)

#### 2.2 åœ¨å¾®æœåŠ¡ä¸­éƒ¨ç½² SkyWalkingï¼ˆClient ç«¯ï¼‰

1. ä¸‹è½½åœ°å€ï¼šğŸ‘‰ğŸ»[Downloads | Apache SkyWalking](https://skywalking.apache.org/downloads/#Agents)

ä»¥å½“å‰æœ€æ–°çš„ v8.10.0 ä¸ºä¾‹

![image-20220514121524615](https://blog.caowei.xyz/blog/202205141215807.png)

2. æ”¯æŒ Gateway 

æ³¨æ„ï¼šSkyWalking é»˜è®¤æ˜¯å¯¹ Gateway ä¸ç”Ÿæ•ˆçš„ï¼Œéœ€è¦æŠŠ optional-plugins ä¸­çš„ Gateway jar åŒ…é€‰æ‹©ä¸€ä¸ªå¤åˆ¶åˆ° plugins æ–‡ä»¶å¤¹ä¸­ï¼Œç„¶åé‡å¯ SkyWalking Server å³å¯ã€‚

![image-20220514130857540](https://blog.caowei.xyz/blog/202205141308748.png)

3. åœ¨ IDEA **æ¯ä¸ªå¾®æœåŠ¡**çš„ VM å‚æ•°ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®ï¼š

```shell
# skywalking-agent.jar åŒ…çš„è·¯å¾„
-javaagent:/Users/mumu/Desktop/skywalking-agent/skywalking-agent.jar
# SkyWalkingä¸Šæ˜¾ç¤ºçš„æœåŠ¡åç§°
-Dskywalking.agent.service_name=service-name
```

![image-20220514131308144](https://blog.caowei.xyz/blog/202205141313303.png)

4. å¯åŠ¨å¾®æœåŠ¡ï¼Œåœ¨ SkyWalking çš„ UI ä¸Šå³å¯çœ‹åˆ°æ¯ä¸ªå¾®æœåŠ¡çš„ç›¸å…³ä¿¡æ¯

![image-20220514132906592](https://blog.caowei.xyz/blog/202205141329852.png)

#### 2.3 SkyWalking æŒä¹…åŒ–è·Ÿè¸ªæ•°æ®

é»˜è®¤æƒ…å†µä¸‹ï¼ŒSkyWalking æ˜¯å°†æ•°æ®å­˜å‚¨åœ¨ H2 å†…å­˜æ•°æ®åº“ä¸­çš„ã€‚

å¯ä»¥åœ¨ SkyWalking Server æ–‡ä»¶å¤¹ä¸­ï¼Œä¿®æ”¹ config/application.yml ä¸­çš„ç›¸å…³è®¾ç½®ï¼Œä½¿ç”¨æ•°æ®åº“å­˜å‚¨ã€‚ä¸‹é¢ä»¥ MySQL ä¸ºä¾‹ã€‚

1. ä¿®æ”¹æŒ‡å®šçš„å­˜å‚¨æ–¹å¼

![image-20220514134148559](https://blog.caowei.xyz/blog/202205141341739.png)

2. ä¿®æ”¹æ•°æ®åº“ç›¸å…³é…ç½®ä¿¡æ¯ï¼Œå¹¶**æ‰‹åŠ¨åˆ›å»ºå¯¹åº”åç§°çš„æ•°æ®åº“**ï¼ˆä¸éœ€è¦å»ºè¡¨ï¼‰

![image-20220514134511097](https://blog.caowei.xyz/blog/202205141345185.png)

3. **æ·»åŠ  MySQL é©±åŠ¨ jar åŒ…**

åœ¨ SkyWalking Server æ‰€ä¾èµ–çš„ jar åŒ…ä¸­æ˜¯æ²¡æœ‰ MySQL é©±åŠ¨çš„ï¼ŒæŒ‡å®šä½¿ç”¨ MySQL åé‡å¯ SkyWalking Server åœ¨ æ—¥å¿—æ–‡ä»¶ä¸­ä¼šæ˜¾ç¤ºå¦‚ä¸‹é”™è¯¯ï¼š

![image-20220514135329020](https://blog.caowei.xyz/blog/202205141353219.png)

å°† MySQL é©±åŠ¨ jar åŒ…æ·»åŠ åˆ° oap-lib æ–‡ä»¶å¤¹ä¸­å³å¯ã€‚

![image-20220514135517534](https://blog.caowei.xyz/blog/202205141355639.png)

4. å¯åŠ¨ SkyWalking Serverï¼Œä¼šåœ¨æŒ‡å®šçš„æ•°æ®åº“ä¸­è‡ªåŠ¨åˆ›å»ºæ‰€éœ€çš„è¡¨

![image-20220514135841637](https://blog.caowei.xyz/blog/202205141358805.png)

5. ä¹‹å SkyWalking çš„æ•°æ®ä¾¿ä¼šæŒä¹…åŒ–åˆ° MySQL ä¸­ï¼Œå³ä½¿é‡å¯ SkyWalking Server ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

### 3.ã€Œ è‡ªå®šä¹‰é“¾è·¯è¿½è¸ª ã€

SkyWalking é»˜è®¤æ˜¯åªå¯¹é¡¹ç›®ä¸­çš„æ¥å£æ–¹æ³•ï¼ˆController å±‚ï¼‰ç”Ÿæ•ˆã€‚å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹é¡¹ç›®ä¸­çš„ä¸šåŠ¡æ–¹æ³•ï¼ˆService å±‚ï¼‰å®ç°é“¾è·¯è¿½è¸ªï¼Œæ–¹ä¾¿æˆ‘ä»¬æ’æŸ¥é—®é¢˜ï¼Œå¯ä»¥ä½¿ç”¨å¦‚ä¸‹é…ç½®ï¼š

1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-trace</artifactId>
    <version>8.10.0</version>
</dependency>
```

2. åœ¨éœ€è¦è·Ÿè¸ªçš„ä¸šåŠ¡æ–¹æ³•ä¸Šæ·»åŠ  `@Trace` æ³¨è§£

æˆ‘ä»¬è¿˜å¯ä»¥ä¸ºè¿½è¸ªé“¾è·¯å¢åŠ å…¶ä»–é¢å¤–çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è®°å½•å‚æ•°å’Œè¿”å›ä¿¡æ¯ã€‚

å®ç°æ–¹å¼:åœ¨æ–¹æ³•ä¸Šå¢åŠ  `@Tag` æˆ–è€… `@Tags`ã€‚ 

@Tag æ³¨è§£ä¸­ key = æ–¹æ³•åï¼Œvalue = returnedObjï¼ˆè¿”å›å€¼ï¼Œå›ºå®šåç§°ï¼‰/ arg[0]ï¼ˆå‚æ•°ï¼‰

```java
@Trace
@Tag(key = "create", value = "returnedObj")
public Order create(Order order) {
    ...
    return order;
}
    
@Trace 
@Tags({ @Tag(key="param",value="arg[0]"),
	    @Tag(key = "getById", value = "returnedObj") }) 
public User getById(Integer id){
	return userMapper.getById(id);
}
```

æ³¨æ„ï¼šè¿”å›çš„ POJO å¯¹è±¡éœ€è¦**é‡å†™ toString() æ–¹æ³•**ï¼Œå¦åˆ™ SkyWalking ä¸Šåªä¼šæ˜¾ç¤ºå…¶åœ°å€ä¿¡æ¯ã€‚

3. è®¿é—®æ¥å£ï¼Œå¯ä»¥çœ‹åˆ°ç›¸å…³ä¿¡æ¯å·²ç»è¢«è®°å½•æ˜¾ç¤º

![image-20220514151127528](https://blog.caowei.xyz/blog/202205141511868.png)

### 4.ã€Œ é…ç½® SkyWalking æ—¥å¿— ã€

1. æ·»åŠ ä¾èµ–

```xml
<dependency>
    <groupId>org.apache.skywalking</groupId>
    <artifactId>apm-toolkit-logback-1.x</artifactId>
    <version>8.10.0</version>
</dependency>
```

2. åˆ›å»º logback-spring.xmlï¼Œæ·»åŠ å¦‚ä¸‹é…ç½®

```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- å¼•å…¥ Spring Boot é»˜è®¤çš„ logback XML é…ç½®æ–‡ä»¶  -->
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>


    <appender name="console" class="ch.qos.logback.core.ConsoleAppender">
        <!-- æ—¥å¿—çš„æ ¼å¼åŒ– -->
        <encoder  class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout">
                <Pattern>-%clr(%d{${LOG_DATEFORMAT_PATTERN:-yyyy-MM-dd HH:mm:ss.SSS}}){faint} %clr(${LOG_LEVEL_PATTERN:-%5p}) %clr(${PID:- }){magenta} [%tid] %clr(---){faint} %clr([%15.15t]){faint} %clr(%-40.40logger{39}){cyan} %clr(:){faint} %m%n${LOG_EXCEPTION_CONVERSION_WORD:-%wEx}}</Pattern>
            </layout>
        </encoder>

    </appender>

    <appender name="grpc-log" class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.log.GRPCLogClientAppender">
        <encoder class="ch.qos.logback.core.encoder.LayoutWrappingEncoder">
            <layout class="org.apache.skywalking.apm.toolkit.log.logback.v1.x.mdc.TraceIdMDCPatternLogbackLayout">
                <Pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%X{tid}] [%thread] %-5level %logger{36} -%msg%n</Pattern>
            </layout>
        </encoder>
    </appender>

    <!-- è®¾ç½® Appender -->
    <root level="INFO">
        <appender-ref ref="console"/>
        <appender-ref ref="grpc-log"/>
    </root>

</configuration>
```

3. è®¿é—®æ¥å£ï¼Œå³å¯åœ¨ SkyWalking æ—¥å¿—ä¸­çœ‹è§ç›¸å…³ä¿¡æ¯

![image-20220514155157603](https://blog.caowei.xyz/blog/202205141551887.png)

å¦‚æœ SkyWalking æœåŠ¡ç«¯**æ²¡æœ‰éƒ¨ç½²åœ¨æœ¬åœ°**ï¼Œåˆ™éœ€è¦ä¿®æ”¹ SkyWalking Agent çš„ config/agent.config é…ç½®æ–‡ä»¶ã€‚æ·»åŠ ä»¥ä¸‹å†…å®¹ï¼š

```properties
# SkyWalking è¿œç¨‹æœåŠ¡ç«¯åœ°å€
plugin.toolkit.log.grpc.reporter.server_host=${SW_GRPC_LOG_SERVER_HOST:127.0.0.1}
# æŒ‡å®šè¦å‘å…¶æŠ¥å‘Šæ—¥å¿—æ•°æ®çš„ grpc æœåŠ¡å™¨çš„ç«¯å£
plugin.toolkit.log.grpc.reporter.server_port=${SW_GRPC_LOG_SERVER_PORT:11800}
# æŒ‡å®š grpc å®¢æˆ·ç«¯è¦æŠ¥å‘Šçš„æ—¥å¿—æ•°æ®çš„æœ€å¤§å¤§å°
plugin.toolkit.log.grpc.reporter.max_message_size=${SW_GRPC_LOG_MAX_MESSAGE_SIZE:10485760}
# å®¢æˆ·ç«¯å‘ä¸Šæ¸¸å‘é€æ•°æ®æ—¶å°†è¶…æ—¶å¤šé•¿æ—¶é—´ã€‚å•ä½æ˜¯ç§’
plugin.toolkit.log.grpc.reporter.upstream_timeout=${SW_GRPC_LOG_GRPC_UPSTREAM_TIMEOUT:30}
```

### 5.ã€Œ SkyWalking å‘Šè­¦ ã€

SkyWalking å‘Šè­¦åŠŸèƒ½æ˜¯åœ¨ 6.x ç‰ˆæœ¬æ–°å¢çš„ï¼Œå…¶æ ¸å¿ƒç”±ä¸€ç»„è§„åˆ™é©±åŠ¨ï¼Œè¿™äº›è§„åˆ™å®šä¹‰åœ¨ SkyWalking Server ä¸­çš„ config/alarm-settings.yml æ–‡ä»¶ä¸­ã€‚

å‘Šè­¦è§„åˆ™çš„å®šä¹‰åˆ†ä¸ºä¸¤éƒ¨åˆ†:

+ å‘Šè­¦è§„åˆ™ï¼šå®ƒä»¬å®šä¹‰äº†åº”è¯¥å¦‚ä½•è§¦å‘åº¦é‡è­¦æŠ¥ï¼Œåº”è¯¥è€ƒè™‘ä»€ä¹ˆæ¡ä»¶ã€‚
+ Webhookï¼šå®šä¹‰å½“è­¦å‘Šè§¦å‘æ—¶ï¼Œå“ªäº›æœåŠ¡ç»ˆç«¯éœ€è¦è¢«å‘ŠçŸ¥

åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œé¢„å®šä¹‰äº†ä¸€äº›å‘Šè­¦è§„åˆ™ï¼š

+ è¿‡å» 3 åˆ†é’Ÿå†…æœåŠ¡å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’
+ è¿‡å» 2 åˆ†é’ŸæœåŠ¡æˆåŠŸç‡ä½äº80%
+ è¿‡å» 3 åˆ†é’Ÿå†…æœåŠ¡å“åº”æ—¶é—´è¶…è¿‡ 1s çš„ç™¾åˆ†æ¯”
+ æœåŠ¡å®ä¾‹åœ¨è¿‡å» 2 åˆ†é’Ÿå†…å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 1sï¼Œå¹¶ä¸”å®ä¾‹åç§°ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
+ è¿‡å» 2 åˆ†é’Ÿå†…ç«¯ç‚¹å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’
+ è¿‡å» 2 åˆ†é’Ÿå†…æ•°æ®åº“è®¿é—®å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’
+ è¿‡å» 2 åˆ†é’Ÿå†…ç«¯ç‚¹å…³ç³»å¹³å‡å“åº”æ—¶é—´è¶…è¿‡ 1 ç§’

å‘Šè­¦è§„åˆ™é…ç½®é¡¹è¯´æ˜ï¼š

+ Rule nameï¼šè§„åˆ™åç§°ï¼Œä¹Ÿæ˜¯åœ¨å‘Šè­¦ä¿¡æ¯ä¸­æ˜¾ç¤ºçš„å”¯ä¸€åç§°ã€‚å¿…é¡»ä»¥ _rule ç»“å°¾ï¼Œå‰ç¼€å¯è‡ªå®šä¹‰

+ metrics-nameï¼šåº¦é‡åç§°ï¼Œå–å€¼ä¸º oal è„šæœ¬ä¸­çš„åº¦é‡åï¼Œç›®å‰åªæ”¯æŒ longã€double å’Œ int ç±»å‹

+ script-include-namesï¼šè¯¥è§„åˆ™ä½œç”¨äºå“ªäº›å®ä½“åç§°ï¼Œæ¯”å¦‚æœåŠ¡åï¼Œç»ˆç«¯å(å¯é€‰ï¼Œé»˜è®¤ä¸ºå…¨éƒ¨)

+ exclude-namesï¼šè¯¥è§„åˆ™ä½œä¸ç”¨äºå“ªäº›å®ä½“åç§°ï¼Œæ¯”å¦‚æœåŠ¡åï¼Œç»ˆç«¯å(å¯é€‰ï¼Œé»˜è®¤ä¸ºç©º)
+ thresholdï¼šé˜ˆå€¼

+ opï¼šæ“ä½œç¬¦ï¼Œç›®å‰æ”¯æŒ >ã€<ã€=

+ periodï¼šå¤šä¹…å‘Šè­¦è§„åˆ™éœ€è¦è¢«æ ¸å®ä¸€ä¸‹ã€‚è¿™æ˜¯ä¸€ä¸ªæ—¶é—´çª—å£ï¼Œä¸åç«¯éƒ¨ç½²ç¯å¢ƒæ—¶é—´ç›¸åŒ¹é…
+ countï¼šåœ¨ä¸€ä¸ª period çª—å£ä¸­ï¼Œå¦‚æœ values è¶…è¿‡ thresholdå€¼(æŒ‰op)ï¼Œè¾¾åˆ° count å€¼ï¼Œéœ€è¦å‘é€è­¦æŠ¥+
+ silence-periodï¼šåœ¨æ—¶é—´ TN ä¸­è§¦å‘æŠ¥è­¦åï¼Œåœ¨ TN -> TN + period è¿™ä¸ªé˜¶æ®µä¸å‘Šè­¦ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œå®ƒå’Œperiodä¸€æ ·ï¼Œè¿™æ„å‘³ç€ç›¸åŒçš„å‘Šè­¦(åœ¨åŒä¸€ä¸ª metrics-nameæ‹¥æœ‰ç›¸åŒçš„ Id)åœ¨åŒä¸€ä¸ª period å†…åªä¼šè§¦å‘ä¸€æ¬¡ 
+ messageï¼šå‘Šè­¦æ¶ˆæ¯

![image-20220514162656578](https://blog.caowei.xyz/blog/202205141626761.png)

Webhookï¼š

Webhook å¯ä»¥ç®€å•ç†è§£ä¸ºæ˜¯ä¸€ç§ Web å±‚é¢çš„å›è°ƒæœºåˆ¶ï¼Œé€šå¸¸ç”±ä¸€äº›äº‹ä»¶è§¦å‘ï¼Œä¸ä»£ç ä¸­çš„äº‹ä»¶å›è°ƒç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯ Webå±‚é¢çš„ã€‚ç”±äºæ˜¯Webå±‚é¢çš„ï¼Œæ‰€ä»¥å½“äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå›è°ƒçš„ä¸å†æ˜¯ä»£ç ä¸­çš„æ–¹æ³•æˆ–å‡½æ•°ï¼Œè€Œæ˜¯æœåŠ¡æ¥å£ã€‚ä¾‹å¦‚ï¼Œåœ¨å‘Šè­¦è¿™ä¸ªåœºæ™¯ï¼Œå‘Šè­¦å°±æ˜¯ä¸€ä¸ªäº‹ä»¶ã€‚å½“è¯¥äº‹ä»¶å‘ç”Ÿæ—¶ï¼ŒSkyWalking å°±ä¼šä¸»åŠ¨å»è°ƒç”¨ä¸€ä¸ªé…ç½®å¥½çš„æ¥å£ï¼Œè¯¥æ¥å£å°±æ˜¯æ‰€è°“çš„ Webhookã€‚

```yml
 webhooks:
	â€ http://127.0.0.1:9134/alarm/receive
```

åœ¨ Webhook ä¸­é…ç½®ä¸€ä¸ªæ¥å£ï¼Œå½“è§¦å‘å‘Šè­¦æ—¶ï¼Œä¼šè¯·æ±‚è¯¥æ¥å£ï¼Œè¯·æ±‚æ–¹æ³•ä¸º POSTï¼ŒContent-Type ä¸º application/jsonã€‚

å…¶ JSON æ•°æ®æ˜¯åŸºäº `org.apache.skywalking.oap.server.core.alarm.AlarmMessage` è¿›è¡Œåºåˆ—åŒ–çš„ã€‚ä¸åŒç‰ˆæœ¬çš„ Server è¿”å›çš„ JSON æ•°æ®å¯èƒ½ä¸åŒï¼Œå¯å‚è€ƒå®˜æ–¹æºç ï¼šğŸ‘‰ğŸ»[skywalking/AlarmMessage.java](https://github.com/apache/skywalking/blob/master/oap-server/server-core/src/main/java/org/apache/skywalking/oap/server/core/alarm/AlarmMessage.java)

AlarmMessage.java ç±»å†…å®¹å¦‚ä¸‹ï¼š

```java
@Setter
@Getter
public class AlarmMessage {
    private int scopeId;
    private String scope;
    private String name;
    private String id0;
    private String id1;
    private String ruleName;
    private String alarmMessage;
    private List<Tag> tags;
    private long startTime;
    private transient int period;
    private transient boolean onlyAsCondition;
}
```

åœ¨ Webhook æŒ‡å®šçš„æ¥å£ä¸­ï¼Œå®šä¹‰ä¸€ä¸ªç±»å»æ¥æ”¶ä¼ å…¥çš„ JSON æ•°æ®ï¼Œå†åšç›¸åº”çš„å¤„ç†ï¼Œå¦‚å‘é€é‚®ä»¶æé†’ã€å¾®ä¿¡æé†’ç­‰å³å¯ã€‚
