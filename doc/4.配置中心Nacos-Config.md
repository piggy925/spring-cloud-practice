## é…ç½®ä¸­å¿ƒ Nacos Config

### 1.ã€Œ ä»€ä¹ˆæ˜¯ Nacos Config ã€

> Nacos æä¾›ç”¨äºå­˜å‚¨é…ç½®å’Œå…¶ä»–å…ƒæ•°æ®çš„ key/value å­˜å‚¨ï¼Œä¸ºåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®æä¾›æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯æ”¯æŒã€‚ä½¿ç”¨ Spring Cloud Alibaba Nacos Configï¼Œæ‚¨å¯ä»¥åœ¨ Nacos Server
> é›†ä¸­ç®¡ç†ä½  Spring Cloud åº”ç”¨çš„å¤–éƒ¨å±æ€§é…ç½®ã€‚
>
> Spring Cloud Alibaba Nacos Config æ˜¯ Config Server å’Œ Client çš„æ›¿ä»£æ–¹æ¡ˆï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¸Šçš„æ¦‚å¿µä¸ Spring Environment å’Œ PropertySource
> æœ‰ç€ä¸€è‡´çš„æŠ½è±¡ï¼Œåœ¨ç‰¹æ®Šçš„ bootstrap é˜¶æ®µï¼Œé…ç½®è¢«åŠ è½½åˆ° Spring ç¯å¢ƒä¸­ã€‚å½“åº”ç”¨ç¨‹åºé€šè¿‡éƒ¨ç½²ç®¡é“ä»å¼€å‘åˆ°æµ‹è¯•å†åˆ°ç”Ÿäº§æ—¶ï¼Œæ‚¨å¯ä»¥ç®¡ç†è¿™äº›ç¯å¢ƒä¹‹é—´çš„é…ç½®ï¼Œå¹¶ç¡®ä¿åº”ç”¨ç¨‹åºå…·æœ‰è¿ç§»æ—¶éœ€è¦è¿è¡Œçš„æ‰€æœ‰å†…å®¹ã€‚
>
> ä»¥ä¸Šå†…å®¹æ¥è‡ª Nacos Config
> å®˜æ–¹æ–‡æ¡£ï¼šğŸ‘‰ğŸ»[Nacos config Â· alibaba](https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config)

### 2.ã€Œ ä½¿ç”¨ ã€

#### 1. åœ¨ Nacos Server ä¸Šæ·»åŠ é…ç½®

![image-20220429154714107](https://blog.caowei.xyz/blog/202204291547301.png)

![image-20220429164229374](https://blog.caowei.xyz/blog/202204291642499.png)

é…ç½®é¡¹è¯´æ˜ï¼š

+ Data IDï¼šå¯ä»¥ç†è§£ä¸ºé…ç½®æ–‡ä»¶åã€‚
+ Groupï¼šç±»ä¼¼å‘½åç©ºé—´ï¼Œä½†æ˜¯æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„åˆ’åˆ†ã€‚

#### 2. åœ¨å¾®æœåŠ¡ä¸­å¼•ç”¨é…ç½®æ–‡ä»¶

1. æ·»åŠ ä¾èµ–

```xml
<!--  nacos configé…ç½®ä¸­å¿ƒ  -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

2. åˆ›å»º bootstrap.ymlï¼Œåœ¨é‡Œé¢æŒ‡å®š Nacos Sercer çš„æœ‰å…³é…ç½®ä¿¡æ¯

```yml
spring:
  application:
    # ä¼šè‡ªåŠ¨æ ¹æ®æœåŠ¡åæ‹‰å»å¯¹åº” Data ID çš„é…ç½®æ–‡ä»¶
    # åå­—ä¸æœåŠ¡åç›¸åŒçš„é…ç½®æ–‡ä»¶ç§°ä¸ºé»˜è®¤é…ç½®æ–‡ä»¶
    name: order-service
  cloud:
    nacos:
      server-addr: 127.0.0.1:8850
      config:
        # æŒ‡å®šé…ç½®æ–‡ä»¶æ‰€åœ¨çš„å‘½åç©ºé—´ï¼Œé»˜è®¤ä¸º public
        namespace: public
        # æŒ‡å®šé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ groupï¼Œé»˜è®¤ä¸º DEFAULT_GROUP
        group: DEFAULT_GROUP
```

3. è·å–é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡æ¯

```java

@SpringBootApplication
public class OrderApplication {
    public static void main(String[] args) throws InterruptedException {
        ConfigurableApplicationContext applicationContext = SpringApplication.run(OrderApplication.class, args);
        while (true) {
            String name = applicationContext.getEnvironment().getProperty("user.name");
            String age = applicationContext.getEnvironment().getProperty("user.age");
            System.out.println("name: " + name);
            System.out.println("age: " + age);
            TimeUnit.SECONDS.sleep(1);
        }
    }
}
```

![image-20220429164503902](https://blog.caowei.xyz/blog/202204291645068.png)

æ³¨æ„ï¼šå½“é…ç½®æ–‡ä»¶åä¸æœåŠ¡åç›¸åŒæ—¶ï¼Œä¼šè‡ªåŠ¨å®Œæˆæ˜ å°„ï¼Œå¦åˆ™éœ€è¦é¢å¤–æŒ‡å®šæ–‡ä»¶åã€‚

#### 3. å…¶ä»–é…ç½®

1. Nacos å®¢æˆ·ç«¯é»˜è®¤ä½¿ç”¨ properties æ‰©å±•åï¼Œå¦‚æœé€‰æ‹©çš„æ˜¯å…¶ä»–æ ¼å¼ï¼ˆå¦‚ ymlï¼‰çš„é…ç½®æ–‡ä»¶ï¼Œéœ€è¦è¿›è¡Œé…ç½®ï¼š

![image-20220429165712006](https://blog.caowei.xyz/blog/202204291657932.png)

```yml
  cloud:
    nacos:
      server-addr: 127.0.0.1:8850
      config:
        # æŒ‡å®šé…ç½®æ–‡ä»¶æ ¼å¼
        file-extension: yml
```

2. å½“éœ€è¦è¯»å–çš„é…ç½®æ–‡ä»¶ä¸æœåŠ¡åä¸åŒæ—¶ï¼Œå¯é€šè¿‡ `shared-configs` æˆ– `extension-configs` é…ç½®é¡¹æŒ‡å®šï¼š

```yml
spring:
  application:
    # ä¼šè‡ªåŠ¨æ ¹æ®æœåŠ¡åæ‹‰å»å¯¹åº” Data ID çš„é…ç½®æ–‡ä»¶
    # åå­—ä¸æœåŠ¡åç›¸åŒçš„é…ç½®æ–‡ä»¶ç§°ä¸ºé»˜è®¤é…ç½®æ–‡ä»¶
    name: order-service
  cloud:
    nacos:
      server-addr: 127.0.0.1:8850
      config:
        shared-configs:
          # æŒ‡å®šé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ Data ID
          - data-id: com.mumu.common.yaml
            # æŒ‡å®šé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ groupï¼Œé»˜è®¤ä¸º DEFAULT_GROUP
            # group: DEFAULT_GROUP
            # å¼€å¯åŠ¨æ€æ„ŸçŸ¥
            refresh: true
        extension-configs[0]:
          - data-id: com.mumu.service.yaml
            refresh: true
```

**é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ï¼šé»˜è®¤ > extension-configsï¼ˆä¸‹æ ‡è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ > shared-configsï¼ˆä¸‹æ ‡è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼‰**

3. å¦‚æœåœ¨ Bean ä¸­é€šè¿‡`@Value`æ³¨è§£è·å–é…ç½®æ–‡ä»¶ä¸­çš„æ•°æ®ï¼Œéœ€è¦åœ¨ç±»ä¸Šæ·»åŠ `@RefreshScope`æ³¨è§£ï¼Œå¦åˆ™å½“å¤–éƒ¨é…ç½®æ–‡ä»¶æ›´æ”¹æ—¶ï¼Œæ— æ³•è·å–åˆ°æœ€æ–°çš„å€¼ã€‚

```java

@RestController
@RequestMapping("/stock")
@RefreshScope
public class StockController {
    @Value("${server.port}")
    String port;

	...
}
```