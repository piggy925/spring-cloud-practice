## å¾®æœåŠ¡ç»„ä»¶ - ç½‘å…³ Gateway

### 1.ã€Œ ä»€ä¹ˆæ˜¯ç½‘å…³ ã€

å¤§å®¶éƒ½éƒ½çŸ¥é“åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªç³»ç»Ÿä¼šè¢«æ‹†åˆ†ä¸ºå¾ˆå¤šä¸ªå¾®æœåŠ¡ï¼Œå¦‚æœæ²¡æœ‰ç½‘å…³çš„å­˜åœ¨ï¼Œæˆ‘ä»¬åªèƒ½åœ¨å®¢æˆ·ç«¯è®°å½•æ¯ä¸ªå¾®æœåŠ¡çš„åœ°å€ï¼Œç„¶ååˆ†åˆ«å»è°ƒç”¨ã€‚è¿™æ ·ä¼šå­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š

è¿™æ ·çš„æ¶æ„ï¼Œä¼šå­˜åœ¨ç€è¯¸å¤šçš„é—®é¢˜:

+ é‡å¤åŠ³åŠ¨ï¼šæ¯ä¸ªä¸šåŠ¡éƒ½ä¼šéœ€è¦å•ç‹¬å»é‰´æƒã€é™æµã€æƒé™æ ¡éªŒã€è·¨åŸŸç­‰é€»è¾‘ã€‚

+ éš¾ä»¥ç»´æŠ¤ï¼šéšç€ä¸šåŠ¡è¶Šæ¥è¶Šå¤æ‚ï¼Œæ¯”å¦‚æ·˜å®ã€äºšé©¬é€Šæ‰“å¼€ä¸€ä¸ªé¡µé¢å¯èƒ½ä¼šæ¶‰åŠåˆ°æ•°ç™¾ä¸ªå¾®æœåŠ¡ååŒå·¥ä½œï¼Œå¦‚æœæ¯ä¸€ä¸ªå¾®æœåŠ¡éƒ½åˆ†é…ä¸€ä¸ªåŸŸåçš„è¯ï¼Œä¸€æ–¹é¢å®¢æˆ·ç«¯ä»£ç ä¼šå¾ˆéš¾ç»´æŠ¤ï¼Œæ¶‰åŠåˆ°æ•°ç™¾ä¸ªåŸŸåï¼Œå¦ä¸€æ–¹é¢æ˜¯è¿æ¥æ•°çš„ç“¶é¢ˆï¼Œæƒ³è±¡ä¸€ä¸‹ä½ æ‰“å¼€ä¸€ä¸ª APPï¼Œé€šè¿‡æŠ“åŒ…å‘ç°æ¶‰åŠåˆ°äº†æ•°ç™¾ä¸ªè¿œç¨‹è°ƒç”¨ï¼Œè¿™åœ¨ç§»åŠ¨ç«¯ä¸‹ä¼šæ˜¾å¾—éå¸¸ä½æ•ˆã€‚

+ éš¾ä»¥é‡æ„ï¼šéšç€ä¸šåŠ¡å˜çš„è¶Šæ¥è¶Šå¤æ‚ï¼ŒåæœŸéœ€è¦è¿›è¡Œæ‹†åˆ†æˆå¤šä¸ªå¾®æœåŠ¡ï¼Œè¿™ä¸ªæ—¶å€™å¯¹å¤–æä¾›çš„æœåŠ¡ä¹Ÿéœ€è¦æ‹†åˆ†æˆå¤šä¸ªï¼ŒåŒæ—¶éœ€è¦å®¢æˆ·ç«¯é…åˆè¿›è¡Œæ”¹é€ ã€‚

ä¸Šé¢çš„è¿™äº›é—®é¢˜å¯ä»¥å€ŸåŠ© API ç½‘å…³æ¥è§£å†³ã€‚æ‰€è°“çš„ API ç½‘å…³ï¼Œå°±æ˜¯æŒ‡**ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£**ï¼Œå®ƒå°è£…äº†åº”ç”¨ç¨‹åºçš„å†…éƒ¨ç»“æ„ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›ç»Ÿä¸€æœåŠ¡ï¼Œä¸€äº›ä¸ä¸šåŠ¡æœ¬èº«åŠŸèƒ½æ— å…³çš„å…¬å…±é€»è¾‘ å¯ä»¥åœ¨è¿™é‡Œå®ç°ï¼Œè¯¸å¦‚è®¤è¯ã€é‰´æƒã€ç›‘æ§ã€è·¯ç”±è½¬å‘ç­‰ç­‰ã€‚

å¦‚æœè¯´ OpenFeign è§£å†³äº†å¾®æœåŠ¡ä¹‹é—´çš„è°ƒç”¨é—®é¢˜ï¼Œé‚£ä¹ˆ Gateway å°±æ˜¯æ¥è§£å†³**å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯**çš„è°ƒç”¨é—®é¢˜çš„ã€‚

ä¸‹é¢æ˜¯æ·»åŠ ä¸Š API ç½‘å…³ä¹‹åï¼Œç³»ç»Ÿçš„æ¶æ„å›¾çš„å¯¹æ¯”:

| ![image-20220507124836060](https://blog.caowei.xyz/blog/202205071248258.png) | ![image-20220507124936647](https://blog.caowei.xyz/blog/202205071249748.png) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |

### 2.ã€Œ ä»€ä¹ˆæ˜¯ Gateway ã€

ç½‘å…³ä½œä¸ºæµé‡çš„å…¥å£ï¼Œå¸¸ç”¨çš„åŠŸèƒ½åŒ…æ‹¬è·¯ç”±è½¬å‘ï¼Œæƒé™æ ¡éªŒï¼Œé™æµç­‰ã€‚

Spring Cloud Gateway æ˜¯ Spring Cloud å®˜æ–¹æ¨å‡ºçš„ç¬¬äºŒä»£ç½‘å…³æ¡†æ¶ï¼Œå®šä½äºå–ä»£ Netflix Zuul 1.0ã€‚ç›¸æ¯” Zuul æ¥è¯´ï¼Œèƒ½æä¾›æ›´ä¼˜ç§€çš„æ€§èƒ½ï¼Œæ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚

Spring Cloud Gateway æ˜¯ç”± WebFlux + Netty + Reactor å®ç°çš„å“åº”å¼çš„ API ç½‘å…³ã€‚å®ƒä¸èƒ½åœ¨ä¼ ç»Ÿ Servlet å®¹å™¨ä¸­å·¥ä½œï¼Œä¹Ÿä¸èƒ½æ„å»ºæˆ war åŒ…ã€‚

Spring Cloud Gateway æ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•ä¸”æœ‰æ•ˆçš„ API è·¯ç”±çš„ç®¡ç†æ–¹å¼ï¼Œå¹¶åŸºäº Filter çš„æ–¹å¼æä¾›ç½‘å…³çš„åŸºæœ¬åŠŸèƒ½ï¼Œä¾‹å¦‚ è¯´å®‰å…¨è®¤è¯ã€ç›‘æ§ã€é™æµç­‰ç­‰ã€‚

åŠŸèƒ½ç‰¹æ€§ï¼š

+ åŸºäºSpring Framework 5, Project Reactor å’Œ Spring Boot 2.0 è¿›è¡Œæ„å»º
+ åŠ¨æ€è·¯ç”±ï¼šèƒ½å¤ŸåŒ¹é…ä»»ä½•è¯·æ±‚å±æ€§
+ æ”¯æŒè·¯å¾„é‡å†™
+ é›†æˆ Spring Cloud æœåŠ¡å‘ç°åŠŸèƒ½ï¼ˆNacosã€Erukaï¼‰ï¼›å¯é›†æˆæµæ§é™çº§åŠŸèƒ½ï¼ˆSentinelã€Hystrixï¼‰ï¼›å¯ä»¥å¯¹è·¯ç”±æŒ‡å®šæ˜“äºç¼–å†™çš„ Predicateï¼ˆæ–­è¨€ï¼‰å’Œ Filterï¼ˆè¿‡æ»¤å™¨ï¼‰

æ ¸å¿ƒæ¦‚å¿µï¼š

+ è·¯ç”±ï¼ˆrouteï¼‰ï¼šè·¯ç”±æ˜¯ç½‘å…³ä¸­æœ€åŸºç¡€çš„éƒ¨åˆ†ï¼Œè·¯ç”±ä¿¡æ¯åŒ…æ‹¬ä¸€ä¸ªIDã€ä¸€ä¸ªç›®çš„URIã€ä¸€ç»„æ–­è¨€å·¥å‚ã€ä¸€ç»„Filterç»„æˆã€‚å¦‚æœæ–­è¨€ä¸ºçœŸï¼Œåˆ™è¯´æ˜è¯·æ±‚çš„URLå’Œé…ç½®çš„è·¯ç”±åŒ¹é…

+ æ–­è¨€ï¼ˆpredicatesï¼‰ï¼šæ–­è¨€å‡½æ•°å…è®¸å¼€å‘è€…å»å®šä¹‰åŒ¹é… Http Request ä¸­çš„ä»»ä½•ä¿¡æ¯ï¼Œæ¯”å¦‚è¯·æ±‚å¤´å’Œå‚æ•°ç­‰

+ è¿‡æ»¤å™¨ï¼ˆFilterï¼‰ï¼šFilter å¯ä»¥å¯¹è¯·æ±‚å’Œå“åº”è¿›è¡Œå¤„ç†

### 3.ã€Œ æ•´åˆ Nacos ä½¿ç”¨ ã€

1. æ·»åŠ ä¾èµ–

```xml
<!--    nacos æœåŠ¡å‘ç°    -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>

<!--    gateway ç½‘å…³    -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

2. æ·»åŠ  Gateway ç›¸å…³é…ç½®

```yml
server:
  port: 8088
spring:
  application:
    name: api-gateway
  cloud:
    # gatewayçš„é…ç½®
    gateway:
      # è·¯ç”±è§„åˆ™
      routes:
        - id: order_route  # è·¯ç”±çš„å”¯ä¸€æ ‡è¯†ï¼Œè·¯ç”±åˆ°order
          uri: lb://order-service  # éœ€è¦è½¬å‘çš„åœ°å€ï¼Œæ•´åˆ nacos ä½¿ç”¨æœåŠ¡åå³å¯ï¼Œlb: ä½¿ç”¨nacosä¸­çš„æœ¬åœ°è´Ÿè½½å‡è¡¡ç­–ç•¥
          #æ–­è¨€è§„åˆ™ ç”¨äºè·¯ç”±è§„åˆ™çš„åŒ¹é…
          predicates:
            - Path=/order-service/**
            # http://api-gateway/order-service/order/add è·¯ç”±åˆ°â†“
            # http://order-service/order-service/order/add
          filters:
            - StripPrefix=1  # è½¬å‘ä¹‹å‰å»æ‰ç¬¬ä¸€å±‚è·¯å¾„ï¼Œå¾—åˆ°æœ€ç»ˆè·¯å¾„
            # http://order-service/order/add

    nacos:
      server-addr: 127.0.0.1:8850
      discovery:
        username: nacos
        password: nacos
```

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€ç§ç®€å†™çš„æ–¹å¼ï¼šä½¿ç”¨æœåŠ¡åè®¿é—®æ—¶ï¼ŒNacos å¯ä»¥è‡ªåŠ¨è¯†åˆ«ï¼Œä¸éœ€è¦é¢å¤–é…ç½®ï¼ˆçº¦å®šå¤§äºé…ç½®ï¼‰ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œå»ºè®®ä½¿ç”¨ä¸Šé¢çš„æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥æ›´å¥½åœ°ä½¿ç”¨ Gateway çš„å„é¡¹åŠŸèƒ½ã€‚

```yml
server:
  port: 8088
spring:
  application:
    name: api-gateway
  cloud:
    # gatewayçš„é…ç½®
    gateway:
      discovery:
        locator:
          enabled: true  #æ˜¯å¦å¯åŠ¨è‡ªåŠ¨è¯†åˆ«nacosæœåŠ¡
    #é…ç½®Nacos
    nacos:
      discovery:
        server-addr: 127.0.0.1:8850
        username: nacos
        password: nacos
```

3. ä½¿ç”¨

è®¿é—® Gateway çš„ IP åœ°å€å³å¯ã€‚

![image-20220507144911637](https://blog.caowei.xyz/blog/202205071449907.png)

### 4.ã€Œ è·¯ç”±æ–­è¨€å·¥å‚ã€

*å½“è¯·æ±‚ Gateway çš„æ—¶å€™ï¼Œä½¿ç”¨æ–­è¨€å¯¹è¯·æ±‚è¿›è¡ŒåŒ¹é…ï¼Œå¦‚æœåŒ¹é…æˆåŠŸå°±è·¯ç”±è½¬å‘ï¼Œå¦‚æœåŒ¹é…å¤±è´¥å°±è¿”å› 404* 

å®˜æ–¹æ–‡æ¡£åœ°å€ï¼šğŸ‘‰ğŸ»[Spring Cloud Gateway Route Predicate Factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gateway-request-predicates-factories)

#### 4.1 Gatewayå†…ç½®çš„æ–­è¨€å·¥å‚ï¼š

+ åŸºäºDatetimeç±»å‹çš„æ–­è¨€å·¥å‚ï¼š

  + Afterï¼šæ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ™šäºæŒ‡å®šæ—¥æœŸ

  ```yml
  ...
  	predicates:
    	â€ After=2019â€12â€31T23:59:59.789+08:00[Asia/Shanghai]
  ```

  + Beforeï¼šæ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ—©äºæŒ‡å®šæ—¥æœŸ
  + Betweenï¼šæ¥æ”¶ä¸¤ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦åœ¨æŒ‡å®šæ—¶é—´æ®µå†…

+ åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸€ä¸ªIPåœ°å€æ®µï¼Œåˆ¤æ–­è¯·æ±‚ä¸»æœºåœ°å€æ˜¯å¦åœ¨åœ°å€æ®µä¸­

```yml
...
	predicates:
  	â€ RemoteAddr=192.168.1.1/24
```

+ åŸºäº Cookie çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼ŒCookie åå’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚åˆ¤æ–­è¯·æ±‚ Cookie æ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

```yml
...
	predicates:
  	â€ Cookie=chocolate,ch.
```

+ åŸºäº Header çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œæ ‡é¢˜åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚åˆ¤æ–­è¯·æ±‚Headeræ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

```yml
...
	predicates:
	â€ Header=Xâ€Requestâ€Id,\d+
```

+ åŸºäº Host çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä¸»æœºåæ¨¡å¼ã€‚åˆ¤æ–­è¯·æ±‚çš„Hostæ˜¯å¦æ»¡è¶³åŒ¹é…è§„åˆ™ã€‚

```yml
...
	predicates:
  	- Host=**.testhost.org
```

+ åŸºäº Method è¯·æ±‚æ–¹æ³•çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚ç±»å‹æ˜¯å¦è·ŸæŒ‡å®šçš„ç±»å‹åŒ¹é…ã€‚

```yml
...
	predicates:
  	â€ Method=GET
```

+ åŸºäº Path è¯·æ±‚è·¯å¾„çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚çš„URIéƒ¨åˆ†æ˜¯å¦æ»¡è¶³è·¯å¾„è§„åˆ™ã€‚

```yml
...
	predicates:
  	- Path=/foo/{segment}
```

+ åŸºäº Query è¯·æ±‚å‚æ•°çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¯·æ±‚ param å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚åˆ¤æ–­è¯·æ±‚å‚æ•°æ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

```yml
...
	predicates:
  	â€ Query=name,mumu
```

+ åŸºäºè·¯ç”±æƒé‡çš„æ–­è¨€å·¥å‚ï¼šæ¥æ”¶ä¸€ä¸ª[ç»„å,æƒé‡], ç„¶åå¯¹äºåŒä¸€ä¸ªç»„å†…çš„è·¯ç”±æŒ‰ç…§æƒé‡è½¬å‘

```yml
spring:
  cloud:
    gateway:
      routes:
      - id: weight_high
        uri: https://weighthigh.org
        predicates:
        - Weight=group1, 8
      - id: weight_low
        uri: https://weightlow.org
        predicates:
        - Weight=group1, 2
```

#### 4.2 è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚

è‡ªå®šä¹‰æ–­è¨€å·¥å‚ç±»çš„åˆ›å»ºæ¡ä»¶ï¼š

+ ç±»å¿…é¡»ä¸º Spring ç»„ä»¶ï¼ˆæ·»åŠ  Component æ³¨è§£ï¼‰
+ ç±»åå¿…é¡»ä»¥ RoutePredicateFactory ä½œä¸ºç»“å°¾ï¼ˆåº•å±‚é‡‡ç”¨åå°„æ‹¼æ¥ç±»åå®ç°ï¼Œçº¦å®šå¤§äºé…ç½®ï¼‰
+ å¿…é¡»ç»§æ‰¿ AbstractRoutePredicateFactory
+ å¿…é¡»åˆ›å»º**é™æ€å†…éƒ¨ç±»**ï¼Œå¹¶åœ¨å…¶å†…éƒ¨å£°æ˜å±æ€§æ¥æ¥æ”¶é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„æ–­è¨€ä¿¡æ¯
+ éœ€è¦ç»“åˆ shortcutFieldOrder è¿›è¡Œå±æ€§ç»‘å®š
+ é€šè¿‡é‡å†™ apply æ–¹æ³•è¿›è¡Œé€»è¾‘åˆ¤æ–­ï¼Œtrueå°±æ˜¯åŒ¹é…æˆåŠŸï¼ŒfalseåŒ¹é…å¤±è´¥

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼š

```java
@Component
public class CheckNameRoutePredicateFactory extends AbstractRoutePredicateFactory<CheckNameRoutePredicateFactory.Config> {
    public CheckNameRoutePredicateFactory() {
        super(CheckNameRoutePredicateFactory.Config.class);
    }

    // ç»“åˆ shortcutFieldOrder è¿›è¡Œå±æ€§ç»‘å®š
    public List<String> shortcutFieldOrder() {
        return Arrays.asList("name");
    }

    // é‡å†™ apply æ–¹æ³•è¿›è¡Œé€»è¾‘åˆ¤æ–­
    @Override
    public Predicate<ServerWebExchange> apply(CheckNameRoutePredicateFactory.Config config) {
        return new GatewayPredicate() {
            public boolean test(ServerWebExchange exchange) {
                if (config.getName().equals("mumu")) {
                    return true;
                }
                return false;
            }
        };
    }

    // åˆ›å»ºé™æ€å†…éƒ¨ç±»ï¼Œåœ¨å…¶å†…éƒ¨å£°æ˜å±æ€§æ¥æ¥æ”¶é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„æ–­è¨€ä¿¡æ¯
    @Validated
    public static class Config {
        private String name;
        
        public void setName(String name) {
            this.name = name;
        }

        public String getName() {
            return name;
        }
    }
}
```

å¯¹åº”çš„é…ç½®æ–‡ä»¶é…ç½®ï¼š

```yml
...
    predicates:
    	- CheckName=mumu
```

### 5.ã€Œ è¿‡æ»¤å™¨å·¥å‚ ã€

#### 5.1 Gatewayå†…ç½®çš„è¿‡æ»¤å™¨å·¥å‚ï¼ˆéƒ¨åˆ†ï¼‰

å®Œæ•´å·¥å‚åˆ—è¡¨å¯æˆ³å®˜æ–¹æ–‡æ¡£ï¼šğŸ‘‰ğŸ»[Spring Cloud Gateway Filter Factories](https://docs.spring.io/spring-cloud-gateway/docs/current/reference/html/#gatewayfilter-factories)

| è¿‡æ»¤å™¨å·¥å‚                  | ä½œç”¨                                      | å‚æ•°                                           |
| :-------------------------- | :---------------------------------------- | :--------------------------------------------- |
| AddRequestHeader            | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ Header                      | Headerçš„åç§°åŠå€¼                               |
| AddRequestParameter         | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ è¯·æ±‚å‚æ•°                    | å‚æ•°åç§°åŠå€¼                                   |
| AddResponseHeader           | ä¸ºåŸå§‹å“åº”æ·»åŠ Header                      | Headerçš„åç§°åŠå€¼                               |
| DedupeResponseHeader        | å‰”é™¤å“åº”å¤´ä¸­é‡å¤çš„å€¼                      | éœ€è¦å»é‡çš„Headeråç§°åŠå»é‡ç­–ç•¥                 |
| Hystrix                     | ä¸ºè·¯ç”±å¼•å…¥Hystrixçš„æ–­è·¯å™¨ä¿æŠ¤             | HystrixCommand çš„åç§°                          |
| FallbackHeaders             | ä¸ºfallbackUriçš„è¯·æ±‚å¤´ä¸­æ·»åŠ å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯ | Headerçš„åç§°                                   |
| PrefixPath                  | ä¸ºåŸå§‹è¯·æ±‚è·¯å¾„æ·»åŠ å‰ç¼€                    | å‰ç¼€è·¯å¾„                                       |
| RemoveHopByHopHeadersFilter | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤IETFç»„ç»‡è§„å®šçš„ä¸€ç³»åˆ—Header  | é»˜è®¤å°±ä¼šå¯ç”¨ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šä»…åˆ é™¤å“ªäº›Header |
| RemoveRequestHeader         | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤æŸä¸ªHeader                  | Headeråç§°                                     |
| RemoveResponseHeader        | ä¸ºåŸå§‹å“åº”åˆ é™¤æŸä¸ªHeader                  | Headeråç§°                                     |
| RewriteResponseHeader       | é‡å†™åŸå§‹å“åº”ä¸­çš„æŸä¸ªHeader                | Headeråç§°ï¼Œå€¼çš„æ­£ åˆ™è¡¨è¾¾å¼ï¼Œé‡å†™åçš„å€¼        |
| secureHeaders               | ä¸ºåŸå§‹å“åº”æ·»åŠ ä¸€ç³»åˆ—èµ·å®‰å…¨ä½œç”¨çš„å“åº”å¤´    | æ— ï¼Œæ”¯æŒä¿®æ”¹è¿™äº›å®‰å…¨å“åº”å¤´çš„å€¼                 |
| SetPath                     | ä¿®æ”¹åŸå§‹çš„è¯·æ±‚è·¯å¾„                        | ä¿®æ”¹åçš„è·¯å¾„                                   |
| SetResponseHeader           | ä¿®æ”¹åŸå§‹å“åº”ä¸­æŸä¸ªHeaderçš„å€¼              | Headeråç§°ï¼Œä¿®æ”¹åçš„å€¼                         |
| SetStatus                   | ä¿®æ”¹åŸå§‹å“åº”çš„çŠ¶æ€ç                       | HTTP çŠ¶æ€ç ï¼Œå¯ä»¥æ˜¯æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²        |
| StripPrefix                 | ç”¨äºæˆªæ–­åŸå§‹è¯·æ±‚çš„è·¯å¾„                    | ä½¿ç”¨æ•°å­—è¡¨ç¤ºè¦æˆªæ–­çš„è·¯å¾„çš„æ•°é‡                 |

#### 5.2 è‡ªå®šä¹‰å†…ç½®è¿‡æ»¤å™¨

è‡ªå®šä¹‰è¿‡æ»¤å™¨ç±»çš„åˆ›å»ºæ¡ä»¶ï¼š

+ ç±»å¿…é¡»ä¸º Spring ç»„ä»¶ï¼ˆæ·»åŠ  Component æ³¨è§£ï¼‰
+ ç±»åå¿…é¡»ä»¥ GatewayFilterFactory ä½œä¸ºç»“å°¾ï¼ˆåº•å±‚é‡‡ç”¨åå°„æ‹¼æ¥ç±»åå®ç°ï¼Œçº¦å®šå¤§äºé…ç½®ï¼‰
+ å¿…é¡»ç»§æ‰¿ AbstractNameValueGatewayFilterFactory
+ å¿…é¡»åˆ›å»º**é™æ€å†…éƒ¨ç±»**ï¼Œå¹¶åœ¨å…¶å†…éƒ¨å£°æ˜å±æ€§æ¥æ¥æ”¶é…ç½®æ–‡ä»¶ä¸­å¯¹åº”çš„æ–­è¨€ä¿¡æ¯
+ éœ€è¦ç»“åˆ shortcutFieldOrder è¿›è¡Œå±æ€§ç»‘å®š
+ é€šè¿‡é‡å†™ apply æ–¹æ³•è¿›è¡Œè¿‡æ»¤å¤„ç†

ä¸‹é¢æ˜¯ä¸€ä¸ªä¾‹å­ï¼ˆè¯·æ±‚ URL å¦‚æœæºå¸¦ name å‚æ•°ï¼Œå…¶å€¼å¿…é¡»ä¸º mumuï¼Œå¦åˆ™ä¼šè¿”å› 404ï¼‰ï¼š

```java
@Component
public class CheckNameGatewayFilterFactory extends AbstractGatewayFilterFactory<CheckNameGatewayFilterFactory.Config> {
    public CheckNameGatewayFilterFactory() {
        super(CheckNameGatewayFilterFactory.Config.class);
    }

    public List<String> shortcutFieldOrder() {
        return Arrays.asList("value");
    }

    @Override
    public GatewayFilter apply(CheckNameGatewayFilterFactory.Config config) {
        return new GatewayFilter() {
            @Override
            public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
                // è·å– name å‚æ•°
                String name = exchange.getRequest().getQueryParams().getFirst("name");
                if (StringUtils.isNotBlank(name)) {
                    // ç¬¦åˆæ¡ä»¶åˆ™æ‰§è¡Œè¿‡æ»¤
                    if (config.getValue().equals(name)) {
                        return chain.filter(exchange);
                    } else {
                        // ä¸ç¬¦åˆæ¡ä»¶åˆ™è¿”å› 404
                        exchange.getResponse().setStatusCode(HttpStatus.NOT_FOUND);
                        return exchange.getResponse().setComplete();
                    }
                }
                return chain.filter(exchange);
            }
        };
    }

    public static class Config {
        private String value;

        public String getValue() {
            return value;
        }

        public void setValue(String value) {
            this.value = value;
        }
    }
}
```

å¯¹åº”é…ç½®æ–‡ä»¶é…ç½®ï¼š

```yaml
...
	filters:
		- CheckName=mumu
```

å®é™…æ•ˆæœï¼š

![image-20220507205743247](https://blog.caowei.xyz/blog/202205072057318.png)

![image-20220507205707144](https://blog.caowei.xyz/blog/202205072057331.png)

#### 5.3 å…¨å±€è¿‡æ»¤å™¨

ä¸Šé¢æ‰€ä½¿ç”¨åˆ°çš„å†…ç½®è¿‡æ»¤å™¨åªèƒ½é’ˆå¯¹æŸä¸ªè·¯ç”±è¯·æ±‚èµ·ä½œç”¨ï¼Œå¦‚æœæƒ³å¯¹æ‰€æœ‰è·¯ç”±è¯·æ±‚èµ·ä½œç”¨å®ç°å¦‚æ—¥å¿—æ‰“å°ã€æƒé™æ ¡éªŒç­‰åŠŸèƒ½ï¼Œå°±éœ€è¦ä½¿ç”¨åˆ°å…¨å±€è¿‡æ»¤å™¨ã€‚å…¨å±€è¿‡æ»¤å™¨ä¸éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œé’ˆå¯¹æ‰€æœ‰è·¯ç”±ï¼Œä¸€æ—¦å®šä¹‰å°±ä¼šæŠ•å…¥ä½¿ç”¨ã€‚

##### è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

+ æ³¨å†Œä¸º Spring ç»„ä»¶
+ å®ç° GlobalFilter æ¥å£

ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨çš„ä¾‹å­ï¼ˆæ‰“å°è¯·æ±‚è·¯å¾„ï¼‰ï¼š

```java
@Component
public class LogFilter implements GlobalFilter {
    private static final Logger LOG = LoggerFactory.getLogger(LogFilter.class);

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
        LOG.info("==========> è¯·æ±‚è·¯å¾„ï¼š" + exchange.getRequest().getPath().value());
        return chain.filter(exchange);
    }
}
```

æ•ˆæœï¼š![image-20220507213320162](https://blog.caowei.xyz/blog/202205072133349.png)

æ­¤å¤–ï¼Œå¯ä»¥å¯ç”¨ Reactor Netty è®¿é—®æ—¥å¿—ï¼Œåœ¨JVM ç¯å¢ƒå˜é‡ä¸­æ·»åŠ ğŸ‘‡ğŸ»ï¼š

```shell
-Dreactor.netty.http.server.accessLogEnabled=true
```

![image-20220507214345677](https://blog.caowei.xyz/blog/202205072143852.png)

### 6.ã€Œ è·¨åŸŸå¤„ç† ã€

1. é€šè¿‡é…ç½®æ–‡ä»¶æ–¹å¼é…ç½®

```yaml
spring:
  cloud:
    gateway:
      globalcors:
        cors-configurations:
          '[/**]': # å…è®¸è·¨åŸŸè®¿é—®çš„èµ„æº
            allowedOrigins: "*" # å…è®¸çš„è·¨åŸŸæ¥æº
            allowedMethods:
              - GET
              - POST
```

2. é€šè¿‡ Java é…ç½®ç±»çš„æ–¹å¼

```java
@Configuration
public class CorsConfig {
    @Bean
    public CorsWebFilter corsFilter() {
        CorsConfiguration config = new CorsConfiguration();
        config.addAllowedMethod("*");   // å…è®¸çš„method
        config.addAllowedOrigin("*");   // å…è®¸çš„æ¥æº
        config.addAllowedHeader("*");   // å…è®¸çš„è¯·æ±‚å¤´å‚æ•°

        // è¿è¡Œè®¿é—®çš„èµ„æº
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource(new PathPatternParser());
        source.registerCorsConfiguration("/**", config);

        return new CorsWebFilter(source);
    }
}
```

![image-20220507220114596](https://blog.caowei.xyz/blog/202205072201885.png)

### 7.ã€Œ Gateway æ•´åˆ Sentinel ã€

*ç½‘å…³ä½œä¸ºå†…éƒ¨ç³»ç»Ÿå¤–çš„ä¸€å±‚å±éšœ, å¯¹å†…èµ·åˆ°ä¸€å®šçš„ä¿æŠ¤ä½œç”¨, é™æµä¾¿æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚ç½‘å…³å±‚çš„é™æµå¯ä»¥ç®€å•åœ°é’ˆå¯¹ä¸åŒè·¯ç”±è¿›è¡Œé™æµ, ä¹Ÿå¯é’ˆå¯¹ä¸šåŠ¡çš„æ¥å£è¿›è¡Œé™æµï¼Œæˆ–è€…æ ¹æ®æ¥å£çš„ç‰¹å¾åˆ†ç»„é™æµã€‚*

1. æ·»åŠ ä¾èµ–

```xml
<!--    sentinel æ•´åˆ gateway    -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-alibaba-sentinel-gateway</artifactId>
</dependency>

<!--    sentinel ä¾èµ–    -->
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>
```

2. æ·»åŠ  Sentinel é…ç½®

```properties
spring.cloud.sentinel.transport.dashboard=127.0.0.1:8090
```

3. æ‰“å¼€ Sentinel æ§åˆ¶å°ï¼Œè®¿é—®ä¸€ä¸ªæ¥å£å³å¯

![image-20220507225414684](https://blog.caowei.xyz/blog/202205072254042.png)

#### 7.1 æµæ§é…ç½®é¡¹è§£æ

1. é’ˆå¯¹è·¯ç”±è¿›è¡Œæµæ§

![image-20220508130154467](https://blog.caowei.xyz/blog/202205081301521.png)

+ å‚æ•°å±æ€§ï¼šç±»ä¼¼ä¹‹å‰çš„æ–­è¨€ã€‚é’ˆå¯¹æŒ‡å®šçš„å‚æ•°å±æ€§è¿›è¡Œæµæ§ã€‚
  + Client IPï¼šå®¢æˆ·ç«¯ IP
  + Remote Hostï¼šè¿œç¨‹åŸŸå
  + Headerï¼šè¯·æ±‚å¤´
  + URL å‚æ•°ï¼šè¯·æ±‚ URL ä¸­é™„å¸¦çš„å‚æ•°
  + Cookieï¼šCookie ä¸­åŒ…å«çš„å‚æ•°
+ åŒ¹é…æ¨¡å¼ï¼š
  + ç²¾ç¡®ï¼šç›¸ç­‰
  + å­ä¸²ï¼šéƒ¨åˆ†åŒ¹é…
  + æ­£åˆ™
+ é—´éš”ï¼šQPS é˜ˆå€¼çš„æ—¶é—´å•ä½
+ Burst Sizeï¼šé¢å¤–å…è®¸æ•°é‡ï¼Œé˜ˆå€¼çš„ä¸Šæµ®èŒƒå›´ã€‚

2. é’ˆå¯¹ API åˆ†ç»„

ä¸€ç§æ›´ç»†ç²’åº¦çš„æµæ§æ–¹å¼ï¼Œå¯ä»¥å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ¥å£æ·»åŠ åˆ°ä¸€ä¸ªåˆ†ç»„ï¼Œé’ˆå¯¹è¯¥åˆ†ç»„åˆ¶å®šæµæ§è§„åˆ™ã€‚

![image-20220508132329652](https://blog.caowei.xyz/blog/202205081323860.png)

é™çº§çš„é…ç½®é¡¹åœ¨ä¹‹å‰çš„ Sentinel æ–‡ç« ä¸­å·²æœ‰è¯¦ç»†è¯´æ˜ï¼Œæ²¡æœ‰å…¶ä»–ç‰¹åˆ«çš„åœ°æ–¹ï¼Œæ•…ä¸åœ¨æ­¤èµ˜è¿°äº†ã€‚

#### 7.2 è‡ªå®šä¹‰å¤„ç†æµæ§é™çº§å¼‚å¸¸

1. ä½¿ç”¨é…ç½®ç±»æ–¹å¼

```java
@Configuration
public class GatewayConfig {
    @PostConstruct
    public void init() {
        BlockRequestHandler blockRequestHandler = new BlockRequestHandler() {
            @Override
            public Mono<ServerResponse> handleRequest(ServerWebExchange serverWebExchange, Throwable throwable) {
                HashMap<String, String> map = new HashMap();
                map.put("code", HttpStatus.TOO_MANY_REQUESTS.toString());
                map.put("message", "é™æµå•¦ï¼");

                // è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†
                return ServerResponse.status(HttpStatus.OK)
                        .contentType(MediaType.APPLICATION_JSON)
                        .body(BodyInserters.fromValue(map));
            }
        };

        GatewayCallbackManager.setBlockHandler(blockRequestHandler);
    }
}
```

![image-20220508135234096](https://blog.caowei.xyz/blog/202205081352340.png)

å¯ä»¥é€šè¿‡åˆ¤æ–­å¼‚å¸¸ç±»å‹ï¼Œæ¥åˆ¤æ–­å¼‚å¸¸æ˜¯æ¥è‡ªæµæ§è¿˜æ˜¯é™çº§ã€‚

2. ä½¿ç”¨é…ç½®æ–‡ä»¶æ–¹å¼

```yml
spring:
  cloud:
    sentinel:
      scg:
        fallback:
          mode: response
          response-body: "{code: '998', message: 'é™æµäº† - æ¥è‡ªé…ç½®æ–‡ä»¶'}"
```

![image-20220508135838556](https://blog.caowei.xyz/blog/202205081358771.png)